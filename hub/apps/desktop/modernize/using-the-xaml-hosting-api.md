---
description: В этой статье описывается размещение пользовательского интерфейса XAML UWP в приложении Win32 C++ для настольных систем.
title: Использование API размещения XAML платформы UWP в приложении Win32 на C++
ms.date: 03/23/2020
ms.topic: article
keywords: Windows 10, UWP, Windows Forms, WPF, Win32, о-ва XAML
ms.author: mcleans
author: mcleanbyron
ms.localizationpriority: medium
ms.custom: 19H1
ms.openlocfilehash: 36c3aeb7a51c84e92c5bca461aee7efe50740237
ms.sourcegitcommit: c660def841abc742600fbcf6ed98e1f4f7beb8cc
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/24/2020
ms.locfileid: "80218464"
---
# <a name="using-the-uwp-xaml-hosting-api-in-a-c-win32-app"></a>Использование API размещения XAML платформы UWP в приложении Win32 на C++

Начиная с Windows 10, версия 1903, не относящаяся к UWP настольные приложения (включая C++ Win32, WPF и Windows Forms приложения) может использовать *API размещения UWP XAML* для размещения элементов управления UWP в любом элементе пользовательского интерфейса, связанном с дескриптором окна (HWND). Этот API позволяет приложениям, не относящимся к UWP, использовать новейшие функции пользовательского интерфейса Windows 10, которые доступны только через элементы управления UWP. Например, приложения, не являющиеся классом UWP, могут использовать этот API для размещения элементов управления UWP, использующих [систему разработки Fluent](/windows/uwp/design/fluent-design-system/index) и поддерживающих [Рукописный ввод Windows](/windows/uwp/design/input/pen-and-stylus-interactions).

API хостинга для UWP XAML предоставляет основу для более широкого набора элементов управления, предоставляемых разработчиками для того, чтобы разработчики получили доступ к классским приложениям, не относящимся к UWP. Эта функция называется *островами XAML*. Общие сведения об этой функции см. [в разделе Размещение элементов управления XAML UWP в классических приложениях (острова XAML)](xaml-islands.md).

> [!NOTE]
> Если вы хотите поделиться мнением об XAML Island, создайте запрос в [репозитории Microsoft.Toolkit.Win32](https://github.com/windows-toolkit/Microsoft.Toolkit.Win32/issues) и оставьте свои комментарии. Вы также можете отправить частное письмо по адресу XamlIslandsFeedback@microsoft.com. Ваши идеи и сценарии использования очень важны для нас.

## <a name="is-the-uwp-xaml-hosting-api-the-right-choice-for-your-desktop-app"></a>Является ли API размещения кода UWP XAML правильным выбором для классического приложения?

API хостинга UWP XAML предоставляет низкую инфраструктуру для размещения элементов управления UWP в классических приложениях. Некоторые типы классических приложений имеют возможность использовать альтернативные, более удобные API для выполнения этой задачи.

* Если у вас есть C++ классическое приложение Win32 и вы хотите разместить элементы управления UWP в своем приложении, необходимо использовать API хостинга для UWP XAML. Для таких типов приложений нет альтернативы.

* Для приложений WPF и Windows Forms мы настоятельно рекомендуем использовать [элементы управления .NET на языке XAML](xaml-islands.md#wpf-and-windows-forms-applications) в наборе средств сообщества Windows, а не напрямую использовать API размещения для класса UWP XAML. Эти элементы управления используют API размещения универсального кода класса UWP для внутреннего использования и реализуют все поведение, которое в противном случае необходимо для самостоятельной работы, если вы используете API размещения в формате UWP XAML напрямую, включая навигацию с помощью клавиатуры и изменение макета.

Так как мы рекомендуем использовать C++ только приложения Win32, использующие API размещения UWP XAML, в этой статье в первую очередь приводятся инструкции и примеры для C++ приложений Win32. Однако можно использовать API размещения UWP XAML в WPF и Windows Forms приложениях, если вы решили. В этой статье рассматривается соответствующий исходный код для [элементов управления ведущего приложения](xaml-islands.md#host-controls) для WPF и Windows Forms в наборе средств сообщества Windows, поэтому можно увидеть, как именно API размещения UWP XAML используются этими элементами управления.

## <a name="learn-how-to-use-the-xaml-hosting-api"></a>Узнайте, как использовать API размещения XAML

Чтобы выполнить пошаговые инструкции с примерами кода для использования API размещения XAML в C++ приложениях Win32, см. следующие статьи:

* [Размещение стандартного элемента управления UWP](host-standard-control-with-xaml-islands-cpp.md)
* [Размещение пользовательского элемента управления UWP](host-custom-control-with-xaml-islands-cpp.md)
* [Расширенные сценарии](advanced-scenarios-xaml-islands-cpp.md)

## <a name="samples"></a>Примеры

Способ использования API размещения класса UWP XAML в коде зависит от типа приложения, дизайна приложения и других факторов. Чтобы продемонстрировать, как использовать этот API в контексте полного приложения, в этой статье рассматривается код из следующих примеров.

### <a name="c-win32"></a>C++Платформа

В следующих примерах показано, как использовать API размещения UWP XAML в приложении C++ Win32:

* [Пример простой XAML](https://github.com/microsoft/Xaml-Islands-Samples/tree/master/Standalone_Samples/CppWinRT_Basic_Win32App). В этом примере демонстрируется Базовая реализация размещения элемента управления UWP в неупакованном приложении C++ Win32 (то есть приложение, которое не встроено в пакет MSIX).

* [Остров XAML с примером пользовательского элемента управления](https://github.com/microsoft/Xaml-Islands-Samples/tree/master/Samples/Win32). В этом примере демонстрируется полная реализация размещения пользовательского элемента управления UWP в упакованном приложении C++ Win32, а также обработка других поведений, таких как ввод с клавиатуры и Навигация по фокусу.

### <a name="wpf-and-windows-forms"></a>WPF и Windows Forms

Элемент управления [виндовсксамлхост](https://docs.microsoft.com/windows/communitytoolkit/controls/wpf-winforms/windowsxamlhost) в наборе Windows Community Toolkit служит эталонным примером использования API размещения UWP в приложениях WPF и Windows Forms. Исходный код доступен в следующих расположениях:

* Для версии элемента управления WPF [перейдите сюда](https://github.com/windows-toolkit/Microsoft.Toolkit.Win32/tree/master/Microsoft.Toolkit.Wpf.UI.XamlHost). Версия WPF является производной от [System. Windows. Interop. HwndHost](https://docs.microsoft.com/dotnet/api/system.windows.interop.hwndhost).

* Для Windows Forms версии элемента управления [перейдите сюда](https://github.com/windows-toolkit/Microsoft.Toolkit.Win32/tree/master/Microsoft.Toolkit.Forms.UI.XamlHost). Версия Windows Forms является производной от [System. Windows. Forms. Control](https://docs.microsoft.com/dotnet/api/system.windows.forms.control).

> [!NOTE]
> Мы настоятельно рекомендуем использовать [элементы управления .NET на языке XAML](xaml-islands.md#wpf-and-windows-forms-applications) в наборе средств сообщества Windows, а не использовать API размещения класса UWP XAML непосредственно в WPF и Windows Forms приложениях. Примеры ссылок WPF и Windows Forms в этой статье приведены только в демонстрационных целях.

## <a name="architecture-of-the-api"></a>Архитектура API

API размещения платформы UWP XAML включает следующие основные типы среда выполнения Windows и COM-интерфейсы.

|  Тип или интерфейс | Описание |
|--------------------|-------------|
| [WindowsXamlManager](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.windowsxamlmanager) | Этот класс представляет платформу XAML UWP. Этот класс предоставляет один статический метод [инитиализефоркуррентсреад](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.windowsxamlmanager.initializeforcurrentthread) , который инициализирует ПЛАТФОРМУ XAML UWP в текущем потоке в классическом приложении. |
| [DesktopWindowXamlSource](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.desktopwindowxamlsource) | Этот класс представляет экземпляр содержимого класса UWP XAML, которое размещается в вашем классическом приложении. Самым важным элементом этого класса является свойство [Content](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.desktopwindowxamlsource.content) . Это свойство назначается элементу управления [Windows. UI. XAML. UIElement](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement) , который требуется разместить. Этот класс также содержит другие члены для маршрутизации навигации фокуса клавиатуры в и из островов XAML. |
| идесктопвиндовксамлсаурценативе | Этот COM-интерфейс предоставляет метод **аттачтовиндов** , который используется для присоединения ОСТРОВИЧЕСКОГО кода XAML в приложении к родительскому ЭЛЕМЕНТУ пользовательского интерфейса. Каждый объект **десктопвиндовксамлсаурце** реализует этот интерфейс. Этот интерфейс объявлен в Windows. UI. XAML. Hosting. десктопвиндовксамлсаурце. h. |
| IDesktopWindowXamlSourceNative2 | Этот COM-интерфейс предоставляет метод **претранслатемессаже** , который позволяет ИНФРАСТРУКТУРЕ XAML UWP правильно обрабатывать определенные сообщения Windows. Каждый объект **десктопвиндовксамлсаурце** реализует этот интерфейс. Этот интерфейс объявлен в Windows. UI. XAML. Hosting. десктопвиндовксамлсаурце. h. |

На следующей схеме показана иерархия объектов в острове XAML, размещенном в классическом приложении.

* На базовом уровне находится элемент пользовательского интерфейса в приложении, в котором требуется разместить остров XAML. Этот элемент пользовательского интерфейса должен иметь дескриптор окна (HWND). Примеры элементов пользовательского интерфейса, в которых можно разместить остров XAML, включают [окно](https://docs.microsoft.com/windows/desktop/winmsg/about-windows) для C++ приложений Win32, [System. Windows. Interop. HwndHost](https://docs.microsoft.com/dotnet/api/system.windows.interop.hwndhost) для приложений WPF и [System. windows. Forms. Control](https://docs.microsoft.com/dotnet/api/system.windows.forms.control) для Windows Forms приложений.

* На следующем уровне находится объект **десктопвиндовксамлсаурце** . Этот объект предоставляет инфраструктуру для размещения острова XAML. Ваш код отвечает за создание этого объекта и его присоединение к родительскому элементу пользовательского интерфейса.

* При создании **десктопвиндовксамлсаурце**этот объект автоматически создает собственное дочернее окно для размещения элемента управления UWP. Это собственное дочернее окно в основном является абстрактным от кода, но при необходимости вы можете получить доступ к его дескриптору (HWND).

* Наконец, на верхнем уровне находится элемент управления UWP, который требуется разместить в классическом приложении. Это может быть любой объект UWP, производный от [Windows. UI. XAML. UIElement](https://docs.microsoft.com/uwp/api/windows.ui.xaml.uielement), включая любой элемент управления UWP, предоставляемый Windows SDK, а также настраиваемые пользовательские элементы управления.

![Архитектура Десктопвиндовксамлсаурце](images/xaml-islands/xaml-hosting-api-rev2.png)

> [!NOTE]
> При размещении объектов XAML Island в классическом приложении можно одновременно использовать несколько деревьев содержимого XAML, выполняющихся в одном и том же потоке. Для доступа к корневому элементу дерева содержимого XAML в XAML Island и получения связанных сведений о контексте, в котором он размещен, используйте класс [XamlRoot](https://docs.microsoft.com/uwp/api/windows.ui.xaml.xamlroot). API-интерфейсы [CoreWindow](https://docs.microsoft.com/uwp/api/windows.ui.core.corewindow), [аппликатионвиев](https://docs.microsoft.com/uwp/api/windows.ui.viewmanagement.applicationview)и [Window](https://docs.microsoft.com/uwp/api/windows.ui.xaml.window) не предоставляют правильную информацию о островах XAML. Дополнительные сведения см. [в этом разделе](xaml-islands.md#window-host-context-for-xaml-islands).

## <a name="troubleshooting"></a>Диагностика

### <a name="error-using-uwp-xaml-hosting-api-in-a-uwp-app"></a>Ошибка при использовании API размещения UWP XAML в приложении UWP

| Проблема | Разрешение |
|-------|------------|
| Приложение получает **COMException** со следующим сообщением: "не удается активировать десктопвиндовксамлсаурце. Этот тип нельзя использовать в приложении UWP. " или "не удается активировать Виндовсксамлманажер. Этот тип нельзя использовать в приложении UWP. " | Эта ошибка означает, что вы пытаетесь использовать API размещения UWP XAML (в частности, вы пытаетесь создать экземпляр типов [десктопвиндовксамлсаурце](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.desktopwindowxamlsource) или [виндовсксамлманажер](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.windowsxamlmanager) ) в приложении UWP. API размещения на языке UWP XAML предназначен только для использования в классических приложениях UWP, таких как WPF, Windows Forms и C++ приложения Win32. |

### <a name="error-trying-to-use-the-windowsxamlmanager-or-desktopwindowxamlsource-types"></a>Ошибка при попытке использовать типы Виндовсксамлманажер или Десктопвиндовксамлсаурце

| Проблема | Разрешение |
|-------|------------|
| Приложение получает исключение со следующим сообщением: "Виндовсксамлманажер и Десктопвиндовксамлсаурце поддерживаются для приложений, предназначенных для Windows версии 10.0.18226.0 и более поздних версий. Проверьте манифест приложения или манифест пакета и убедитесь, что свойство Макстестедверсион Обновлено. " | Эта ошибка означает, что приложение попыталось использовать типы **виндовсксамлманажер** или **десктопвиндовксамлсаурце** в API размещения UWP XAML, но операционная система не может определить, было ли приложение создано для Windows 10 версии 1903 или более поздней. API размещения на языке UWP XAML впервые появился в виде предварительной версии в более ранней версией Windows 10, но поддерживается только начиная с Windows 10, версия 1903.</p></p>Чтобы устранить эту проблему, создайте пакет MSIX для приложения и запустите его из пакета или установите пакет NuGet [Microsoft. Toolkit. Win32. UI. SDK](https://www.nuget.org/packages/Microsoft.Toolkit.Win32.UI.SDK) в проект.  |

### <a name="error-attaching-to-a-window-on-a-different-thread"></a>Ошибка при присоединении к окну в другом потоке

| Проблема | Разрешение |
|-------|------------|
| Приложение получает **COMException** со следующим сообщением: "сбой метода аттачтовиндов, так как указанный HWND был создан в другом потоке". | Эта ошибка означает, что приложение вызвало метод **идесктопвиндовксамлсаурценативе:: аттачтовиндов** и передало ему дескриптор HWND окна, созданного в другом потоке. Этот метод необходимо передать в HWND окна, созданного в том же потоке, что и код, из которого вызывается метод. |

### <a name="error-attaching-to-a-window-on-a-different-top-level-window"></a>Ошибка при присоединении к окну в другом окне верхнего уровня

| Проблема | Разрешение |
|-------|------------|
| Приложение получает **COMException** со следующим сообщением: "сбой метода аттачтовиндов, так как указанный HWND находится в порядке от другого окна верхнего уровня, чем HWND, который ранее был передан в аттачтовиндов в том же потоке". | Эта ошибка означает, что приложение вызвало метод **идесктопвиндовксамлсаурценативе:: аттачтовиндов** и передало ему HWND окна, которое отличается от окна верхнего уровня, чем окно, указанное в предыдущем вызове этого метода в том же потоке.</p></p>После того как приложение вызовет **аттачтовиндов** в определенном потоке, все остальные объекты [десктопвиндовксамлсаурце](https://docs.microsoft.com/uwp/api/windows.ui.xaml.hosting.desktopwindowxamlsource) в том же потоке могут присоединяться к Windows, которые являются потомками того же окна верхнего уровня, которое было передано при первом вызове **аттачтовиндов**. Когда все объекты **десктопвиндовксамлсаурце** закрываются для конкретного потока, следующий **десктопвиндовксамлсаурце** затем может быть снова подключен к любому окну.</p></p>Чтобы устранить эту проблему, закройте все объекты **десктопвиндовксамлсаурце** , привязанные к другим окнам верхнего уровня в этом потоке, или создайте новый поток для этого **десктопвиндовксамлсаурце**. |

## <a name="related-topics"></a>Связанные разделы

* [Размещение элементов управления XAML UWP в классических приложениях (острова XAML)](xaml-islands.md)
* [Размещение стандартного элемента управления UWP в приложении C++ Win32](host-standard-control-with-xaml-islands-cpp.md)
* [Размещение пользовательского элемента управления UWP в приложении C++ Win32](host-custom-control-with-xaml-islands-cpp.md)
* [Расширенные сценарии для островов XAML в C++ приложениях Win32](advanced-scenarios-xaml-islands-cpp.md)
* [Примеры кода островов XAML](https://github.com/microsoft/Xaml-Islands-Samples)
* [C++Пример XAML-островов Win32](https://github.com/microsoft/Xaml-Islands-Samples/tree/master/Samples/Win32/SampleCppApp)
