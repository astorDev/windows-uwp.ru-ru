---
ms.assetid: 9899F6A0-7EDD-4988-A76E-79D7C0C58126
title: Компоненты универсальной платформы Windows и оптимизация взаимодействия
description: Создавайте приложения на базе универсальной платформы Windows (UWP) с использованием компонент UWP и межпрограммного взаимодействия между собственными и управляемыми типами, избегая проблем производительности в связи с таким взаимодействием.
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: 37bcf2ff6eee6c272339fdc997ee7bbb046f85e9
ms.sourcegitcommit: d2517e522cacc5240f7dffd5bc1eaa278e3f7768
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2018
ms.locfileid: "8352198"
---
# <a name="uwp-components-and-optimizing-interop"></a>Компоненты и оптимизация взаимодействия UWP


Создавайте приложения на базе универсальной платформы Windows (UWP), которые используют компоненты UWP и межпрограммное взаимодействие между собственными и управляемыми типами, избегая проблем производительности в связи с таким взаимодействием.

## <a name="best-practices-for-interoperability-with-uwp-components"></a>Рекомендации по взаимодействию с компонентами UWP

Невнимательность при разработке приложения может привести к тому, что использование компонентов UWP существенно отразится на его производительности. В этом разделе описано, как добиться высокой производительности приложения, использующего компоненты UWP.

### <a name="introduction"></a>Введение

Взаимодействие во многом влияет на производительность приложения, при этом вы можете продолжать использовать приложение, даже не догадываясь об этом. Универсальная платформа Windows (UWP) обрабатывает взаимодействие со множеством компонентов, что позволяет повысить производительность и повторно использовать код, написанный на других языках. Мы рекомендуем воспользоваться преимуществами, предлагаемыми компонентами UWP, но при этом помнить, что это может сказаться на производительности. В этом разделе вы узнаете, как снизить влияние взаимодействия на производительность приложения.

Универсальная платформа Windows (UWP) снабжена библиотекой типов, доступ к которой осуществляется с помощью любого языка, который можно использовать для написания приложений UWP. Типы UWP на языке C# или Microsoft Visual Basic используются так же, как и объекты .NET. Для получения доступа к компонентам UWP нет необходимости использовать методы вызова платформы. Это упрощает написание приложений, но важно понимать, что может выполняться значительно больше операций взаимодействия, чем вы ожидаете. Если компоненты UWP написаны не на языке C# или Visual Basic, то при использовании этих компонентов границы взаимодействия будут нарушены. Нарушение границ взаимодействия может повлиять на производительность приложения.

При разработке приложения UWP на языке C# или Visual Basic наиболее часто используются два набора API: API UWP и API .NET для приложений UWP. Как правило, типы, определенные в UWP, находятся в пространствах имен, начинающихся с "Windows", а типы .NET находятся в пространствах имен, начинающихся с "System". Но есть и исключения. Типы .NET для приложений UWP не требуют взаимодействия при использовании. При снижении производительности в области, которая использует компоненты UWP, можно использовать вместо них API .NET для приложений UWP. Это позволит повысить производительность.

**Примечание**  большая часть компонентов UWP, которые поставляются с Windows10, реализованы в C++, поэтому границы взаимодействия при их использовании из C# или Visual Basic. Всегда проверяйте приложение, чтобы узнать, влияет использование компонентов UWP на его производительность или нет, прежде чем потратить средства на внесение изменений в код.

Термин "компоненты UWP" в контексте этого раздела означает компоненты, написанные на языке, отличном от C# или Visual Basic.

 

При каждом доступе к свойству или вызове метода в компоненте UWP возникают затраты, связанные со взаимодействием. На самом деле создание компонента UWP более затратно, чем создание объекта .NET. Причина в том, что универсальная платформа Windows (UWP) должна выполнить код, обеспечивающий переход с языка приложения на язык компонента. Кроме того, при передаче данных в компонент необходимо выполнить их преобразование между управляемыми и неуправляемыми типами.

### <a name="using-uwp-components-efficiently"></a>Эффективное использование компонентов UWP

Чтобы повысить производительность, вы должны обеспечить максимально эффективное использование компонентов UWP вашим кодом. В этом разделе даются некоторые рекомендации по повышению производительности при использовании компонентов UWP.

Чтобы воздействие на производительность стало заметно, требуется значительное количество вызовов, совершенных в короткий промежуток времени. Хорошо спроектированное приложение, инкапсулирующее вызовы в компоненты UWP из бизнес-логики и другого управляемого кода, не должно вызывать значительных издержек в связи со взаимодействием. Но если в ходе проверок выяснится, что использование компонентов UWP снижает производительность приложения, приведенные в этом разделе советы помогут вам повысить ее.

### <a name="consider-using-net-for-uwp-apps"></a>Использование .NET для приложений UWP

В ряде случаев задачу можно выполнить, используя для приложений UWP либо универсальную платформу Windows (UWP), либо .NET. Лучше не использовать вместе типы .NET и UWP. Старайтесь использовать либо те, либо другие. Например, можно проанализировать поток xml, используя тип [**Windows.Data.Xml.Dom.XmlDocument**](https://msdn.microsoft.com/library/windows/apps/BR206173) (тип UWP) или тип [**System.Xml.XmlReader**](https://msdn.microsoft.com/library/windows/apps/xaml/system.xml.xmlreader.aspx) (тип .NET). Используйте API той же самой технологии, что и поток. Например, для считывания xml из [**MemoryStream**](https://msdn.microsoft.com/library/windows/apps/xaml/system.io.memorystream.aspx) используйте тип **System.Xml.XmlReader**, так как оба типа являются типами .NET. При считывании из файла используйте тип **Windows.Data.Xml.Dom.XmlDocument**, так как API файла и **XmlDocument** являются компонентами UWP.

### <a name="copy-window-runtime-objects-to-net-types"></a>Копирование объектов среды выполнения Windows в типы .NET

Когда компонент UWP возвращает объект UWP, может быть полезно скопировать возвращенный объект в объект .NET. Это особенно важно при работе с коллекциями и потоками.

При вызове API UWP, возвращающего коллекцию, и последующем многократном сохранении такой коллекции и многократном доступе к ней может оказаться полезным скопировать эту коллекцию в коллекцию .NET, а затем использовать ее версию .NET.

### <a name="cache-the-results-of-calls-to-uwp-components-for-later-use"></a>Кэширование результатов вызовов в компоненты UWP для последующего использования

Улучшить производительность можно за счет сохранения значений в виде локальных переменных вместо многократных обращений к типу UWP. Особенно полезным это может оказаться при использовании значения внутри цикла. Проверьте приложение, чтобы убедиться, что использование локальных переменных повышает его производительность. Использование кэшированных значений может повысить быстродействие приложения, так как оно будет тратить меньше времени на взаимодействие.

### <a name="combine-calls-to-uwp-components"></a>Комбинирование вызовов с компонентами UWP

Постарайтесь обеспечить выполнение задач с как можно меньшим количеством вызовов объектов UWP. Например, лучше сразу считать большой объем данных из потока, чем считывать данные небольшими порциями.

Используйте такие API, которые объединят работу за минимально возможное количество вызовов, а не те, которые делают меньше работы, но требуют больше вызовов. Например, предпочтительнее создавать объект путем вызова конструкторов, которые инициализируют множественные свойства, а не вызова конструктора по умолчанию и назначения свойств по одному.

### <a name="building-a-uwp-components"></a>Создание компонентов UWP

При написании компонента UWP, который могут использовать приложения на языке C++ или JavaScript, убедитесь в том, что такой компонент обеспечивает хорошую производительность. Все рекомендации по достижению высокой производительности приложений применимы и для компонентов. Проверьте свой компонент, чтобы определить, какие API потребляют значительный объем трафика, и для таких областей предоставьте API, которые позволят пользователям выполнять работу с меньшим количеством вызовов.

## <a name="keep-your-app-fast-when-you-use-interop-in-managed-code"></a>Поддерживание максимальной производительности приложения при использовании межпрограммного взаимодействия в управляемом коде

Компоненты UWP упрощают взаимодействие между собственным и управляемым кодом, но если не проявить осторожности, они могут привести к издержкам производительности. В этом разделе вы узнаете, как достичь высокой производительности при использовании взаимодействия в управляемых приложениях UWP.

Компоненты UWP позволяют разработчикам создавать приложения, использующие XAML, на многих языках, так как версии API UWP доступны на всех языках. При создании приложения на C# или Visual Basic это удобство сказывается на межпрограммном взаимодействии, так как API UWP обычно реализованы в машинном коде, а любой вызов UWP из C# или Visual Basic требует перехода среды CLR от управляемого к машинному кадру стека и от параметров функции маршалинга к представлениям, доступным для машинного кода. Для большинства приложений эта нагрузка незначительна. Но если используется большое число вызовов (от сотен тысяч до миллионов) API UWP в критическом пути приложения, эти издержки становятся заметными. В общем случае вам нужно, чтобы время перехода между языками было невелико относительно времени выполнения остальной части кода. Это показано на следующей схеме.

![Переходы межпрограммного взаимодействия не должны занимать большую часть времени выполнения программы.](images/interop-transitions.png)

Приведенные в разделе [**.NET for Windows apps**](https://msdn.microsoft.com/library/windows/apps/xaml/br230232.aspx) типы не влияют на производительность при использовании в языках C# или Visual Basic. Исходя из практического опыта, можно предположить, что типы в пространствах имен, которые начинаются со слова "Windows.", являются типами UWP, а типы в пространствах имен, которые начинаются со слова "System.", — типами .NET. Следует учитывать, что даже простое использование типов UWP, например выделение или доступ к свойству, влечет за собой издержки взаимодействия.

Прежде чем оптимизировать эти издержки, выполните измерение своего приложения и определите, занимает ли межпрограммное взаимодействие большую часть времени выполнения приложения. Анализируя производительность своего приложения при помощи Visual Studio, вы можете легко определить верхнюю границу издержек межпрограммного взаимодействия, используя представление **Функции** и проверив инклюзивное время, затрачиваемое на методы, которые вызываются в UWP.

Если приложение работает медленно из-за издержек взаимодействия, можно повысить производительность за счет снижения количества вызовов API UWP в активно используемых ветвях кода. Например, игровой движок, выполняющий множество физических вычислений для постоянного запроса положения и размеров [**UIElements**](https://msdn.microsoft.com/library/windows/apps/BR208911), может сэкономить время за счет хранения требуемой информации из **UIElements** в локальных переменных, выполнения вычислений с этими кэшированными значениями и возвращения конечного результата в **UIElements**. Еще один пример: если доступ к коллекции трудно реализовать с помощью кода на языках C# или Visual Basic, то более эффективным будет использование коллекции из пространства имен [**System.Collections**](https://msdn.microsoft.com/library/windows/apps/xaml/system.collections.aspx), а не [**Windows.Foundation.Collections**](https://msdn.microsoft.com/library/windows/apps/BR206657). Можно также попробовать скомбинировать вызовы компонентов UWP— например, при помощи API [**Windows.Storage.BulkAccess**](https://msdn.microsoft.com/library/windows/apps/BR207676).

### <a name="building-a-uwp-component"></a>Создание компонента UWP

При написании компонента UWP для использования в приложениях на языках C++ или JavaScript убедитесь в том, что такой компонент обеспечивает хорошую производительность. Рабочая область API определяет границу межпрограммного взаимодействия и потребность пользователей в руководстве по этому разделу. Это особенно важно, если вы распространяете свои компоненты между другими сторонами.

Все рекомендации по достижению высокой производительности приложений применимы и для компонентов. Проверьте свой компонент, чтобы определить, какие API потребляют значительный объем трафика, и для таких областей предоставьте API, которые позволят пользователям выполнять работу с меньшим количеством вызовов. Разработчики универсальной платформы Windows (UWP) приложили немало усилий, чтобы приложения могли использовать ее без необходимости в частом нарушении границы межпрограммного взаимодействия.

 

