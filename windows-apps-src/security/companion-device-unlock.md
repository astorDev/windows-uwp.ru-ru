---
title: "Разблокировка Windows с устройствами-компаньонами (IoT)"
description: "Устройство-компаньон — это устройство, которое может функционировать вместе с настольным компьютером Windows 10, повышая эффективность и комфортность процедуры аутентификации пользователей. При работе с платформой сопутствующих устройств (Companion Device Framework) устройство-компаньон открывает широкие возможности использования паспорта Microsoft Passport, даже если возможность Windows Hello недоступна (например, на компьютере с Windows 10 отсутствует камера для аутентификации по лицу или устройство для считывания отпечатков пальцев)."
author: awkoren
ms.sourcegitcommit: a6265ca66a1a9d729465845da1014d1aff0e7d4d
ms.openlocfilehash: 18102d6277ff1c66ebd147b5c1fd2f2d6c91edd1

---
# Разблокировка Windows с устройствами-компаньонами (IoT)

Устройство-компаньон — это устройство, которое может функционировать вместе с настольным компьютером Windows 10, повышая эффективность и комфортность процедуры аутентификации пользователей. С помощью платформы сопутствующих устройств такие устройства могут расширять возможности Microsoft Passport, даже если служба Windows Hello недоступна (например, если на настольном компьютере с Windows 10 отсутствует камера для проверки подлинности путем распознавания лиц или сканер отпечатков пальцев).

> 
            **Примечание**. Платформа сопутствующих устройств — специализированная функция, доступная лишь некоторым разработчикам приложений. Чтобы использовать эту платформу, ваше приложение должно быть особым образом подготовлено к работе корпорацией Майкрософт и содержать ограниченную возможность *secondaryAuthenticationFactor* в своем манифесте. Чтобы получить утверждение, обратитесь по адресу [cdfonboard@microsoft.com](mailto:cdfonboard@microsoft.com).

## Введение

> Видеообзор см. в презентации [Разблокировка Windows с устройствами-компаньонами IoT](https://channel9.msdn.com/Events/Build/2016/P491), представленной на конференции Build 2016 на Канале 9.

### Варианты использования

Существует множество способов использования платформы сопутствующих устройств для обеспечения удобной разблокировки Windows с помощью сопутствующего устройства. Например, пользователи могут делать следующее:

- Подключить свое сопутствующее устройство к компьютеру через USB-порт, нажать кнопку на устройстве и автоматически разблокировать компьютер.
- Носить с собой телефон, уже связанный с компьютером через Bluetooth. После нажатия на клавишу "ПРОБЕЛ" на компьютере на телефон приходит уведомление. Подтвердить его, после чего компьютер разблокируется.
- Приложить сопутствующее устройство к NFC-сканеру, чтобы быстро разблокировать компьютер.
- Носить фитнес-браслет, владелец которого уже прошел проверку подлинности с его помощью. Когда пользователь подходит к компьютеру и выполняет особый жест (например, хлопок), компьютер разблокируется.

### Сопутствующие устройства с поддержкой биометрии

Если сопутствующее устройство поддерживает биометрию, в некоторых случаях [биометрическая платформа Windows](https://msdn.microsoft.com/library/windows/hardware/mt608302(v=vs.85).aspx) может быть более удобным решением, чем платформа сопутствующих устройств. Обратитесь по адресу [cdfonboard@microsoft.com](mailto:cdfonboard@microsoft.com), и мы поможем вам выбрать верный подход.

### Компоненты решения

На схеме ниже показаны компоненты решения и кто отвечает за их создание.

![обзор платформы](images/companion-device-1.png)

Платформа сопутствующих устройств реализована как служба под управлением Windows (в этой статье она называется службой проверки подлинности сопутствующих устройств). Эта служба отвечает за создание маркера разблокировки, который должен быть защищен ключом HMAC, хранящимся на сопутствующем устройстве. Это гарантия того, что для доступа к маркеру разблокировки требуется само сопутствующее устройство. Для каждого кортежа (компьютер, пользователь Windows) создается уникальный маркер разблокировки.

Для интеграции с платформой сопутствующих устройств нужно следующее:

- Приложение [универсальной платформы Windows (UWP)](https://msdn.microsoft.com/windows/uwp/get-started/universal-application-platform-guide) для сопутствующего устройства, скачанное из магазина приложений для Windows. 
- Возможность создать два 256-битных ключа HMAC на сопутствующем устройстве и сгенерировать код HMAC с его помощью (с использованием алгоритма SHA-256).
- Верно настроенные параметры безопасности на настольном компьютере с Windows 10. Этот ПИН-код потребуется службе проверки подлинности сопутствующих устройств, чтобы выполнить настройку, прежде чем к ней будет подключено сопутствующее устройство. Пользователям необходимо настроить ПИН-код в разделе "Параметры" > "Учетные записи" > "Вход".

Помимо указанных выше требований, сопутствующее устройство также отвечает за следующее:

- Взаимодействие с пользователем и фирменную символику начальной регистрации и последующей отмены регистрации сопутствующего устройства.
- Выполнение в фоновом режиме, обнаружение сопутствующего устройства, подключение к этому устройству и службе проверки подлинности сопутствующих устройств.
- Обработка ошибок

Обычно сопутствующие устройства поставляются с приложением для начальной настройки, например для первоначальной настройки фитнес-браслета. Описанные в этом документе функции могут присутствовать в таком приложении, и отдельное приложение не потребуется.  

### Сигналы пользователя

Каждое сопутствующее устройство должно быть объединено с приложением, поддерживающим три сигнала пользователя. Эти сигналы могут быть в форме действий или жестов.

- 
            **Сигнал намерения**: позволяет пользователю выражать свое намерение разблокировать компьютер, например путем нажатия на кнопку на сопутствующем устройстве. Сигнал намерения должен поступать от **сопутствующего устройства**.
- 
            **Сигнал присутствия пользователя**: подтверждает присутствие пользователя. Сопутствующее устройство может, например, потребовать ПИН-код, прежде чем его можно будет использовать для разблокировки компьютера (не путать с ПИН-кодом компьютера), или нажатие на кнопку.
- 
            **Сигнал уточнения**: уточняет, какой компьютер с Windows 10 пользователю требуется разблокировать, если на сопутствующем устройстве доступно несколько вариантов.

Любое число этих сигналов можно объединить в один. Сигналы присутствия пользователя и намерения должны быть обязательными при каждом использовании.

### Регистрация и дальнейшая связь между компьютером и сопутствующими устройствами

Перед подключением сопутствующего устройства к платформе сопутствующих устройств его необходимо зарегистрировать на этой платформе. Приложение сопутствующего устройства управляет всеми этапами процесса регистрации.

Зарегистрированная связь между сопутствующим устройством и настольным компьютером с Windows 10 может быть множественной (то есть одно сопутствующее устройство можно использовать для нескольких настольных компьютеров с Windows 10). Однако каждое сопутствующее устройство можно использовать только для одного пользователя на каждом настольном компьютере с Windows 10.   

Прежде чем сопутствующее устройство сможет обмениваться данными с компьютером, им необходимо определить общий способ транспортировки. Этот выбор остается за приложением сопутствующего устройства. Платформа сопутствующих устройств не накладывает каких-либо ограничений на способ транспортировки (USB, NFC, Wi-Fi, Bluetooth, BLE и т. д.) или протокол, используемый между сопутствующим устройством и его приложением на настольном компьютере с Windows 10. Однако она предоставляет некоторые рекомендации по безопасности на транспортном уровне, который описаны в разделе "Требования к безопасности" в этом документе. За предоставление этих требований несет ответственность поставщик устройства. Платформа не предоставляет их.


## Модель взаимодействия с пользователем

### Обнаружение, установка и первоначальная регистрация приложения сопутствующего устройства

Обычный рабочий процесс для пользователя выглядит следующим образом:

- Пользователь настраивает ПИН-код на каждом из целевых настольных компьютеров с Windows 10, которые требуется разблокировать с помощью сопутствующего устройства.
- Пользователь запускает приложение сопутствующего устройства на своем настольном компьютере с Windows 10, чтобы зарегистрировать на нем свое сопутствующее устройство.

Примечания.

- Мы рекомендуем оптимизировать и, если возможно, автоматизировать обнаружение, скачивание и запуск приложения сопутствующего устройства (например, приложение можно скачать, приложив сопутствующее устройство к NFC-сканеру на настольном компьютере с Windows 10). Однако за это отвечает сопутствующее устройство и его приложение.
- В корпоративной среде приложение сопутствующего устройства можно развернуть через систему MDM.
- Приложение сопутствующего устройства отвечает за отправку пользователю сообщений об ошибках в ходе регистрации.

### Протокол регистрации и ее отмены

На схеме ниже показано, как сопутствующее устройство взаимодействует со службой проверки подлинности сопутствующих устройств при регистрации.  

![процесс регистрации](images/companion-device-2.png)

В нашем протоколе используются два ключа:

- ключ устройства (**devicekey**) используется для защиты маркеров разблокировки, необходимых компьютеру для разблокировки Windows;
- ключ проверки подлинности (**authkey**) используется для взаимной проверки подлинности сопутствующего устройства и службы проверки подлинности сопутствующих устройств.

Сопутствующее устройство и его приложение обмениваются этими ключами при регистрации. В итоге сопутствующее устройство и его приложение должны использовать безопасный способ транспортировки для защиты ключей.

Также обратите внимание, что хотя на схеме выше показано создание двух ключей HMAC на сопутствующем устройстве, приложение также может создать их и отправить сопутствующему устройству для хранения.

### Начало процессов проверки подлинности

Пользователь может начать процесс входа на настольном компьютере с Windows 10 при помощи платформы сопутствующих устройств (то есть отправить сигнал намерения) двумя способами:

- открыть крышку ноутбука либо нажать клавишу "ПРОБЕЛ" или провести пальцем вверх на компьютере;
- выполнить жест или действие на сопутствующем устройстве.

Выбор одного из этих способов в качестве начальной точки остается за сопутствующим устройством. Платформа сопутствующих устройств сообщит приложению сопутствующего устройства, если произойдет первое событие. Чтобы узнать о захвате второго события, приложение сопутствующего устройства должно отправить запрос на сопутствующее устройство. Это позволяет сопутствующему устройству получать сигнал намерения до того, как произойдет разблокировка.

### Поставщик учетных данных сопутствующего устройства

В Windows 10 появился новый поставщик учетных данных, работающий со всеми сопутствующими устройствами.

Поставщик учетных данных сопутствующего устройства отвечает за запуск фоновой задачи сопутствующего устройства путем активации триггера. Первоначальная настройка триггера происходит при выходе компьютера из спящего режима и отображении экрана блокировки. Вторая настройка происходит, когда на компьютере открывается пользовательский интерфейс входа и выбирается плитка поставщика учетных данных сопутствующего устройства.

Вспомогательная библиотека приложения сопутствующего устройства будет ожидать изменения состояния экрана блокировки и отправит событие, соответствующее фоновой задаче сопутствующего устройства.

При выполнении нескольких фоновых задач сопутствующего устройства первая из этих задача, завершившая процесс проверки подлинности, разблокирует компьютер. Служба проверки подлинности с помощью сопутствующего устройства пропустит остальные вызовы проверки подлинности.

Приложение сопутствующего устройства владеет и управляет всеми этапами процесса на стороне сопутствующего устройства. Платформа сопутствующего устройства не управляет этой частью взаимодействия с пользователем. Точнее, поставщик проверки подлинности с помощью сопутствующего устройства сообщает приложению сопутствующего устройства (через фоновое приложение) об изменениях состояния пользовательского интерфейса входа (например, если экран блокировки отключен или пользователь отключил его, нажав на клавишу "ПРОБЕЛ"). Приложение сопутствующего устройства отвечает за формирование взаимодействия с пользователем на основе этих изменений (например, при нажатии на клавишу "ПРОБЕЛ" и отключении экрана блокировки начинается поиск устройства через USB).

Платформа сопутствующих устройств предоставит на выбор приложению сопутствующего устройства набор (локализованных) тестовых сообщений и сообщений об ошибках. Эти сообщения будут отображаться поверх экрана блокировки (или в пользовательском интерфейсе входа). Дополнительные сведения можно найти в разделе "Обработка сообщений и ошибок".

### Протокол проверки подлинности

После активации фоновой задачи, связанной с приложением сопутствующего устройства, она запрашивает у сопутствующего устройства расчет двух значений HMAC:
- код HMAC ключа устройства с кодом nonce;
- код HMAC ключа проверки подлинности с первым значением HMAC, объединенный с кодом nonce, сгенерированным службой проверки подлинности сопутствующих устройств.

Служба использует второе значение для проверки подлинности устройства и предотвращения атак с повторением на транспортном канале.

![процесс регистрации](images/companion-device-3.png)

## Управление жизненным циклом

### Единственная регистрация для повсеместного использования

Без внутреннего сервера пользователям потребуется отдельно зарегистрировать свое сопутствующее устройство на каждом настольном компьютере с Windows 10.

Поставщик или изготовитель оборудования сопутствующего устройства может реализовать веб-службу для перемещения состояния регистрации между настольными компьютерами или мобильными устройствами с Windows 10. Дополнительные сведения можно найти в разделе "Служба роуминга, отзыва и фильтрации".

### Управление ПИН-кодом

Перед использованием сопутствующего устройства необходимо настроить ПИН-код на настольном компьютере с Windows 10. Это гарантия того, что в случае отказа сопутствующего устройства у пользователя будет резервная копия. ПИН-код скрыт от приложений— им управляет Windows. Пользователь может изменить его в разделе "Параметры" > "Учетные записи" > "Вход".

### Управление и политика

Пользователи могут удалить сопутствующее устройство с настольного компьютера с Windows 10, запустив приложение сопутствующего устройства на этом компьютере.

У предприятий есть два способа управления платформой сопутствующих устройств:

- включение или отключение этой функции;
- определение списка разрешений сопутствующих устройств, которым разрешено использовать хранилище приложений для Windows.

Платформа сопутствующих устройств не предоставляет централизованного способа ведения учета доступных сопутствующих устройств или метода расширенной фильтрации разрешенных экземпляров сопутствующих устройств определенного типа (например, разрешено использование только сопутствующих устройств с серийным номером между X и Y). Однако разработчики приложений могут создать службу с поддержкой этих функций. Дополнительные сведения можно найти в разделе "Служба роуминга, отзыва и фильтрации".

### Отзыв

Платформа сопутствующих устройств не поддерживает удаление сопутствующего устройства с определенного настольного компьютера с Windows 10 в удаленном режиме. Вместо этого пользователи могут удалить сопутствующее устройство через приложение сопутствующего устройства на соответствующем настольном компьютере с Windows 10.

Однако поставщики сопутствующих устройств могут создать службу с поддержкой функции удаленного отзыва. Дополнительные сведения можно найти в разделе "Служба роуминга, отзыва и фильтрации".

### Службы роуминга и фильтрации

Поставщики сопутствующих устройств могут реализовать веб-службу для использования в следующих сценариях:

- Служба фильтрации для предприятия. Предприятие может ограничить набор сопутствующих устройств, которым разрешено работать в корпоративной среде, несколькими устройствами от определенного поставщика. Например, компания Contoso может заказать 10000 сопутствующих устройств модели Y от поставщика X и разрешить только этим устройствам работать на домене Contoso (запрет также распространяется на все остальные модели устройств от поставщика X).
- Данные инвентаризации. Предприятие может определить список существующих сопутствующих устройств, используемых в корпоративной среде.
- Отзыв в реальном времени. Если сотрудник сообщит об утере или краже своего сопутствующего устройства, это устройство можно отозвать с помощью веб-службы.
- Роуминг. Пользователю нужно лишь однажды пройти процедуру регистрации устройства, после чего оно будет работать со всеми настольными компьютерами и мобильными устройствами с Windows 10 этого пользователя.

Для реализации этих функций необходимо, чтобы приложение сопутствующего устройства должно сверяться с веб-службой при регистрации и использовании. Приложение сопутствующего устройства может выполнять оптимизацию для сценариев с использованием кэшированных данных о входе, например необходимость сверки с веб-службой только раз в день (при этом время отзыва может возрасти до одного дня).  

## Модель API платформы сопутствующих устройств

### Описание

Приложение сопутствующего устройства должно содержать два компонента: внешнее приложение с пользовательским интерфейсом для регистрации устройства и ее отмены, а также фоновую задачу для выполнения проверки подлинности.

Общий процесс API выглядит следующим образом:

1. Регистрация сопутствующего устройства
    * убедитесь, что устройство находится поблизости, отправьте запрос о его доступности (если необходимо);
    * создайте два ключа HMAC (на стороне сопутствующего устройства или его приложения);
    * вызовите RequestStartRegisteringDeviceAsync;
    * вызовите FinishRegisteringDeviceAsync;
    * убедитесь, что приложение сопутствующего устройства сохранило ключи HMAC (если такая функция поддерживается) и удалило их копии.
2. Регистрация фоновой задачи
3. Ожидание нужного события фоновой задачи
    * WaitingForUserConfirmation: ожидайте этого события, если для начала процесса проверки подлинности необходимо действие или жест пользователя на стороне сопутствующего устройства;
    * CollectingCredential: ожидайте этого события, если для начала процесса проверки подлинности сопутствующему устройству требуется действие или жест пользователя на компьютере (например, нажатие клавиши "ПРОБЕЛ");
    * другой триггер, например смарт-карта: отправьте запрос текущего состояния проверки подлинности для вызова нужных API.
4. Уведомление пользователя об ошибках или дальнейших действиях путем вызова ShowNotificationMessageAsync. Этот API следует вызывать только после получения сигнала о намерении
5. Разблокировка
    * убедитесь, что сигналы намерения и присутствия пользователя получены;
    * вызовите StartAuthenticationAsync;
    * свяжитесь с сопутствующим устройством, чтобы выполнить необходимые операции HMAC;
    * вызовите FinishAuthenticationAsync.
6. Отмена регистрации сопутствующего устройства по запросу пользователя (например, в случае утери сопутствующего устройства)
    * перечислите сопутствующее устройство для выполнившего вход пользователя с помощью FindAllRegisteredDeviceInfoAsync;
    * отмените его регистрацию с помощью UnregisterDeviceAsync.

### Регистрация и ее отмена

Для регистрации требуется выполнить два вызова API в адрес службы проверки подлинности сопутствующих устройств: RequestStartRegisteringDeviceAsync и FinishRegisteringDeviceAsync.

Перед совершением этих вызовов приложение сопутствующего устройства должно убедиться в доступности сопутствующего устройства. Если сопутствующее устройство отвечает за создание ключей HMAC (ключи устройства и проверки подлинности), его приложение должно также запросить у устройства их создание перед совершением любого из указанных выше вызовов. Если приложение сопутствующего устройства отвечает за создание ключей HMAC, оно должно создать их перед совершением указанных выше вызовов.

Кроме того, в рамках вызова первого API (RequestStartRegisteringDeviceAsync) приложение сопутствующего устройства должно определить возможности устройства (например, поддерживает ли оно безопасное хранилище для ключей HMAC) и подготовиться к его передаче в составе вызова API. Если одно и то же приложение сопутствующего устройства используется для управления несколькими версиями одного и того же сопутствующего устройства, а возможности устройства изменяются (и для их определения требуется отправка запроса устройству), мы рекомендуем отправить эти запросы до вызова первого API.   

Первый API (RequestStartRegisteringDeviceAsync) вернет дескриптор, используемый вторым API (FinishRegisteringDeviceAsync). Первый вызов для регистрации запустит запрос ПИН-кода, чтобы проверить присутствие пользователя. Если ПИН-код не настроен, вызов завершится с ошибкой. Приложение сопутствующего устройства может также отправить запрос на наличие ПИН-кода через KeyCredentialManager.IsSupportedAsync. Вызов RequestStartRegisteringDeviceAsync также может завершиться с ошибкой, если использование сопутствующих устройств отключено в рамках политики.

Результат первого вызова возвращается через перечисление SecondaryAuthenticationFactorRegistrationStatus:

```C#
{
    Failed = 0,         // Something went wrong in the underlying components
    Started,            // First call succeeded
    CanceledByUser,     // User cancelled PIN prompt
    PinSetupRequired,   // PIN is not set up
    DisabledByPolicy,   // Companion device framework or this app is disabled
}
```

Второй вызов (FinishRegisteringDeviceAsync) завершает регистрацию. В рамках процесса регистрации приложение сопутствующего устройства может хранить данные конфигурации сопутствующего устройства в службе проверки подлинности сопутствующих устройств. Размер этих данных не может превышать 4КБ. Эти данные будут доступны приложению сопутствующего устройства при проверке подлинности. Помимо прочего, их можно использовать для подключения к сопутствующему устройству, например по MAC-адресу. Также данные конфигурации можно использовать, если сопутствующее устройство лишено хранилища и ему требуется хранить данные на компьютере. Обратите внимание, что любые конфиденциальные данные, хранящиеся в составе данных конфигурации, должны быть зашифрованы с помощью ключа, известного только сопутствующему устройству. Также с учетом того, что данные конфигурации хранятся в службе Windows, они доступны приложению сопутствующего устройства во всех профилях пользователя.

Приложение сопутствующего устройства может вызвать AbortRegisteringDeviceAsync для отмены регистрации и передачи кода ошибки. Служба проверки подлинности сопутствующих устройств занесет ошибку в журнал данных телеметрии. Наглядным примером такого вызова может послужить ситуация, в которой на сопутствующем устройстве возникла неисправность, и оно не смогло завершить регистрацию (например, устройство не может сохранить ключи HMAC или потеряно подключение Bluetooth).

Приложение сопутствующего устройства должно предоставить пользователю возможность отмены регистрации сопутствующего устройства на настольном компьютере с Windows 10 (например, в случае утери сопутствующего устройства или покупки более новой версии). Если пользователь выбирает этот вариант, приложение сопутствующего устройства должно вызвать UnregisterDeviceAsync. Этот вызов от приложения сопутствующего устройства приведет к тому, что служба проверки подлинности сопутствующих устройств удалит все данные (включая ключи HMAC), связанные с определенным кодом устройства и идентификатором приложения, совершившего вызов, на стороне компьютера. Этот API не пытается удалить ключи HMAC на стороне сопутствующего устройства или его приложения. Их удаление выполняет приложение сопутствующего устройства.

Приложение сопутствующего устройства отвечает за отображение сообщений об ошибках в ходе регистрации и ее отмены.

```C#
using System;
using Windows.Security.Authentication.Identity.Provider;
using Windows.Storage.Streams;
using Windows.Security.Cryptography;
using Windows.UI.Popups;

namespace SecondaryAuthFactorSample
{
    public class DeviceRegistration
    {

        public void async OnRegisterButtonClick()
        {
            //
            // Pseudo function, the deviceId should be retrieved by the application from the device
            //
            string deviceId = await ReadSerialNumberFromDevice();

            IBuffer deviceKey = CryptographicBuffer.GenerateRandom(256/8);
            IBuffer mutualAuthenticationKey = CryptographicBuffer.GenerateRandom(256/8);

            SecondaryAuthenticationFactorRegistration registrationResult =
                await SecondaryAuthenticationFactorRegistration.RequestStartRegisteringDeviceAsync(
                    deviceId,  // deviceId: max 40 wide characters. For example, serial number of the device
                    SecondaryAuthenticaitonFactorDeviceCapabilities.SupportSecureStorage |
                        SecondaryAuthenticaitonFactorDeviceCapabilities.SupportSha2 |
                        SecondaryAuthenticaitonFactorDeviceCapabilities.StoreKeys,
                    "My test device 1", // deviceFriendlyName: max 64 wide characters. For example: John's card
                    "SAMPLE-001", // deviceModelNumber: max 32 wide characters. The app should read the model number from device.
                    deviceKey,
                    mutualAuthenticationKey);

            switch(registerResult.Status)
            {
            case SecondaryAuthenticationFactorRegistrationStatus.Started:
                //
                // Pseudo function:
                // The app needs to retrieve the value from device and set into opaqueBlob
                //
                IBuffer deviceConfigData = ReadConfigurationDataFromDevice();

                if (deviceConfigData != null)
                {
                    await registrationResult.Registration.FinishRegisteringDeviceAsync(deviceConfigData); //config data limited to 4096 bytes
                    MessageDialog dialog = new MessageDialog("The device is registered correctly.");
                    await dialog.ShowAsync();
                }
                else
                {
                    await registrationResult.Registration.AbortRegisteringDeviceAsync("Failed to connect to the device");
                    MessageDialog dialog = new MessageDialog("Failed to connect to the device.");
                    await dialog.ShowAsync();
                }
                break;

            case SecondaryAuthenticationFactorRegistrationStatus.CanceledByUser:
                MessageDialog dialog = new MessageDialog("You didn't enter your PIN.");
                await dialog.ShowAsync();
                break;

            case SecondaryAuthenticationFactorRegistrationStatus.PinSetupRequired:
                MessageDialog dialog = new MessageDialog("Please setup PIN in settings.");
                await dialog.ShowAsync();
                break;

            case SecondaryAuthenticationFactorRegistrationStatus.DisabledByPolicy:
                MessageDialog dialog = new MessageDialog("Your enterprise prevents using this device to sign in.");
                await dialog.ShowAsync();
                break;
            }
        }

        public void async UpdateDeviceList()
        {
            IReadOnlyList<SecondaryAuthenticationFactorInfo> deviceInfoList =
                await SecondaryAuthenticationFactorRegistration.FindAllRegisteredDeviceInfoAsync(
                    SecondaryAuthenticaitonFactorDeviceFindScope.User);

            if (deviceInfoList.Count > 0)
            {
                foreach (SecondaryAuthenticationFactorInfo deviceInfo in deviceInfoList)
                {
                    //
                    // Add deviceInfo.FriendlyName and deviceInfo.DeviceId into a combo box
                    //
                }
            }
        }

        public void async OnUnregisterButtonClick()
        {
            string deviceId;
            //
            // Read the deviceId from the selected item in the combo box
            //
            await SecondaryAuthenticationFactorRegistration.UnregisterDeviceAsync(deviceId);
        }
    }
}
```

### Проверка подлинности

Для проверки подлинности требуется совершить два вызова API в адрес службы проверки подлинности сопутствующих устройств: StartAuthenticationAsync и FinishAuthencationAsync.

Первый API инициирования возвращает дескриптор, используемый вторым API.  Помимо прочего, первый вызов возвращает код nonce, для которого (после объединения с другими элементами) необходимо создать код HMAC в соответствии с кодом устройства, хранящимся на сопутствующем устройстве. Второй вызов возвращает результаты создания HMAC на основе кода устройства и может привести к успешной проверке подлинности (то есть пользователь увидит свой рабочий стол).

Первый API инициирования (StartAuthenticationAsync) может завершиться с ошибкой, если после первоначальной регистрации это сопутствующее устройство было отключено политикой. Он также может завершиться с ошибкой, если вызов API был совершен за пределами состояний WaitingForUserConfirmation или CollectingCredential (об этом подробнее написано далее в этом разделе). К тому же исходу может привести совершение этого вызова через приложение незарегистрированного сопутствующего устройства. Перечисление SecondaryAuthenticationFactorAuthenticationStatus указывает все возможные результаты:

```C#
{
    Failed = 0,                     // Something went wrong in the underlying components
    Started,
    UnknownDevice,                  // Companion device app is not registered with framework
    DisabledByPolicy,               // Policy disabled this device after registration
    InvalidAuthenticationStage,     // Companion device framework is not currently accepting
                                    // incoming authentication requests
}
```

Вызов второго API (FinishAuthencationAsync) может завершиться с ошибкой, если срок действия кода nonce, предоставленного после первого вызова, истек (20 секунд). Перечисление SecondaryAuthenticationFactorFinishAuthenticationStatus указывает все возможные результаты:

```C#
{
    Failed = 0,     // Something went wrong in the underlying components
    Completed,      // Success
    NonceExpired,   // Nonce is expired
}
```

Время совершения этих двух вызовов API (StartAuthenticationAsync и FinishAuthencationAsync) должно соответствовать получению сопутствующим устройством сигналов намерения, присутствия пользователя и уточнения (дополнительные сведения можно найти в разделе "Сигналы пользователя". Например, второй вызов следует отправлять только после получения сигнала намерения. Другими словами, компьютер не должен разблокироваться, если пользователь не выразил соответствующего намерения. Чтобы прояснить ситуацию, предположим, что для разблокировки компьютера устройство должно находиться в радиусе действия подключения Bluetooth. В этом случае явный сигнал намерения должен отправляться иным образом, иначе компьютер разблокируется, если пользователь пройдет мимо него по пути на кухню. Кроме того, срок действия кода nonce, возвращенного после первого вызова, ограничен 20 секундами и истечет по прошествии этого времени. То есть первый вызов следует совершать, только если приложение сопутствующего устройства явно видит присутствие сопутствующего устройства, например когда это устройство подключено к USB-порту или приложено к NFC-сканеру. При использовании Bluetooth необходимо проявлять осторожность, чтобы не разрядить аккумулятор компьютера и не помешать другим процессам, использующим Bluetooth, в момент проверки присутствия сопутствующего устройства. Кроме того, если необходимо отправить сигнал присутствия пользователя (например, путем ввода ПИН-кода), рекомендуется совершать первый вызов только после получения сигнала.

Платформа сопутствующих устройств помогает приложению сопутствующего устройства принять обоснованное решение о времени совершения двух указанных вызовов, предоставляя полноценное представление о расположении пользователя в процессе проверки подлинности. Платформа сопутствующих устройств предоставляет эту функцию, отправляя уведомление об изменении состояния блокировки фоновой задаче приложения.

![процесс на сопутствующем устройстве](images/companion-device-4.png)

Ниже указано подробное описание каждого из этих состояний:

| Состояние                         | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|----------------------------   |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------    |
| WaitingForUserConfirmation    | Это событие уведомления об изменении состояния активируется при отключении экрана блокировки (например, если пользователь нажал сочетание клавиш Windows + L). Мы не рекомендуем запрашивать сообщения об ошибках в случае возникновения проблем с поиском устройства при этом состоянии. Как правило, мы рекомендуем отображать сообщения только при наличии сигнала намерения. Приложение сопутствующего устройства должно вызвать первый API для проверки подлинности в этом состоянии, если сопутствующие устройство получает сигнал намерения (например, при использовании NFC-сканера, нажатии кнопки на сопутствующем устройстве или выполнении определенного жеста, такого как хлопок), а фоновая задача приложения сопутствующего устройства получает от сопутствующего устройства подтверждение получения сигнала намерения. В противном случае, если при запуске процесса проверки подлинности приложению сопутствующего устройства требуется компьютер (пользователю необходимо провести пальцем вверх на экране блокировки или нажать клавишу "ПРОБЕЛ"), то приложение сопутствующего устройства должно ожидать следующего состояния (CollectingCredential).    |
| CollectingCredential          | Это событие уведомления об изменении состояния активируется, если пользователь открывает крышку ноутбука, нажимает любую клавишу на клавиатуре или проводит пальцем вверх на экране блокировки. Если для получения сигнала намерения сопутствующему устройству требуются указанные действия, то приложение сопутствующего устройства должно приступить к его получению (например, с помощью всплывающего уведомления на сопутствующем устройстве с запросом на разблокировку компьютера для пользователя). Это подходящий момент для отображения сообщений об ошибках, если приложению сопутствующего устройства требуется, чтобы пользователь отправил сигнал своего присутствия с сопутствующего устройства (например, путем ввода ПИН-кода на этом устройстве).                                                                                                                                                                                                                                                                                                                                               |
| Suspendingauthentication      | Если приложение сопутствующего устройства получает это состояние, значит, служба проверки подлинности сопутствующих устройств перестала принимать запросы на проверку подлинности.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| CredentialCollected           | Это состояние означает, что другое приложение сопутствующего устройства вызвало второй API, и служба проверки подлинности сопутствующих устройств проверяет отправленные данные. На этом этапе служба проверки подлинности сопутствующих устройств не принимает другие запросы на проверку подлинности, если только проверка текущего запроса не завершится с ошибкой. Приложение сопутствующего устройства должно оставаться на связи, пока не будет достигнуто следующее состояние.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| CredentialAuthenticated       | Это состояние означает, что отправленные учетные данные подошли. Состояние credentialAuthenticated содержит код сопутствующего устройства, успешно прошедшего проверку. Приложение сопутствующего устройства обязательно должно проверить этот код и подтвердить, что он принадлежит связанному с ним устройству. В противном случае приложение сопутствующего устройства не должно демонстрировать процессы, следующие за проверкой подлинности (например, сообщение об успешной проверке на сопутствующем устройстве или, возможно, вибрирование этого устройства). Обратите внимание, что если отправленные учетные данные не подошли, состояние изменится на CollectingCredential.                                                                                                                                                                                                                                                                                                                                                                                        |
| StoppoingAuthentication       | Проверка подлинности пройдена успешно, и пользователь увидел рабочий стол. Пора завершить фоновую задачу.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |



Приложения сопутствующих устройств должны вызывать первые два API проверки подлинности только при первых двух состояниях.  Приложения сопутствующих устройств должны проверять, в какой ситуации активируется это событие. Есть два варианта: разблокировка или последующие за ней процессы. На текущий момент поддерживается только разблокировка. В следующих выпусках может быть реализована поддержка сценариев после разблокировки. Перечисление SecondaryAuthenticationFactorAuthenticationScenario включает оба этих варианта:

```C#
{
    SignIn = 0,         // Running under lock screen mode
    CredentialPrompt,   // Running post unlock
}
```

Пример полного кода:

```C#
using System;
using Windows.Security.Authentication.Identity.Provider;
using Windows.Storage.Streams;
using Windows.Security.Cryptography;
using System.Threading;
using Windows.ApplicationModel.Background;

namespace SecondaryAuthFactorSample
{
    public sealed class AuthenticationTask : IBackgroundTask
    {
        private string _deviceId;
        private static AutoResetEvent _exitTaskEvent = new AutoResetEvent(false);
        private static IBackgroundTaskInstance _taskInstance;
        private BackgroundTaskDeferral _deferral;

        private void Authenticate()
        {
            int retryCount = 0;

            while (retryCount < 3)
            {
                //
                // Pseudo code, the svcAuthNonce should be passed to device or generated from device
                //
                IBuffer svcAuthNonce = CryptographicBuffer.GenerateRandom(256/8);

                SecondaryAuthenticationFactorAuthenticationResult authResult = await
                    SecondaryAuthenticationFactorAuthentication.StartAuthenticationAsync(
                        _deviceId,
                        svcAuthNonce);
                if (authResult.Status != SecondaryAuthenticationFactorAuthenticationStatus.Started)
                {
                    SecondaryAuthenticationFactorAuthenticationMessage message;
                    switch (authResult.Status)
                    {
                        case SecondaryAuthenticationFactorAuthenticationStatus.DisabledByPolicy:
                            message = SecondaryAuthenticationFactorAuthenticationMessage.DisabledByPolicy;
                            break;
                        case SecondaryAuthenticationFactorAuthenticationStatus.InvalidAuthenticationStage:
                            // The task might need to wait for a SecondaryAuthenticationFactorAuthenticationStageChangedEvent
                            break;
                        default:
                            return;
                    }

                    // Show error message. Limited to 512 characters wide
                    await SecondaryAuthenticationFactorAuthentication.ShowNotificationMessageAsync(null, message);
                    return;
                }

                //
                // Pseudo function:
                // The device calculates and returns sessionHmac and deviceHmac
                //
                await GetHmacsFromDevice(
                    authResult.Authentication.ServiceAuthenticationHmac,
                    authResult.Authentication.DeviceNonce,
                    authResult.Authentication.SessionNonce,
                    out deviceHmac,
                    out sessionHmac);
                if (sessionHmac == null ||
                    deviceHmac == null)
                {
                    await authResult.Authentication.AbortAuthenticationAsync(
                        "Failed to read data from device");
                    return;
                }

                SecondaryAuthenticationFactorFinishAuthenticationStatus status =
                    await authResult.Authentication.FinishAuthencationAsync(deviceHmac, sessionHmac);
                if (status == SecondaryAuthenticationFactorFinishAuthenticationStatus.NonceExpired)
                {
                    retryCount++;
                    continue;
                }
                else if (status == SecondaryAuthenticationFactorFinishAuthenticationStatus.Completed)
                {
                    // The credential data is collected and ready for unlock
                    return;
                }
            }
        }

        public void OnAuthenticationStageChanged(
            object sender,
            SecondaryAuthenticationFactorAuthenticationStageChangedEventArgs args)
        {
            // The application should check the args.StageInfo.Stage to determine what to do in next. Note that args.StageInfo.Scenario will have the scenario information (SignIn vs CredentialPrompt).

            switch(args.StageInfo.Stage)
            {
            case SecondaryAuthenticationFactorAuthenticationStage.WaitingForUserConfirmation:
                // Show welcome message
                await SecondaryAuthenticationFactorAuthentication.ShowNotificationMessageAsync(
                    null,
                    SecondaryAuthenticationFactorAuthenticationMessage.WelcomeMessageSwipeUp);
                break;

            case SecondaryAuthenticationFactorAuthenticationStage.CollectingCredential:
                // Authenticate device
                Authenticate();
                break;

            case SecondaryAuthenticationFactorAuthenticationStage.CredentialAuthenticated:
                if (args.StageInfo.DeviceId = _deviceId)
                {
                    // Show notification on device about PC unlock
                }
                break;

            case SecondaryAuthenticationFactorAuthenticationStage.StoppingAuthentication:
                // Quit from background task
                _exitTaskEvent.Set();
                break;
            }

            Debug.WriteLine("Authentication Stage = " + args.StageInfo.AuthenticationStage.ToString());
        }

        //
        // The Run method is the entry point of a background task.
        //
        public void Run(IBackgroundTaskInstance taskInstance)
        {
            _taskInstance = taskInstance;
            _deferral = taskInstance.GetDeferral();

            // Register canceled event for this task
            taskInstance.Canceled += TaskInstanceCanceled;

            // Find all device registred by this application
            IReadOnlyList<SecondaryAuthenticationFactorInfo> deviceInfoList =
                await SecondaryAuthenticationFactorRegistration.FindAllRegisteredDeviceInfoAsync(
                    SecondaryAuthenticaitonFactorDeviceFindScope.AllUsers);

            if (deviceInfoList.Count == 0)
            {
                // Quit the task silently
                return;
            }
            _deviceId = deviceInfoList[0].DeviceId;
            Debug.WriteLine("Use first device '" + _deviceId + "' in the list to signin");

            // Register AuthenticationStageChanged event
            SecondaryAuthenticationFactorRegistration.AuthenticationStageChanged += OnAuthenticationStageChanged;

            // Wait the task exit event
            _exitTaskEvent.WaitOne();

            _deferral.Complete();
        }

        void TaskInstanceCanceled(IBackgroundTaskInstance sender, BackgroundTaskCancellationReason reason)
        {
            _exitTaskEvent.Set();
        }
    }
}
```

### Регистрация фоновой задачи

При регистрации первого сопутствующего устройства приложение сопутствующего устройства должно также зарегистрировать его компонент фоновой задачи, обеспечивающий передачу сведения о проверке подлинности между устройством и службой проверки подлинности сопутствующих устройств.

```C#
using System;
using Windows.Security.Authentication.Identity.Provider;
using Windows.Storage.Streams;
using Windows.ApplicationModel.Background;

namespace SecondaryAuthFactorSample
{
    public class BackgroundTaskManager
    {
        // Register background task
        public static async Task<IBackgroundTaskRegistration> GetOrRegisterBackgroundTaskAsync(
            string bgTaskName,
            string taskEntryPoint)
        {
            // Check if there's an existing background task already registered
            var bgTask = (from t in BackgroundTaskRegistration.AllTasks
                          where t.Value.Name.Equals(bgTaskName)
                          select t.Value).SingleOrDefault();
            if (bgTask == null)
            {
                BackgroundAccessStatus status =
                    BackgroundExecutionManager.RequestAccessAsync().AsTask().GetAwaiter().GetResult();

                if (status == BackgroundAccessStatus.Denied)
                {
                    Debug.WriteLine("Background Execution is denied.");
                    return null;
                }

                var taskBuilder = new BackgroundTaskBuilder();
                taskBuilder.Name = bgTaskName;
                taskBuilder.TaskEntryPoint = taskEntryPoint;
                taskBuilder.SetTrigger(new SecondaryAuthenticationFactorAuthenticationTrigger());
                bgTask = taskBuilder.Register();
                // Background task is registered
            }

            bgTask.Completed += BgTask_Completed;
            bgTask.Progress += BgTask_Progress;

            return bgTask;
        }
    }
}
```

### Ошибки и сообщения

Платформа сопутствующих устройств отвечает за обратную связь с пользователем касательно успешного или безуспешного выполнения входа. Платформа сопутствующих устройств предоставит на выбор приложению сопутствующего устройства набор (локализованных) тестовых сообщений и сообщений об ошибках. Они отображаются в пользовательском интерфейсе входа.

![ошибка сопутствующего устройства](images/companion-device-5.png)

Приложения сопутствующих устройств могут использовать ShowNotificationMessageAsync для отправки сообщений пользователю в рамках пользовательского интерфейса входа. Этот API следует вызвать при наличии сигнала намерения. Обратите внимание, что сигнал намерения всегда должен поступать от сопутствующего устройства.

Существует два типа сообщений: руководство и ошибки.

Сообщения с руководством предназначены для того, чтобы помочь пользователю начать процесс разблокировки. Эти сообщения отображаются для пользователя только один раз— при первоначальной регистрации устройства.

Сообщения об ошибках отображаются всегда. Сообщения об ошибках отображаются в течение 5 секунд, а затем исчезают. С учетом того, что перед отображением сообщений должен быть получен сигнал намерения, а пользователь отправит этот сигнал только с помощью одного из своих сопутствующих устройств, недопустима ситуация, в которой несколько сопутствующих устройств конкурируют для отображения сообщений об ошибках. Как следствие, платформа сопутствующих устройств не поддерживает какой-либо очереди. Когда вызывающая сторона запрашивает сообщение об ошибке, оно отображается в течение 5 секунд, а все остальные запросы на отображение сообщений об ошибке в течение этого времени отклоняются. По прошествии 5 секунд другая вызывающая сторона получает возможность отобразить сообщение об ошибке. Мы не позволяем вызывающим сторонам блокировать канал ошибок.

Сообщения с руководством и сообщения об ошибках выглядят следующим образом. Имя устройства — это параметр, передаваемый приложением сопутствующего устройства в составе ShowNotificationMessageAsync.

**Руководство**

- "Проведите пальцем вверх или нажмите клавишу "ПРОБЕЛ", чтобы войти с помощью *имя устройства*".
- "Приложите *имя устройства* к NFC-сканеру, чтобы войти".
- "Поиск *имя устройства*..."
- "Подключите *имя устройства* к USB-порту, чтобы войти".

**Ошибки**

- "Инструкции по входу можно найти на *имя устройства*".
- "Включите Bluetooth, чтобы использовать *имя устройства* для входа".
- "Включите NFC, чтобы использовать *имя устройства* для входа".
- "Подключитесь к сети Wi-Fi, чтобы использовать *имя устройства* для входа".
- "Коснитесь *имя устройства* еще раз".
- "Ваше предприятие запрещает вход с помощью *имя устройства*. Используйте другой способ входа."
- "Коснитесь *имя устройства*, чтобы войти".
- "Коснитесь и удерживайте *имя устройства*, чтобы войти".
- "Проведите пальцем по *имя устройства*, чтобы войти".
- "Не удается войти с помощью *имя устройства*. Используйте другой способ входа."
- "Возникла проблема. Используйте другой способ входа, а затем снова настройте *имя устройства*."
- "Повторите попытку".
- "Произнесите свою устную парольную фразу в микрофон *имя устройства*".
- "Все готово ко входу с помощью *имя устройства*".
- "Сначала используйте другой способ входа, затем вы сможете использовать для входа *имя устройства*".

### Перечисление зарегистрированных устройств

Приложение сопутствующего устройства может перечислить список зарегистрированных сопутствующих устройств с помощью вызова FindAllRegisteredDeviceInfoAsync. Этот API поддерживает два типа запросов, определенных через перечисление SecondaryAuthenticaitonFactorDeviceFindScope:

```C#
{
    User = 0,
    AllUsers,
}
```

Первая область возвращает список устройств для выполнившего вход пользователя. Вторая возвращает список всех пользователей на этом компьютере. Первую область следует использовать при отмене регистрации, чтобы избежать отмены регистрации сопутствующего устройства другого пользователя. Вторую область следует использовать при проверке подлинности или регистрации. При регистрации это перечисление поможет приложению не допустить повторной регистрации одного и того же сопутствующего устройства.

Обратите внимание, что даже если приложение не выполнит эту проверку, компьютер проведет ее и не позволит зарегистрировать одно и то же сопутствующее устройство несколько раз. Использование области AllUsers при проверке подлинности позволяет приложению сопутствующего устройства поддерживать процесс переключения пользователей: выполняется вход для пользователя А во время сеанса входа пользователя Б (для этого необходимо, чтобы у обоих пользователей было установлено приложение сопутствующего устройства, сопутствующие устройства пользователя А были зарегистрированы на компьютере, а на компьютере отображался экран блокировки или входа).

## Требования к безопасности

Служба проверки подлинности сопутствующих устройств предоставляет следующие средства обеспечения безопасности.

- Вредоносная программа на настольном компьютере с Windows 10, работающем в качестве среднего пользователя или контейнера приложений, не может использовать сопутствующее устройство для незаметного получения доступа к ключам учетных данных пользователя (хранящихся в составе Microsoft Passport) на компьютере.
- Злоумышленник на настольном компьютере с Windows 10 не может использовать сопутствующее устройство другого пользователя на этом компьютере для незаметного получения доступа к ключам учетных данных этого пользователя (на том же настольном компьютере с Windows 10).
- Вредоносная программа на сопутствующем устройстве не может незаметно получить доступ к ключам учетных данных пользователя на настольном компьютере с Windows 10, включая использование функций или кода, разработанных специально для платформы сопутствующих устройств.
- Злоумышленник не может разблокировать настольный компьютер с Windows 10 путем перехвата трафика между сопутствующим устройством и этим компьютером и его последующим повторением. Использование nonce, authkey и HMAC в нашем протоколе обеспечивает надежную защиту от атак с повторением.
- Вредоносная программа или злоумышленник на несанкционированном компьютере не может использовать сопутствующее устройство для получения доступа к компьютеру авторизованного пользователя. Это обеспечивается благодаря взаимной проверке подлинности между службой сопутствующих устройств и сопутствующим устройством с использованием authkey и HMAC в нашем протоколе.

Основное условие эффективности указанных средств обеспечения безопасности заключается в защите ключей HMAC от несанкционированного доступа и проверке присутствия пользователя. В частности, должны выполняться следующие требования:

- обеспечение защиты от клонирования сопутствующего устройства;
- обеспечение защиты от перехвата при отправке ключей HMAC на компьютер во время регистрации;
- проверка наличия сигнала присутствия пользователя.



<!--HONumber=Jun16_HO4-->


