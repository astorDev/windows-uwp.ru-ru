---
title: Отладка фоновой задачи
description: Узнайте, как отладить фоновую задачу, выполнив в том числе активацию фоновой задачи и трассировку отладки в журнале событий Windows.
ms.assetid: 24E5AC88-1FD3-46ED-9811-C7E102E01E9C
ms.date: 02/08/2017
ms.topic: article
keywords: Windows 10, UWP, фоновая задача
ms.localizationpriority: medium
ms.openlocfilehash: c337de2a1fc349cfa3965402848fbead51e61e83
ms.sourcegitcommit: a20457776064c95a74804f519993f36b87df911e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/27/2019
ms.locfileid: "71340471"
---
# <a name="debug-a-background-task"></a>Отладка фоновой задачи


**Важные API**
-   [Windows.ApplicationModel.Background](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background)

Узнайте, как отладить фоновую задачу, выполнив в том числе активацию фоновой задачи и трассировку отладки в журнале событий Windows.

## <a name="debugging-out-of-process-vs-in-process-background-tasks"></a>Сравнение отладки фоновых задач, выполняемых вне процесса, с фоновыми задачами внутри процесса
В этом разделе в основном рассматриваются фоновые задачи, которые выполняются в отдельном процессе, отличном от процесса основного приложения. Если выполняется отладка фоновой задачи, выполняемой внутри процесса, отдельный проект фоновой задачи отсутствует, и можно задать точку останова в **OnBackgroundActivated** (где выполняется ваш фоновый код внутри процесса); затем см. шаг 2 в разделе [Ручная активация фоновых задач для отладки их кода](#trigger-background-tasks-manually-to-debug-background-task-code) ниже, в котором приведены инструкции по запуску выполнения фонового кода.

## <a name="make-sure-the-background-task-project-is-set-up-correctly"></a>Правильная настройка параметров проекта фоновой задачи

В этой статье предполагается, что у вас уже есть приложение с фоновой задачей, которую необходимо отладить. Приведенная ниже информация относится к фоновым задачам, которые выполняются вне процесса; она не касается фоновых задач, выполняющихся внутри процесса.

-   Для приложений на языках C# и C++ основной проект должен ссылаться на проект фоновой задачи. Если такой ссылки нет, то фоновая задача не будет включена в пакет приложения.
-   В коде на языке C# или C++ параметр **Тип вывода** проекта фоновой задачи должен иметь значение "Компонент среды выполнения Windows".
-   Фоновый класс необходимо объявить в атрибуте точки входа в манифесте пакета.

## <a name="trigger-background-tasks-manually-to-debug-background-task-code"></a>Ручная активация фоновых задач для отладки их кода

Фоновые задачи могут быть запущены вручную через Microsoft Visual Studio. После этого можно по шагам выполнять код и его отладку.

1.  В C# поместите точку останова в метод Run фонового класса (для фоновых задач внутри процесса установите точки останова в App.OnBackgroundActivated()) и/или напишите отладочный вывод с помощью [**System.Diagnostics**](https://docs.microsoft.com/dotnet/api/system.diagnostics).

    В C++ поместите точку останова в функцию Run фонового класса (для фоновых задач внутри процесса установите точки останова в App.OnBackgroundActivated()) и/или напишите отладочный вывод с помощью [**OutputDebugString**](https://docs.microsoft.com/windows/desktop/api/debugapi/nf-debugapi-outputdebugstringw).

2.  Запустите приложение в отладчике, затем активируйте фоновую задачу с помощью панели инструментов **События жизненного цикла**. В этом раскрывающемся меню отображаются имена фоновых задач, которые можно активировать с помощью Visual Studio.

> [!NOTE]
> Параметры панели инструментов события жизненного цикла по умолчанию не отображаются в Visual Studio. Чтобы отобразить эти параметры, щелкните правой кнопкой мыши текущую панель инструментов в Visual Studio и убедитесь, что параметр **Расположение отладки** включен.

    For this to work, the background task must already be registered and it must still be waiting for the trigger. For example, if a background task was registered with a one-shot TimeTrigger and that trigger has already fired, launching the task through Visual Studio will have no effect.

> [!Note]
> Фоновые задачи, использующие следующие триггеры, не могут быть активированы таким образом: [**Триггеры приложений**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.applicationtrigger), [**триггеры медиапроцессинг**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.mediaprocessingtrigger), [**контролчаннелтригжер**](https://docs.microsoft.com/uwp/api/Windows.Networking.Sockets.ControlChannelTrigger), [**Пушнотификатионтригжер**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.PushNotificationTrigger)и фоновые задачи, использующие [**системтригжер**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTrigger) с типом триггера [**смсрецеивед**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTriggerType) .  
> **ApplicationTrigger** и **MediaProcessingTrigger** можно установить в коде вручную с помощью `trigger.RequestAsync()`.

![Отладка фоновых задач](images/debugging-activation.png)

3.  При активации фоновой задачи отладчик подключается к ней и отображает отладочный вывод в Visual Studio.

## <a name="debug-background-task-activation"></a>Отладка активации фоновой задачи

> [!NOTE]
> Этот раздел относится к фоновым задачам, которые выполняются вне процесса; он не касается фоновых задач, выполняющихся внутри процесса.

Активация фоновой задачи зависит от трех условий:

-   Имя и пространство имен класса фоновой задачи.
-   Атрибут точки входа, указанный в манифесте пакета.
-   Точка входа, заданная приложением при регистрации фоновой задачи.

1.  Используя Visual Studio, определите точку входа фоновой задачи:

    -   В коде на языке C# или C++ запомните имя и пространство имен класса фоновой задачи, указанные в проекте фоновой задачи.

2.  С помощью конструктора манифеста проверьте, правильно ли объявлена фоновая задача в манифесте пакета.

    -   В коде на языке C# или C++ атрибут точки входа должен соответствовать пространству имен фоновой задачи, за которым следует имя класса. Пример: RuntimeComponent1. Мибаккграундтаск.
    -   Кроме того, необходимо указать все типы триггеров, которые использует задача.
    -   Исполняемый файл НЕ СЛЕДУЕТ указывать, если только вы не используете [**ControlChannelTrigger**](https://docs.microsoft.com/uwp/api/Windows.Networking.Sockets.ControlChannelTrigger) или [**PushNotificationTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.PushNotificationTrigger).

3.  Только Windows. Чтобы увидеть точку входа, используемую Windows для активации фоновой задачи, включите трассировку отладки и используйте журнал событий Windows.

    Если после выполнения этой процедуры в журнале событий отображается неправильная точка входа или триггер фоновой задачи, это означает, что приложение неправильно регистрирует фоновую задачу. Разобраться с такой задачей поможет статья [Регистрация фоновой задачи](register-a-background-task.md).

    1.  Перейдите на начальный экран и откройте просмотр событий (для этого найдите и запустите файл eventvwr.exe).
    2.  &gt; Перейдите в раздел **журналы**  - приложений и служб **Microsoft**  - &gt; **Windows** баккграундтаскинфраструктуревсредствепросмотрасобытий. - &gt;
    3.  На панели действия выберите **вид**  - &gt; **Показать журналы аналитики и отладки** , чтобы включить ведение журнала диагностики.
    4.  Выберите **Журнал диагностики** и щелкните **Включить журнал**.
    5.  Теперь попробуйте еще раз использовать ваше приложение для регистрации и активации фоновой задачи.
    6.  Просмотрите в журналах диагностики подробную информацию об ошибке. Эта информация будет содержать точку входа, зарегистрированную для фоновой задачи.

![Просмотр событий для информации об отладке фоновых задач](images/event-viewer.png)

## <a name="background-tasks-and-visual-studio-package-deployment"></a>Фоновые задачи и развертывание пакета Visual Studio

Если приложение, которое использует фоновые задачи, развернуто с помощью Visual Studio, а версия (основная или дополнительная), указанная в конструкторе манифеста, затем обновляется, то последующее повторное развертывание приложения с помощью Visual Studio может вызвать блокировку фоновых задач приложения. Эту проблему можно решить следующим образом:

-   Используйте Windows PowerShell для развертывания обновленного приложения (вместо Visual Studio), запустив сценарий, созданный вместе с пакетом.
-   Если вы уже развернули приложение с помощью Visual Studio и фоновые задачи приложения теперь блокированы, перезагрузите систему либо выйдите из системы и войдите снова, чтобы фоновые задачи приложения опять заработали.
-   Вы можете выбрать параметр отладки "Всегда переустанавливать мой пакет", чтобы избежать этого в проектах C#.
-   Подождите с обновлением версии пакета, пока приложение не будет готово к окончательному развертыванию (не меняйте версию во время отладки).

## <a name="remarks"></a>Примечания

-   Убедитесь, что перед повторной регистрацией фоновой задачи приложение проверяет существующие регистрации фоновых задач. Многократная регистрация одной и той же фоновой задачи может привести к неожиданным результатам, так как фоновая задача будет запускаться каждый раз при ее активации.
-   Если фоновой задаче требуется доступ к экрану блокировки, то перед выполнением ее отладки необходимо, чтобы приложение было размещено на экране блокировки. Сведения о том, как указывать параметры манифеста для приложений с возможностью размещения на экране блокировки, см. в статье [Объявление фоновых задач в манифесте приложения](declare-background-tasks-in-the-application-manifest.md).
-   Параметры регистрации фоновых задач проверяются во время регистрации. Если какие-либо из параметров регистрации недопустимы, возвращается ошибка. Убедитесь, что ваше приложение корректно обрабатывает сценарии, в которых регистрация фоновой задачи завершается ошибкой. Если работа вашего приложения зависит от наличия допустимого объекта регистрации после попытки регистрации задачи, то оно может дать сбой.

Дополнительные сведения об использовании VS для отладки фоновой задачи см. в статье [как активировать события приостановки, возобновления и фоновых событий в приложениях UWP](https://docs.microsoft.com/visualstudio/debugger/how-to-trigger-suspend-resume-and-background-events-for-windows-store-apps-in-visual-studio?view=vs-2015).

## <a name="related-topics"></a>См. также

* [Создание и регистрация внепроцессной фоновой задачи](create-and-register-a-background-task.md)
* [Создание и регистрация фоновой задачи, выполняемой внутри процесса](create-and-register-an-inproc-background-task.md)
* [Регистрация фоновой задачи](register-a-background-task.md)
* [Объявление фоновых задач в манифесте приложения](declare-background-tasks-in-the-application-manifest.md)
* [Руководство по работе с фоновыми задачами](guidelines-for-background-tasks.md)
* [Как активировать события приостановки, возобновления и фоновых событий в приложениях UWP](https://docs.microsoft.com/visualstudio/debugger/how-to-trigger-suspend-resume-and-background-events-for-windows-store-apps-in-visual-studio?view=vs-2015)
* [Анализ качества кода приложений UWP с помощью анализа кода Visual Studio](https://docs.microsoft.com/visualstudio/test/analyze-the-code-quality-of-store-apps-using-visual-studio-static-code-analysis?view=vs-2015)

 

 
