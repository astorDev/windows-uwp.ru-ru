---
title: Доступ к датчикам и устройствам из фоновой задачи
description: DeviceUseTrigger позволяет универсальному приложению для Windows получать доступ к датчикам и периферийным устройствам в фоновом режиме даже тогда, когда приложение переднего плана приостановлено.
ms.assetid: B540200D-9FF2-49AF-A224-50877705156B
ms.date: 02/08/2017
ms.topic: article
keywords: Windows 10, UWP, фоновая задача
ms.localizationpriority: medium
ms.openlocfilehash: 50316df323129e4e36335ab32d6af8cc92b8a201
ms.sourcegitcommit: b52ddecccb9e68dbb71695af3078005a2eb78af1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74259498"
---
# <a name="access-sensors-and-devices-from-a-background-task"></a>Доступ к датчикам и устройствам из фоновой задачи




[ **DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) позволяет приложению UWP получать доступ к датчикам и периферийным устройствам в фоновом режиме даже тогда, когда приложение переднего плана приостановлено. Например, в зависимости от того, где выполняется приложение, оно может использовать фоновую задачу, чтобы синхронизировать данные с устройством или отслеживать показания датчиков. Чтобы сохранить уровень заряда и обеспечить соответствующее согласие пользователя, использование [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) регулируется политиками, описанными в этой теме.

Для доступа к датчикам или периферийным устройствам в фоновом режиме создайте фоновую задачу, которая использует [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Пример выполнения на ПК см. в разделе [Пример настраиваемого устройства USB](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/CustomUsbDeviceAccess). Пример для телефона см. в разделе [Пример фоновых датчиков](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/BackgroundSensors).

> [!Important]
> **DeviceUseTrigger** не может использоваться с фоновыми задачами в одном процессе. Информация в этом разделе относится только к фоновым задачам, которые выполняются в отдельном процессе.

## <a name="device-background-task-overview"></a>Обзор фоновой задачи устройства

Когда приложение выйдет из поля видимости пользователя, Windows приостановит или завершит работу приложения, чтобы освободить ресурсы памяти и ЦП. Это позволит другим приложениям работать на переднем плане и сократит расход заряда батареи. Когда это произойдет, без помощи фоновой задачи все незавершенные события, инициируемые изменением данных, будут потеряны. Windows предоставляет триггер фоновой задачи, [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger), чтобы позволить приложению безопасно выполнять длительные операции синхронизации и наблюдения на устройствах и датчиках в фоновом режиме, даже если приложение приостановлено. Подробнее о жизненном цикле приложения: [Запуск, возобновление и фоновые задачи](index.md). Подробнее об использовании фоновых задач: [Поддержка приложения с помощью фоновых задач](support-your-app-with-background-tasks.md).

**Обратите внимание** ,  в универсальном приложении для Windows Синхронизация устройства в фоновом режиме требует, чтобы ваш пользователь утвердил фоновую синхронизацию с приложением. Устройство также должно быть подключено к компьютеру с активным вводом-выводом, и на устройстве должно быть разрешено до 10 минут фоновой активности. Подробнее о применении политики рассказывается ниже в этом разделе.

### <a name="limitation-critical-device-operations"></a>Ограничение: критические операции с устройством

Некоторые критические операции с устройством, например длительные обновления встроенного ПО, не могут выполняться с помощью класса [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Такие операции могут выполняться только на компьютере и только привилегированным приложением, которое использует [**DeviceServicingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceServicingTrigger). *Привилегированным* называется приложение, которому изготовитель устройства разрешил выполнять эти операции. Метаданные устройства позволяют указать, какое приложение (при его наличии) было назначено в качестве привилегированного приложения на устройстве. Подробнее: [Синхронизация и обновление устройства с приложениями для устройства из Microsoft Store](https://msdn.microsoft.com/library/windows/hardware/dn265139(v=vs.85).aspx).

## <a name="protocolsapis-supported-in-a-deviceusetrigger-background-task"></a>Протоколы и API, поддерживаемые в фоновой задаче DeviceUseTrigger

Фоновые задачи, использующие [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger), позволяют приложению устанавливать связь по множеству протоколов и API, большинство из которых не поддерживается фоновыми задачами, запущенными системой. В универсальном приложении для Windows поддерживаются следующие протоколы и API.

| Используемый протокол         | DeviceUseTrigger в универсальном приложении для Windows                                                                                                                                                    |
|------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| USB              | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| HID              | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| Bluetooth RFCOMM | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| Bluetooth GATT   | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| MTP              | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| Проводная сеть    | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| Сеть Wi-Fi    | ![этот протокол поддерживается.](images/ap-tools.png)                                                                                                                                            |
| IDeviceIOControl | ![deviceservicingtrigger поддерживает ideviceiocontrol](images/ap-tools.png)                                                                                                                       |
| API датчиков      | ![deviceservicingtrigger поддерживает универсальные API датчиков](images/ap-tools.png) (ограничено датчиками в [семействе универсальных устройств](https://docs.microsoft.com/windows/uwp/get-started/universal-application-platform-guide)) |

## <a name="registering-background-tasks-in-the-app-package-manifest"></a>Регистрация фоновых задач в манифесте пакета приложения

Приложение будет выполнять операции синхронизации и обновления в коде, который входит в фоновую задачу. Код внедрен в класс среды выполнения Windows, который реализует интерфейс [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask) (или на специальной странице JavaScript для приложений на JavaScript). Для использования фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) приложение должно объявить ее в файле манифеста приложения на переднем плане — как с фоновыми задачами, которые активируются системой.

В этом примере для файла манифеста пакета приложения **DeviceLibrary.SyncContent** является точкой входа для фоновой задачи, которая использует класс [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger).

```xml
<Extensions>
  <Extension Category="windows.backgroundTasks" EntryPoint="DeviceLibrary.SyncContent">
    <BackgroundTasks>
      <m2:Task Type="deviceUse" />
    </BackgroundTasks>
  </Extension>
</Extensions>
```

## <a name="introduction-to-using-deviceusetrigger"></a>Введение в использование DeviceUseTrigger

Для использования класса [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) выполните следующие основные шаги. Подробнее об использовании фоновых задач: [Поддержка приложения с помощью фоновых задач](support-your-app-with-background-tasks.md).

1.  Приложение регистрирует фоновую задачу в манифесте приложения и внедряет код фоновой задачи в класс среды выполнения Windows, который реализует IBackgroundTask, или на специальную страницу JavaScript для приложений на JavaScript.
2.  При запуске приложение создаст и настроит объект триггера с типом [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) и сохранит экземпляр триггера для использования в будущем.
3.  Приложение проверяет предварительную регистрацию фоновой задачи и при необходимости регистрирует ее по триггеру. Обратите внимание, что приложению не разрешено задавать условия для задачи, связанной с этим триггером.
4.  Если приложению необходимо активировать фоновую задачу, сначала оно должно вызвать метод [**RequestAccessAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.requestaccessasync), чтобы проверить, может ли приложение запросить фоновую задачу.
5.  Если приложение может запросить фоновую задачу, оно вызывает метод активации [**RequestAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.deviceusetrigger.requestasync) в объекте триггера на устройстве.
6.  Фоновая задача не регулируется, как другие системные фоновые задачи (нет квоты на время ЦП), но выполняется со сниженным приоритетом, чтобы сохранить скорость реагирования приложений на переднем плане.
7.  Затем Windows проверит, соблюдены ли необходимые политики в зависимости от типа триггера, включая запрос согласия пользователя на операцию до запуска фоновой задачи.
8.  Windows отслеживает системные условия и среду выполнения задачи и при необходимости отменяет задачу, если требуемые условия перестают выполняться.
9.  Когда фоновая задача сообщит о ходе выполнения или завершении, приложение получит эти события посредством событий выполнения и завершения зарегистрированной задачи.

**Важно**   учитывайте следующие важные моменты при использовании [**девицеусетригжер**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger):

-   Возможность программно активировать фоновые задачи, использующие [**девицеусетригжер**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) , впервые появилась в Windows 8.1 и Windows Phone 8,1.

-   Определенные политики применяются системой Windows для получения согласия пользователя при обновлении периферийных устройств на компьютере.

-   Дополнительные политики применяются для сохранения уровня заряда батареи при синхронизации и обновлении периферийных устройств.

-   Windows может отменить фоновые задачи, использующие класс [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger), когда перестают выполняться определенные требования политики, включая максимальное количество фонового времени (времени по часам). Эти требования политики важно учитывать при использовании фоновых задач для взаимодействия с периферийным устройством.

**Совет**  чтобы увидеть, как работают эти фоновые задачи, Скачайте пример. Пример выполнения на ПК см. в разделе [Пример настраиваемого устройства USB](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/CustomUsbDeviceAccess). Пример для телефона см. в разделе [Пример фоновых датчиков](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/BackgroundSensors).
 
## <a name="frequency-and-foreground-restrictions"></a>Ограничения частоты и выполнения на переднем плане

Ограничения на частоту, с которой приложение может запускать операции, отсутствуют, но приложение может выполнять только одну операцию фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) единовременно (это не влияет на другие типы фоновых задач) и может инициировать фоновую задачу, только когда приложение выполняется на переднем плане. Когда приложение выполняется не на переднем плане, оно не может инициировать фоновую задачу с помощью класса **DeviceUseTrigger**. Приложение не может инициировать вторую фоновую задачу **DeviceUseTrigger**, пока не завершится первая.

## <a name="device-restrictions"></a>Ограничения на устройстве

Если каждое приложение ограничено регистрацией и выполнением только одной фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger), устройство (на котором выполняется ваше приложение) может разрешить нескольким приложениям регистрировать и запускать фоновые задачи **DeviceUseTrigger**. В зависимости от устройства может быть ограничение на общее число фоновых задач **DeviceUseTrigger** от всех приложений. Это помогает сохранить уровень заряда батареи на устройствах с ограниченными ресурсами. Подробности см. в следующей таблице.

Из одной фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) приложение может получить доступ к любому числу периферийных устройств или датчиков, ограниченному только поддерживаемыми API и протоколами, указанными в предыдущей таблице.

## <a name="background-task-policies"></a>Политики фоновых задач

Windows применяет политики, когда приложение использует фоновую задачу [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Если политики не соблюдаются, фоновая задача может быть отменена. Эти требования политики важно учитывать, когда данный тип фоновой задачи используется для взаимодействия с устройствами или датчиками.

### <a name="task-initiation-policies"></a>Политики инициирования задач

В таблице указаны политики инициирования задач, применимые к универсальному приложению для Windows.

| Политика | DeviceUseTrigger в универсальном приложении для Windows |
|--------|---------------------------------------------|
| Во время активации фоновой задачи приложение выполняется на переднем плане. | ![политика применяется](images/ap-tools.png) |
| Устройство подключено к системе (или находится в пределах досягаемости для беспроводного устройства). | ![политика применяется](images/ap-tools.png) |
| Устройство доступно приложению, использующему поддерживаемые периферийные API устройства (API среды выполнения Windows для USB, HID, Bluetooth, датчиков и т. д.). Если приложение не может получить доступ к устройству или датчику, в доступе к фоновой задаче будет отказано. | ![политика применяется](images/ap-tools.png) |
| Точка входа в фоновую задачу, предоставленная приложением, регистрируется в манифесте пакета приложения. | ![политика применяется](images/ap-tools.png) |
| Выполняется только одна фоновая задача [DeviceUseTrigger](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) на приложение. | ![политика применяется](images/ap-tools.png) |
| Еще не достигнуто максимальное число фоновых задач [DeviceUseTrigger](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) на устройстве (на котором выполняется приложение). | **Семейство настольных устройств**: параллельно может быть зарегистрировано и запущено неограниченное число задач. **Семейство мобильных устройств**: 1 задача на устройстве с памятью объемом 512 МБ, либо параллельно могут быть зарегистрированы и запущены 2 задачи. |
| Максимальное число периферийных устройств или датчиков, доступных приложению из одной фоновой задачи [DeviceUseTrigger](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) при использовании поддерживаемых API или протоколов. | Без ограничений |
| Ваша фоновая задача расходует 400 мс времени ЦП (для 1 ГГц ЦП) каждую минуту, когда экран заблокирован, или каждые 5 минут, когда экран не заблокирован. Нарушение этой политики может привести к отмене задачи. | ![политика применяется](images/ap-tools.png) |

### <a name="runtime-policy-checks"></a>Проверки политики среды выполнения

Windows предъявляет следующие требования политики среды выполнения, когда ваша задача выполняется в фоновом режиме. Если любое из требований среды выполнения перестанет быть истинным, Windows отменит фоновую задачу на устройстве.

В таблице указаны политики среды выполнения, применимые к универсальному приложению для Windows.

| Проверка политики | DeviceUseTrigger в универсальном приложении для Windows |
|--------------|:-------------------------------------------:|
| Устройство подключено к системе (или находится в пределах досягаемости для беспроводного устройства). | ![проверка политики применяется](images/ap-tools.png) |
| Задача выполняет обычный ввод-вывод на устройстве (1 ввод-вывод каждые 5 секунд). | ![проверка политики применяется](images/ap-tools.png) |
| Приложение не отменило задачу. | ![проверка политики применяется](images/ap-tools.png) |
| Ограничение по времени по часам — общее количество времени, в течение которого задача приложения может выполняться в фоновом режиме. | **Семейство настольных устройств**: 10 минут. **Семейство мобильных устройств**: ограничений по времени нет. Для сохранения ресурсов не более 1 или 2 задач могут выполняться одновременно. |
| Приложение не завершило работу. | ![проверка политики применяется](images/ap-tools.png) |

## <a name="best-practices"></a>Рекомендации

Ниже приводятся рекомендации для приложений, которые используют фоновые задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger).

### <a name="programming-a-background-task"></a>Программирование фоновой задачи

Использование фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger) в приложении позволяет любым операциям синхронизации или отслеживания, запускаемым в приложении на переднем плане, продолжать работу в фоновом режиме, если пользователи переключают приложения и ваше приложение на переднем плане приостанавливается системой Windows. Мы рекомендуем следовать такой общей модели для регистрации, инициирования и отмены регистрации фоновых задач.

1.  Вызовите метод [**RequestAccessAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.requestaccessasync), чтобы проверить, может ли приложение отправить запрос фоновой задаче. Это необходимо выполнить до регистрации фоновой задачи.

2.  Зарегистрируйте фоновую задачу до запроса триггера.

3.  Подключите обработчики событий выполнения и завершения к вашему триггеру. Когда ваше приложение активируется после приостановки, Windows предоставит приложению любые события выполнения или завершения в очереди, которые могут использоваться для определения состояния фоновых задач.

4.  Закройте любые открытые объекты устройств или датчиков, когда активируете фоновые задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger), чтобы эти устройства или датчики могли быть открыты или использованы вашей фоновой задачей.

5.  Зарегистрируйте триггер.

6.  Внимательно изучите воздействие на батарею при доступе к устройству или датчику из фоновой задачи. Например, слишком маленький интервал между отчетами датчика может привести к такому частому выполнению задачи, при котором быстро разряжается батарея.

7.  Когда фоновая задача завершена, отмените ее регистрацию.

8.  Зарегистрируйте отмену событий из класса фоновой задачи. Регистрация для отмены событий разрешит коду фоновой задачи остановить выполнение фоновой задачи без ошибок при отмене системой Windows или вашим приложением на переднем плане.

9.  После завершения работы приложения (не приостановки) отмените регистрацию и отмените любые выполняющиеся задачи, если они больше не требуются приложению. В системах с ограниченными ресурсами, например телефонах с недостаточным объемом памяти, это позволит приложениям использовать фоновую задачу [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger).

    -   Когда приложение завершит работу, отмените регистрацию и отмените любые выполняющиеся задачи.

    -   Когда приложение завершит работу, фоновые задачи будут отменены и любые существующие обработчики событий будут отключены от ваших существующих фоновых задач. Будет запрещено определять состояние ваших фоновых задач. Отмена регистрации и отмена фоновых задач позволит вашему коду отмены остановить фоновые задачи без ошибок.

### <a name="cancelling-a-background-task"></a>Отмена фоновой задачи

Чтобы отменить задачу, запущенную в фоновом режиме из приложения на переднем плане, используйте метод Unregister объекта [**BackgroundTaskRegistration**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskRegistration), который используется в приложении для регистрации фоновой задачи [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Отмена регистрации фоновой задачи с помощью метода [**Unregister**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.unregister) класса **BackgroundTaskRegistration** приведет к отмене фоновой задачи инфраструктурой фоновых задач.

Метод [**Unregister**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.unregister) дополнительно принимает логическое значение true или false, указывая, должны ли быть отменены до завершения выполняющиеся в настоящее время экземпляры фоновой задачи. Дополнительные сведения см. в разделе, посвященном методу **Unregister**, справки по API.

В дополнение к методу [**Unregister**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskregistration.unregister) приложению может также потребоваться вызов метода [**BackgroundTaskDeferral.Complete**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundtaskdeferral.complete). Он информирует систему о завершении асинхронной операции, связанной с фоновой задачей.
