---
title: Поддержка приложения с помощью фоновых задач
description: В темах этого раздела показано, как обеспечить выполнение облегченного кода в фоновом режиме в ответ на триггеры.
ms.assetid: EFF7CBFB-D309-4ACB-A2A5-28E19D447E32
ms.date: 08/21/2017
ms.topic: article
keywords: Windows 10, UWP, фоновая задача
ms.localizationpriority: medium
ms.openlocfilehash: 7ca567d34c98deb75d7ebfa5ec9f70688ad18fdb
ms.sourcegitcommit: b52ddecccb9e68dbb71695af3078005a2eb78af1
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/20/2019
ms.locfileid: "74259419"
---
# <a name="support-your-app-with-background-tasks"></a>Поддержка приложения с помощью фоновых задач


В темах этого раздела показано, как обеспечить выполнение облегченного кода в фоновом режиме в ответ на триггеры. Фоновые задачи можно использовать для предоставления функциональных возможностей, когда приложение приостановлено или не выполняется. Фоновые задачи также можно использовать для приложений, обеспечивающих общение в реальном времени, например компьютерной телефонии, почты и обмена мгновенными сообщениями.

## <a name="playing-media-in-the-background"></a>Воспроизведение мультимедиа в фоновом режиме

Начиная c Windows 10 версии 1607, воспроизведение звука в фоновом режиме стало значительно проще. См. дополнительные сведения в разделе [Воспроизведение мультимедиа в фоновом режиме](https://docs.microsoft.com/windows/uwp/audio-video-camera/background-audio).

## <a name="in-process-and-out-of-process-background-tasks"></a>Фоновые задачи внутри и вне процесса

Существует два подхода к реализации фоновых задач.

* В процессе: приложение и его фоновый процесс запускаются в одном и том же процессе
* Вне процесса: приложение и фоновый процесс выполняются в отдельных процессах.

Поддержка выполняемых в процессе фоновых задач появилась в Windows 10 версии 1607, чтобы упростить написание фоновых задач. Однако вы по-прежнему можете создавать фоновые задачи вне процесса. См. рекомендации о том, когда записывать фоновую задачу в процессе и вне его, в разделе [Рекомендации по фоновым задачам](guidelines-for-background-tasks.md).

Фоновые задачи, которые выполняются вне процесса, являются более устойчивыми, поскольку фоновый процесс не может прекратить работу приложения, если что-то пойдет не так. Но устойчивость достигается за счет большей сложности при управлении межпроцессным взаимодействием между приложением и фоновой задачей.

Выполняемые вне процесса фоновые задачи реализуются как облегченные классы, которые реализуют интерфейс [**IBackgroundTask**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.IBackgroundTask), который ОС выполняет в виде отдельного процесса (backgroundtaskhost.exe). Зарегистрируйте фоновую задачу с помощью класса [**BackgroundTaskBuilder**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskBuilder). Имя класса используется для указания точки входа при регистрации фоновой задачи.

В Windows 10 версии 1607 можно включить фоновую активность, не создавая фоновой задачи. Вместо этого код фоновой задачи можно выполнять прямо внутри процесса приложения переднего плана.

Чтобы быстро приступить к работе с фоновыми задачами, выполняемыми внутри процесса, следуйте инструкциям из раздела [Создание и регистрация фоновой задачи, выполняемой внутри процесса](create-and-register-an-inproc-background-task.md).

Чтобы быстро приступить к работе с фоновыми задачами, выполняемыми вне процесса, следуйте инструкциям из раздела [Создание и регистрация фоновой задачи, выполняемой вне процесса](create-and-register-a-background-task.md).

> [!TIP]
> начиная с Windows 10, вам больше не нужно размещать приложение на экране блокировки в качестве необходимого компонента для регистрации фоновой задачи.

## <a name="background-tasks-for-system-events"></a>Фоновые задачи для системных событий

Ваше приложение может отвечать на события, создаваемые системой, регистрируя фоновую задачу с помощью класса [**SystemTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTrigger). Оно может использовать любые из нижеперечисленных триггеров системных событий (определенных в [**SystemTriggerType**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTriggerType)).

| Имя триггера                     | Описание                                                                                                    |
|----------------------------------|----------------------------------------------------------------------------------------------------------------|
| **интернетаваилабле**            | Появляется доступ к Интернету.                                                                                |
| **NetworkStateChange**           | Происходит изменение сети, такое как изменение стоимости или подключения.                                              |
| **онлинеидконнектедстатечанже** | ИД интернет-службы, связанный с изменением учетной записи.                                                                 |
| **смсрецеивед**                  | Установленным устройством с высокоскоростным мобильным подключением получено новое SMS-сообщение.                                         |
| **тимезонечанже**               | В устройстве изменяется часовой пояс (например, когда система переводит часы на летнее время). |

См. также: [Реагирование на системные события с помощью фоновых задач](respond-to-system-events-with-background-tasks.md).

## <a name="conditions-for-background-tasks"></a>Условия для фоновых задач

Добавив условие, вы сможете контролировать выполнение фоновой задачи даже после ее запуска. При активации фоновая задача не будет выполняться, пока не будут соблюдены все условия. Можно использовать следующие условия (представленные перечислением [**SystemConditionType**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemConditionType)).

| Имя условия           | Описание                       |
|--------------------------|-----------------------------------|
| **интернетаваилабле**    | Интернет должен быть доступен.   |
| **интернетнотаваилабле** | Интернет должен быть недоступен. |
| **сессионконнектед**     | Сеанс должен быть подключен.    |
| **сессиондисконнектед**  | Сеанс должен быть отключен. |
| **усернотпресент**       | Пользователь должен отсутствовать.            |
| **усерпресент**          | Пользователь должен присутствовать.         |

Добавьте условие **InternetAvailable** в фоновую задачу [BackgroundTaskBuilder.AddCondition](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskBuilder) для задержки активации фоновой задачи, пока не заработает сетевой стек. Это условие экономит энергию, так как фоновая задача не будет выполняться, пока сеть недоступна. Это условие не поддерживает активацию в режиме реального времени.

Если ваша фоновая задача требует подключения к сети, задайте условие [IsNetworkRequested](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.BackgroundTaskBuilder), чтобы обеспечить сохранность подключения к сети, пока выполняется фоновая задача. Это указывает инфраструктуре фоновых задач на необходимость поддержания соединения во время выполнения задачи, даже если устройство переходит в режим ожидания с подключением. Если фоновая задача не устанавливает **иснетворкрекуестед**, фоновая задача не сможет получить доступ к сети в режиме ожидания подключения (например, при отключении экрана телефона)  
Дополнительные сведения об условиях выполнения фоновых задач см. в разделе [Указание условий выполнения фоновой задачи](set-conditions-for-running-a-background-task.md).

## <a name="application-manifest-requirements"></a>Требования к манифесту приложения

Перед тем как приложение сможет успешно зарегистрировать фоновую задачу, которая выполняется вне процесса, оно должно быть объявлено в манифесте приложения. Фоновые задачи, которые выполняются в том же процессе, что и приложение, в котором они размещены, не требуется объявлять в манифесте приложения. Узнать больше можно в разделе [Объявление фоновых задач в манифесте приложения](declare-background-tasks-in-the-application-manifest.md).

## <a name="background-tasks"></a>Фоновые задачи

Следующие триггеры реального времени можно использовать для выполнения облегченного пользовательского кода в фоновом режиме.

| Триггер в реальном времени  | Описание |
|--------------------|-------------|
| **Канал управления** | Фоновые задачи могут поддерживать подключение и получать сообщения по каналу управления, используя класс [**ControlChannelTrigger**](https://docs.microsoft.com/uwp/api/Windows.Networking.Sockets.ControlChannelTrigger). Если приложение ожидает передачи данных из сокета, можно использовать посредник сокетов вместо **ControlChannelTrigger**. Узнать больше об использовании посредника сокетов можно в разделе [SocketActivityTrigger](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SocketActivityTrigger). **ControlChannelTrigger** не поддерживается в Windows Phone. |
| **Активности** | Фоновые задачи могут выполняться через каждые 15 минут, и их можно настроить на выполнение в определенное время, используя [**TimeTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.TimeTrigger). См. также: [Запуск фоновой задачи по таймеру](run-a-background-task-on-a-timer-.md). |
| **Push-уведомление** | Фоновые задачи реагируют на [**PushNotificationTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.PushNotificationTrigger), чтобы получать необработанные push-уведомления. |

**Примечание**  

Универсальные приложения для Windows должны вызвать [**RequestAccessAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.requestaccessasync) перед регистрацией любых типов фоновых триггеров.

Чтобы универсальное приложение для Windows продолжало правильно работать после выпуска обновления, необходимо вызвать метод [**RemoveAccess**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.removeaccess), а затем — метод [**RequestAccessAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.requestaccessasync) при запуске приложения после обновления. Дополнительные сведения см. в разделе [Руководство по фоновым задачам](guidelines-for-background-tasks.md).

**Ограничения на количество экземпляров триггера:** существуют ограничения на количество экземпляров некоторых триггеров, которые может зарегистрировать приложение. Приложение может зарегистрировать триггеры [ApplicationTrigger](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.ApplicationTrigger), [MediaProcessingTrigger](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.mediaprocessingtrigger) и [DeviceUseTrigger](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.deviceusetrigger?f=255&MSPPError=-2147217396) только один раз на экземпляр приложения. Если приложение переходит за этот предел, регистрация вызовет исключение.

## <a name="system-event-triggers"></a>Триггеры системных событий

Перечисление [**SystemTriggerType**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTriggerType) представляет следующие триггеры системных событий:

| Имя триггера            | Описание                                                       |
|-------------------------|-------------------------------------------------------------------|
| **усерпресент**         | Фоновая задача запускается в присутствии пользователя.   |
| **усеравай**            | Фоновая задача запускается в отсутствие пользователя.    |
| **контролчаннелресет** | Фоновая задача запускается при сбросе канала управления. |
| **сессионконнектед**    | Фоновая задача запускается при подключенном сеансе.   |

   
Следующие триггеры системных событий сигнализируют о помещении приложения на экран блокировки или удалении приложения с экрана.

| Имя триггера                     | Описание                                  |
|----------------------------------|----------------------------------------------|
| **локкскринаппликатионаддед**   | На экран блокировки добавляется плитка приложения.     |
| **локкскринаппликатионремовед** | С экрана блокировки удаляется плитка приложения. |

 
## <a name="background-task-resource-constraints"></a>Ограничения на ресурсы фоновых задач

Фоновые задачи являются облегченными. Поддержание выполнения в фоновом режиме на минимальном уровне обеспечивает оптимальное взаимодействие с пользователем для приложений переднего плана и времени работы батареи. Для этого на ресурсы фоновых задач накладываются ограничения.

Фоновые задачи ограничены 30 секундами физического времени.

### <a name="memory-constraints"></a>Ограничения на использование памяти

Из-за ограничений на ресурсы для устройств с небольшим объемом памяти фоновые задачи приложений могут иметь ограничение на использование памяти, определяющее максимальный объем памяти, который может использовать фоновая задача. Если фоновая задача попытается выполнить операцию, которая превысит это ограничение, операция завершится ошибкой и может вызвать исключение "Недостаточно памяти", которое задача сможет обработать. Если задача не обрабатывает исключение "Недостаточно памяти" или тип операции не вызывает такое исключение, задача будет немедленно остановлена.  

Вы можете использовать API [**MemoryManager**](https://docs.microsoft.com/uwp/api/Windows.System.MemoryManager), чтобы запросить текущий объем и ограничение используемой памяти, а также чтобы отслеживать использование памяти фоновой задачей.

### <a name="per-device-limit-for-apps-with-background-tasks-for-low-memory-devices"></a>Ограничения «на устройство» для приложений с фоновыми задачами для устройств с небольшим объемом памяти

Для устройств с малым объемом памяти существует ограничение на количество приложений, которые устанавливаются на устройство и используют фоновые задачи одновременно. Если превысить это количество, произойдет сбой вызова [**RequestAccessAsync**](https://docs.microsoft.com/uwp/api/windows.applicationmodel.background.backgroundexecutionmanager.requestaccessasync), необходимого для регистрации всех фоновых задач.

### <a name="battery-saver"></a>Экономия заряда аккумулятора

Если не добавить приложение в список исключений, чтобы оно могло продолжить выполнение фоновых задач и получать push-уведомления при включенной экономии заряда, фоновые задачи не будут запускаться, если устройство не подключено к внешнему источнику питания и заряд аккумулятора становится меньше определенного уровня. Но это не повлияет на возможность регистрации фоновых задач.

Однако для корпоративных приложений и приложений, которые не будут опубликованы в Microsoft Store, см. статью [Запуск в фоновом режиме на неопределенное время](run-in-the-background-indefinetly.md) , чтобы узнать, как использовать возможности фоновой задачи или расширенного сеанса выполнения в фоновом режиме на неопределенное время.

## <a name="background-task-resource-guarantees-for-real-time-communication"></a>Ресурс фоновой задачи гарантирует связь в реальном времени

Чтобы исключить помехи для функций связи в реальном времени из-за выделения квот ресурсов, каждая выполняющаяся фоновая задача, использующая [**ControlChannelTrigger**](https://docs.microsoft.com/uwp/api/Windows.Networking.Sockets.ControlChannelTrigger) и [**PushNotificationTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.PushNotificationTrigger), получает гарантированные объемы ресурсов ЦП. Квоты ресурсов остаются такими, как упоминалось выше, и сохраняются постоянными для этих фоновых задач.

Приложению не нужно специально что-то делать, чтобы получать гарантированные квоты ресурсов для фоновых задач [**ControlChannelTrigger**](https://docs.microsoft.com/uwp/api/Windows.Networking.Sockets.ControlChannelTrigger) и [**PushNotificationTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.PushNotificationTrigger). Система всегда рассматривает их как критически важные фоновые задачи.

## <a name="maintenance-trigger"></a>Триггер обслуживания

Задачи обслуживания выполняются только в том случае, если устройство подключено к сети переменного тока. См. также: [Использование триггера обслуживания](use-a-maintenance-trigger.md).

## <a name="background-tasks-for-sensors-and-devices"></a>Фоновые задачи для датчиков и устройств

Ваше приложение может получать доступ к датчикам и периферийным устройствам из фоновой задачи с помощью класса [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Этот триггер можно использовать для продолжительных операций, таких как синхронизация данных или мониторинг. В отличие от задач для системных событий задачу **DeviceUseTrigger** можно инициировать только во время работы приложения на переднем плане, и для нее невозможно установить какие-либо условия.

> [!IMPORTANT]
> Триггеры **DeviceUseTrigger** и **DeviceServicingTrigger** невозможно использовать с фоновыми задачами, выполняемыми внутри процесса.

Некоторые критические операции с устройством, например длительные обновления встроенного ПО, не могут выполняться с помощью класса [**DeviceUseTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceUseTrigger). Такие операции могут выполняться только на компьютере и только привилегированным приложением, которое использует [**DeviceServicingTrigger**](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.DeviceServicingTrigger). *Привилегированным* называется приложение, которому изготовитель устройства разрешил выполнять эти операции. Метаданные устройства позволяют указать, какое приложение (при его наличии) было назначено в качестве привилегированного приложения на устройстве. Дополнительные сведения см. в [статье синхронизация устройств и обновление для Microsoft Store приложений для устройств](https://msdn.microsoft.com/library/windows/hardware/dn265139(v=vs.85).aspx) .

## <a name="managing-background-tasks"></a>Управление фоновыми задачами

Фоновые задачи могут передавать в приложение сообщения о ходе выполнения, завершении или отмене с помощью событий и локального хранилища. Кроме того, можно перехватывать исключения, поступающие от фоновой задачи, и управлять ее регистрацией в процессе обновления приложения. См. также:

[Обработка отмененной фоновой задачи](handle-a-cancelled-background-task.md)  
[Отслеживание хода выполнения и завершения фоновых задач](monitor-background-task-progress-and-completion.md)

Проверьте регистрацию вашей фоновой задачи во время запуска приложения. Убедитесь, что разгруппированные фоновые задачи вашего приложения присутствуют в BackgroundTaskBuilder.AllTasks. Повторно зарегистрируйте те, которые не отображаются. Отмените регистрацию всех задач, которые больше не нужны. Это гарантирует, что все регистрации фоновых задач являются актуальными при каждом запуске приложения.

## <a name="related-topics"></a>Статьи по теме

**Концептуальное руководство по многозадачной работе в Windows 10**

* [Запуск, возобновление и многозадачность](index.md)

**Связанное руководство по фоновым задачам**

* [Руководство по работе с фоновыми задачами](guidelines-for-background-tasks.md)
* [Доступ к датчикам и устройствам из фоновой задачи](access-sensors-and-devices-from-a-background-task.md)
* [Создание и регистрация фоновой задачи, выполняемой внутри процесса](create-and-register-an-inproc-background-task.md)
* [Создание и регистрация внепроцессной фоновой задачи](create-and-register-a-background-task.md)
* [Преобразование незавершенного фонового задания в фоновую задачу внутри процесса](convert-out-of-process-background-task.md)
* [Отладка фоновой задачи](debug-a-background-task.md)
* [Объявление фоновых задач в манифесте приложения](declare-background-tasks-in-the-application-manifest.md)
* [Регистрация фоновых задач группы](group-background-tasks.md)
* [Обработка отмененной фоновой задачи](handle-a-cancelled-background-task.md)
* [Как активировать события приостановки, возобновления и фоновых событий в приложениях UWP (при отладке)](https://docs.microsoft.com/visualstudio/debugger/how-to-trigger-suspend-resume-and-background-events-for-windows-store-apps-in-visual-studio)
* [Отслеживание хода выполнения и завершения фоновых задач](monitor-background-task-progress-and-completion.md)
* [Воспроизведение мультимедиа в фоновом режиме](https://docs.microsoft.com/windows/uwp/audio-video-camera/background-audio)
* [Регистрация фоновой задачи](register-a-background-task.md)
* [Реагирование на системные события с помощью фоновых задач](respond-to-system-events-with-background-tasks.md)
* [Запуск фоновой задачи по таймеру](run-a-background-task-on-a-timer-.md)
* [Выполнение фоновой задачи при обновлении приложения UWP](run-a-background-task-during-updatetask.md)
* [Выполнение в фоновом режиме в течение неограниченного срока](run-in-the-background-indefinetly.md)
* [Задание условий выполнения фоновой задачи](set-conditions-for-running-a-background-task.md)
* [Активация фоновой задачи из приложения](trigger-background-task-from-app.md)
* [Обновление живой плитки из фоновой задачи](update-a-live-tile-from-a-background-task.md)
* [Использование триггера обслуживания](use-a-maintenance-trigger.md)
