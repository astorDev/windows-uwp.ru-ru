---
title: Запуск фоновой задачи при обновлении приложения UWP
description: Узнайте, как создать фоновую задачу, которая выполняется при обновлении приложения магазина универсальной платформы Windows (UWP).
ms.date: 04/21/2017
ms.topic: article
keywords: Windows 10, uwp, update, фоновая задача, updatetask, фоновой задачи
ms.localizationpriority: medium
ms.openlocfilehash: 8cd7d4494340d1c5e617361f2e3d750b35ebabb9
ms.sourcegitcommit: b034650b684a767274d5d88746faeea373c8e34f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/06/2019
ms.locfileid: "57603529"
---
# <a name="run-a-background-task-when-your-uwp-app-is-updated"></a>Запуск фоновой задачи при обновлении приложения UWP

Узнайте, как записать фоновую задачу, которая выполняется после обновления приложения Магазина универсальной платформы Windows (UWP).

Фоновая задача обновления запускается операционной системой после того, как пользователь устанавливает обновление для приложения, установленного на устройстве. Это позволяет приложению выполнять задачи инициализации, например инициализировать новый канал push-уведомлений, обновить схему базы данных и пр., прежде чем пользователь запустит обновленное приложение.

Задача обновления отличается от запуска фоновой задачи, используя триггер [ServicingComplete](https://docs.microsoft.com/uwp/api/Windows.ApplicationModel.Background.SystemTriggerType), так как в этом случае необходимо однократно запустить ваше приложение по крайней мере до обновления для регистрации фоновой задачи, которая будет активирована триггером **ServicingComplete**.  Задача обновления регистрируется, и таким образом приложение, которое никогда не запускалось, но которое было обновлено, по-прежнему будет иметь триггер задачи обновления.

## <a name="step-1-create-the-background-task-class"></a>Шаг 1. Создайте класс фоновой задачи

Как и другие типы фоновых задач, фоновая задача обновления реализуется в компоненте среды выполнения Windows. Чтобы создать такой компонент, выполните действия из подраздела **Создание класса фоновой задачи** раздела [Создание и регистрация фоновой задачи](https://docs.microsoft.com/windows/uwp/launch-resume/create-and-register-a-background-task). Потребуются следующие действия:

- Добавление проекта компонента среды выполнения Windows в ваше решение.
- Создание ссылки из этого приложения на компонент.
- Создание открытого, запечатанного класса в компоненте, который реализует [**IBackgroundTask**](https://msdn.microsoft.com/library/windows/apps/br224794).
- Реализация метода [**Run**](https://msdn.microsoft.com/library/windows/apps/br224811), который является обязательной точкой входа, которая вызывается при запуске задачи обновления. Если вы собираетесь выполнять асинхронные вызовы из фоновой задачи, в статье [Создание и регистрация внепроцессной фоновой задачи](https://docs.microsoft.com/windows/uwp/launch-resume/create-and-register-a-background-task) объясняется, как использовать задержку в вашем методе **Run**.

Вам не нужно зарегистрировать эту фоновую задачу (в разделе «Зарегистрировать фоновую задачу для запуска» **Создание и регистрация out-of-process фоновую задачу** раздел) для использования задачи обновления. Это основная причина для использования задачу обновления, так как вам не нужно добавлять никакой код в приложение для регистрации задачи, и у приложения нет запуск по крайней мере один раз перед обновлением для регистрации фоновой задачи.

В следующем примере кода показана простая отправная точка для класса фоновой задачи Update Task в C#. Класс фоновой задачи и все остальные классы в фоновой задаче должны быть **открытыми** и **запечатанными** классами. Класс вашей фоновой задачи должен быть производным от **IBackgroundTask** и иметь общее **Run()** метод с подписью, показано ниже:

```cs
using Windows.ApplicationModel.Background;

namespace BackgroundTasks
{
    public sealed class UpdateTask : IBackgroundTask
    {
        public void Run(IBackgroundTaskInstance taskInstance)
        {
            // your app migration/update code here
        }
    }
}
```

## <a name="step-2-declare-your-background-task-in-the-package-manifest"></a>Шаг 2. Объявите вашей фоновой задачи в манифесте пакета

В обозревателе решений Visual Studio щелкните правой кнопкой мыши **Package.appxmanifest** и выберите пункт **Перейти к коду**, чтобы просмотреть манифест пакета. Добавьте следующий `<Extensions>`XML для объявления вашей задачи обновления:

```XML
<Package ...>
    ...
  <Applications>  
    <Application ...>  
        ...
      <Extensions>  
        <Extension Category="windows.updateTask"  EntryPoint="BackgroundTasks.UpdateTask">  
        </Extension>  
      </Extensions>

    </Application>  
  </Applications>  
</Package>
```

Убедитесь, что в приведенном выше XML атрибут `EntryPoint` имеет значение namespace.class имя класса задач обновление. Имя обрабатывается с учетом регистра.

## <a name="step-3-debugtest-your-update-task"></a>Шаг 3. Обновление задачи отладки и тестирования

Убедитесь, что вы развернули ваше приложение на компьютере, чтобы было что-то для обновления.

Установите точку останова в методе Run() фоновой задачи.

![установка точки останова](images/run-func-breakpoint.png)

Далее, в обозревателе решений щелкните правой кнопкой мыши проект приложения (не фоновой задаче) и нажмите кнопку **Свойства**. В окне "Свойства приложения" щелкните **Отладка** слева, а затем выберите **Не запускать, а отлаживать мой код при открытии**:

![задать параметры отладки](images/do-not-launch-but-debug.png)

Затем, чтобы убедиться, что UpdateTask запускается, увеличьте номер версии пакета. В обозревателе решений дважды щелкните ваше приложение **Package.appxmanifest** файла, чтобы открыть конструктор пакетов, а затем обновите номер **Build**:

![обновление версии](images/bump-version.png)

Теперь в Visual Studio 2017 при нажатии клавиши F5 ваше приложение будет обновляться, и система будет активировать компонент UpdateTask в фоновом режиме. Отладчик автоматически назначается фоновый процесс. Ваш останов будет достигнут, и вы можете выполнять свою логику для обновления кода.

Если фоновая задача завершается, можно запустить приложение переднего плана в главном меню Windows в пределах одного и того же сеанса отладки. Отладчик будет автоматически привязан, в этот раз к вашему процессу переднего плана, и вы сможете выполнить посредством логики приложения.

> [!NOTE]
> Пользователи Visual Studio 2015: Описанные выше шаги применяются к Visual Studio 2017. Если вы используете Visual Studio 2015, можно использовать те же методы для вызова и тестирования UpdateTask, за исключением Visual Studio, к которому это не цепляется. Альтернативная процедура в VS 2015 является настройка [ApplicationTrigger](https://docs.microsoft.com/windows/uwp/launch-resume/trigger-background-task-from-app), устанавливающего UpdateTask как точку входа, и вызывает триггер выполнения непосредственно из приложения переднего плана.

## <a name="see-also"></a>См. также

[Создание и регистрация вне процесса фоновой задачи](https://docs.microsoft.com/windows/uwp/launch-resume/create-and-register-a-background-task)
