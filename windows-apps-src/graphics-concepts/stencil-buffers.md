---
title: "Буферы трафаретов"
description: "Буфер трафаретов применяется для маскирования пикселей в изображения, то есть для формирования специальных эффектов."
ms.assetid: 544B3B9E-31E3-41DA-8081-CC3477447E94
keywords:
- "Буферы трафаретов"
author: PeterTurcan
ms.author: pettur
ms.date: 02/08/2017
ms.topic: article
ms.prod: windows
ms.technology: uwp
translationtype: Human Translation
ms.sourcegitcommit: c6b64cff1bbebc8ba69bc6e03d34b69f85e798fc
ms.openlocfilehash: 981d9d25b860d1c168227c9f67537cf033165aac
ms.lasthandoff: 02/07/2017

---

# <a name="stencil-buffers"></a>Буферы трафаретов


*Буфер трафаретов* применяется для маскирования пикселей в изображения, то есть для формирования специальных эффектов. Маска определяет рисуется пиксель или нет. Специальные эффекты включают компоновку, перевод изображений, растворение, затемнение и вытеснение, контуры и силуэты, а также двусторонний трафарет. Некоторые из наиболее распространенных эффектов показаны ниже.

Буфер трафарета включает или отключает отрисовку на целевую поверхность попиксельно. На своем фундаментальном уровне буфер позволяет приложениям маскировать части выводимого изображения так, чтобы они не отображались. Приложения часто используют буферы трафарета для специальных эффектов, таких как рассеивание, наложение декалей и контуров.

Данные буфера трафарета внедряются в данные z-буфера.

## <a name="span-idhowthestencilbufferworksspanspan-idhowthestencilbufferworksspanspan-idhowthestencilbufferworksspanhow-the-stencil-buffer-works"></a><span id="How_the_Stencil_Buffer_Works"></span><span id="how_the_stencil_buffer_works"></span><span id="HOW_THE_STENCIL_BUFFER_WORKS"></span>Как работает буфер трафарета


Direct3D выполняет попиксельный тест содержимого буфера трафарета. Для каждого пикселя на целевой поверхности выполняется тест с использованием соответствующего значения из буфера трафарета, контрольного значения буфера и значения маски буфера. В тестовых проходах Direct3D выполняет действие. Тест проводится в несколько шагов.

1.  Выполняется побитовая операция AND над контрольным значением трафарета и маской трафарета.
2.  Выполняется побитовая операция AND со значением буфера трафарета для текущего пикселя и маской трафарета.
3.  Сравнивается результат 1-го шага с результатом 2-го шага 2 с помощью функции сравнения.

Описанные выше шаги показаны в следующей строчке кода:

```
(StencilRef &amp; StencilMask) CompFunc (StencilBufferValue &amp; StencilMask)
```

-   StencilRef представляет собой контрольное значение трафарета.
-   StencilMask это значение маски трафарета.
-   CompFunc является функции сравнения.
-   StencilBufferValue — это содержимое буфера трафарета для текущего пикселя.
-   Символ амперсанда (&) обозначает побитовую операцию AND.

Текущий пиксель записывается на целевую поверхность, если тест трафаретом пройден, в ином случае пиксель пропускается. Стандартный результат сравнения — записать пиксель, независимо от того как разрешилась каждого побитовая операция. Это поведение можно поменять, изменив значение типа перечисления, тем самым указав нужную функцию сравнения.

Приложение может настроить работу буфера трафарета. Приложение может задать функцию сравнения, маску трафарета и контрольное значение трафарета. Таким же образом задается действие, которое Direct3D выполняет при успешном или неудачном происхождении теста.

## <a name="span-idcompositingspanspan-idcompositingspanspan-idcompositingspancompositing"></a><span id="Compositing"></span><span id="compositing"></span><span id="COMPOSITING"></span>Компоновка


Приложение может использовать буфер трафарета для компоновки двумерных и трехмерных изображений в трехмерной сцене. Маска в буфере трафарета используется, чтобы загородить область целевой поверхности отрисовки. Сохраненные 2D данные, такие как текст или растровые изображения, затем можно записать в загороженную область. Либо же, приложение может отрисовать дополнительные 3D-примитивы в область целевой поверхности, маскированную трафаретом. Оно может вывести даже целую сцену.

В играх часто составляются вместе несколько трехмерных сцен. Например, в играх про вождение обычно отображается заднее зеркало. В зеркале показывается представление трехмерной сцены позади водителя. По сути это вторая 3D-сцена, комбинированная с передним обзором водителя.

## <a name="span-iddecalingspanspan-iddecalingspanspan-iddecalingspandecaling"></a><span id="Decaling"></span><span id="decaling"></span><span id="DECALING"></span>Наложение декалей


Приложения Direct3D применяют этот метод, чтобы контролировать какие пиксели из определенного примитива выводятся на целевую поверхность отрисовки. Приложения применяют декали к изображениям примитивов для корректного отображения копланарных (лежащих в одной плоскости) полигонов.

Например, при нанесении на дорогу следов от шин и линий желтой разметки, эти метки должны отображаться прямо поверх дороги. Однако z-значения меток и дороги одинаковы. Таким образом буфер глубины не может провести четкое разделение между ними. Некоторые пиксели в заднем примитиве могут отрисоваться поверх переднего примитива и наоборот. Итоговое изображение будет мерцать при переключении кадров. Этот эффект называется *z-конфликт* или *мерцание*.

Чтобы решить эту проблему, используйте трафарет для маскировки той области заднего примитива, где будут декали. Отключите z-буферизацию и отрисуйте изображение переднего примитива в маскированную область целевой поверхности отрисовки.

Хоть эту проблему и можно решить наложением нескольких текстур, но такой подход ограничит число других спецэффектов в приложении. Применение буфера трафарета для наложения декалей освобождает этапы наложения текстур для других эффектов.

## <a name="span-iddissolvesfadesandswipesspanspan-iddissolvesfadesandswipesspanspan-iddissolvesfadesandswipesspandissolves-fades-and-swipes"></a><span id="Dissolves__fades__and_swipes"></span><span id="dissolves__fades__and_swipes"></span><span id="DISSOLVES__FADES__AND_SWIPES"></span>Рассеивание, исчезание и скольжение


Все чаще в приложениях применяются специальные эффекты, широко распространенные в фильмах и видеороликах, такие как, рассеивание, скольжение и исчезания.

При эффекте растворения одно изображение постепенно заменяется на другое в ходе плавной смены кадров. Несмотря на то, что в Direct3D есть методы для формирования такого же эффекта с помощью наложения нескольких текстур, приложения, применяющие буфер трафарета для рассеивания, могут задействовать возможности по наложению текстур в других эффектах одновременно с рассеиванием.

Когда приложение выполняет рассеивание, необходимо проводить отрисовку двух разных изображений. В этом случае буфер трафарета применяется для контроля отрисовки пикселей из каждого изображения на целевую поверхность. Вы можете определить серию масок трафарета и копировать их в буфер трафарета по мере поступления кадров. Либо же, вы можете определить базовую маску трафарета для первого кадра и постепенно ее менять.

В начале эффекта рассеивания приложение задает функцию и маску трафарета так, чтобы большая часть пикселей начального изображения проходил тест трафаретом. Большинство пикселей из конечного изображения не должно проходить тест трафаретом. В последующих кадрах маска трафарета обновляется так, чтобы все меньше и меньше пикселей начального изображения проходило тест. В дальнейших кадрах все меньше и меньше пикселей конечного изображения не проходят тест. Таким образом приложение может выполнить рассеивание с любым произвольным узором.

Эффект постепенного появления или исчезновения — это особый случай рассеивания. При постепенном появлении, буфер трафарета используется для рассеивания из черного или белого изображения в отрисовку 3D-сцены. Постепенное исчезновение выполняется наоборот, приложение начинает с отрисовки трехмерной сцены и рассеивает ее в черное или белое изображение. Такой переход можно выполнить с любым желаемым узором.

В приложениях Direct3D используется похожий метод для эффекта скольжения. Например? когда приложение выполняет скольжение слева направо, конечное изображение постепенно накатывается поверх начального изображения в направлении слева направо. Как и в случае рассеивания следует определить серию масок трафарета, которые загружаются в буфер трафарета для последующих кадров, или последовательно менять начальную маску трафарета. Маски трафарета используются для отключения записи пикселей из начального изображения и для включения записи пикселей конечного изображения.

Скольжение как эффект несколько более сложен чем рассеивание, так как приложению нужно считывать пиксели конечного изображения в порядке обратном направлению скольжения. То есть, если скольжение идет слева направо, приложение должно считывать пиксели конечного изображения справа налево.

## <a name="span-idoutlinesandsilhouettesspanspan-idoutlinesandsilhouettesspanspan-idoutlinesandsilhouettesspanoutlines-and-silhouettes"></a><span id="Outlines_and_silhouettes"></span><span id="outlines_and_silhouettes"></span><span id="OUTLINES_AND_SILHOUETTES"></span>Контуры и силуэты


Буфер трафарета можно применять при создании более абстрактных эффектов, таких как выделение контуров и силуэтов.

Если приложение применит к изображению примитива маску трафарета той же формы но чуть меньшего размера, то итоговое изображение будет содержать только контур примитива. Приложение затем может заполнить область изображения, маскированную трафаретом, сплошным цветом, придав примитиву выпуклость.

Если маска трафарета по размеру и форме соответствует выводимому примитиву, полученное изображение будет содержать отверстие на месте примитива. Приложения затем может заполнить отверстие черным цветом для создания силуэта примитива.

## <a name="span-idtwo-sidedstencilspanspan-idtwo-sidedstencilspanspan-idtwo-sidedstencilspantwo-sided-stencil"></a><span id="Two-sided_stencil"></span><span id="two-sided_stencil"></span><span id="TWO-SIDED_STENCIL"></span>Двусторонний трафарет


Для рисования теней с помощью буфера трафарета используются теневые объемы. Приложение вычисляет теневые объемы от загораживающей геометрии, рассчитывая края силуэта и вытягивая в направлении от источника света в набор 3D-объемов. Эти объемы затем дважды отрисовываются в буфере трафарета.

Первый проход рисует полигоны, обращенные вперед, и увеличивают значения буфера трафарета. Второй проход рисует полигоны теневого объема, обращенные назад, и уменьшает значения буфера трафарета. Как правило все увеличенные и уменьшенные значения компенсируют друг друга. Однако сцена уже была отрисована с нормальной геометрией, из-за чего некоторые пиксели не пройдут тест z-буфера при отрисовке теневого объема. Значения, оставшиеся в буфере трафарета соответствуют пикселям, которые находятся в тени. Это оставшееся содержимое буфера трафарета используется как маска, для альфа-наложения большого всего закрывающего черного четырехугольника на сцену. Когда буфер трафарета выступает в качестве маски, результатом будет затемнение пикселей, которые находятся в тени.

Это означает, что геометрия теней рисуется дважды для каждого источника света, таким образом нагружая канал GPU по обработке вершин. Функция двустороннего трафарета была разработана для устранения этой ситуации. В этом подходе есть два набора состояний трафарета (их названия ниже), один набор для каждого треугольника, обращенного вперед, и другой для обращенных назад. Таким образом, на каждый теневой объем от каждого источника света требуется только один проход.

## <a name="span-idrelated-topicsspanrelated-topics"></a><span id="related-topics"></span>Статьи по теме


[Буферы глубины и трафаретов](depth-and-stencil-buffers.md)

 

 





