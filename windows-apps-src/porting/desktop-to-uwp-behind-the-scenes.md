---
author: awkoren
Description: "В этой статье рассматривается, как происходит перенос классических приложений на UWP с помощью Desktop Bridge."
title: "Как работает Desktop Bridge"
translationtype: Human Translation
ms.sourcegitcommit: fe96945759739e9260d0cdfc501e3e59fb915b1e
ms.openlocfilehash: c261f40734ab40475ca3a8e0b7c3bea7b64afacd

---

# Как работает Desktop Bridge

В этой статье рассматривается, как происходит перенос классических приложений на UWP с помощью Desktop Bridge.

Главная задача Desktop Bridge— максимально отделить состояние приложения от состояния системы, в то же время не нарушая совместимость с другими приложениями. Для этого мост помещает приложение в пакет универсальной платформы Windows Platform (UWP), а затем определяет и перенаправляет некоторые изменения, вносимые приложением в файловую систему и реестр во время выполнения.

Преобразованные пакеты приложений представляют собой пригодные для запуска только на компьютере приложения с полным доверием, не виртуализированные и не изолированные. Это позволяет им взаимодействовать с другими приложениями точно так же, как это делают классические приложения.

## Установка 

Пакеты приложения устанавливаются в папку *C:\Program Files\WindowsApps\имя_пакета*; исполняемый файл имеет имя вида *имя_приложение.exe*. Каждая папка пакета содержит манифест (с именем AppxManifest.xml), содержащий специальное пространство имен XML для преобразованных приложений. Внутри этого файла манифеста находится элемент ```<EntryPoint>```, который указывает на приложение с полным доверием. При запуске этого приложения оно выполняется не в контейнере приложения, а как обычно, т.е. как пользователь.

После развертывания пакета файлы помечаются как доступные только для чтения и блокируются операционной системой. Windows не позволяет запускать приложения, если в эти файлы внесены несанкционированные изменения. 

## Файловая система

Чтобы располагать состоянием приложения, мост пытается фиксировать изменения, вносимые приложением в AppData. Все операции записи в папку AppData пользователя (например, *C:\Users\имя_пользователя\AppData*), включая создание, удаление и обновление, при записи копируются в закрытое расположение, отдельное для каждого пользователя и каждого приложения. При этом создается иллюзия того, что преобразованное приложение редактирует настоящую папку AppData, хотя на самом деле изменения вносятся в закрытую копию. Перенаправляя операции записи таким образом, система может отслеживать все изменения, вносимые приложением в файлы. Это позволяет системе очистить эти файлы при удалении приложения, тем самым уменьшая «деградацию» системы и делая процедуру удаления приложения более комфортной для пользователя. 

В дополнение к перенаправлению изменений в AppData мост также динамически объединяет известные папки Windows (System32, Program Files (x86), и т.д.) с соответствующими каталогами в пакете приложения. В корне каждого преобразованного пакета содержится папка с именем «VFS». Все операции чтения каталогов или файлов в каталоге VFS во время выполнения объединяются с их системными эквивалентами. Например, приложение может содержать файл *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86\vc10.dll* в составе пакета приложения, но будет казаться, что этот файл установлен в папку *C:\Windows\System32\vc10.dll*.  Это обеспечивает совместимость с классическими приложениями, которые могут ожидать, что файлы будут находиться не в пакете. 

Операции записи в файлы/папки в преобразованном пакете приложения не допускаются. Операции записи в файлы и папки, которые не входят в пакет, мостом игнорируются и допускаются при условии, что у пользователя есть на них разрешение.

### Типичные операции

В этой краткой справочной таблице приведены типичные операции с файловой системой с указанием того, как они обрабатываются мостом. 

Операция | Результат | Пример
:--- | :--- | :---
Чтение или перечисление известного файла или папки Windows | Динамическое объединение *C:\Program Files\имя_пакета\VFS\известная_папка* с локальным системным эквивалентом. | Операция чтения *C:\Windows\System32* возвращает содержимое *C:\Windows\System32* плюс содержимое *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86*. 
Запись в папке AppData | Копирование при записи в расположение, отдельное для каждого пользователя и каждого приложения. | Папка AppData— это обычно *C:\Users\имя_пользователя\AppData*.  
Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри папки *C:\Program Files\WindowsApps\имя_пакета* не допускаются.
Запись за пределами пакета | Игнорируется мостом. Допускается, если у пользователя есть разрешения. | Операция записи в *C:\Windows\System32\foo.dll* допускается, если пакет не содержит файла *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86\foo.dll* и у пользователя есть разрешения.

### Расположения, соответствующие расположениям в каталоге VFS пакета

В следующей таблице показано, где в системе для приложения создаются оверлеи файлов, поставляемых в составе пакета. Приложение будет считать, что эти файлы находятся в указанных системных расположениях, но на самом деле они будут находиться в перенаправленных расположениях внутри каталога *C:\Program Files\WindowsApps\имя_пакета\VFS*. Расположения FOLDERID происходят от констант [**KNOWNFOLDERID**](https://msdn.microsoft.com/library/windows/desktop/dd378457.aspx).

Системное расположение | Перенаправленное расположение (в [Корневой каталог пакета]\VFS\) | Действительно для следующих архитектур
 :--- | :--- | :---
FOLDERID_SystemX86 | SystemX86 | x86, amd64 
FOLDERID_System | SystemX64 | amd64 
FOLDERID_ProgramFilesX86 | ProgramFilesX86 | x86, amd6 
FOLDERID_ProgramFilesX64 | ProgramFilesX64 | amd64 
FOLDERID_ProgramFilesCommonX86 | ProgramFilesCommonX86 | x86, amd64
FOLDERID_ProgramFilesCommonX64 | ProgramFilesCommonX64 | amd64 
FOLDERID_Windows | Windows | x86, amd64 
FOLDERID_ProgramData | Common AppData | x86, amd64 
FOLDERID_System\catroot | AppVSystem32Catroot | x86, amd64 
FOLDERID_System\catroot2 | AppVSystem32Catroot2 | x86, amd64 
FOLDERID_System\drivers\etc | AppVSystem32DriversEtc | x86, amd64 
FOLDERID_System\driverstore | AppVSystem32Driverstore | x86, amd64 
FOLDERID_System\logfiles | AppVSystem32Logfiles | x86, amd64 
FOLDERID_System\spool | AppVSystem32Spool | x86, amd64 

## Реестр

Мост работает с реестром аналогично тому, как он работает с файловой системой. Преобразованные пакеты приложений содержат файл registry.dat, который выступает в качестве логического эквивалента куста *HKLM\Software* в реальном реестре. Во время выполнения этот виртуальный реестр объединяет содержимое этого куста с собственным кустом системы, чтобы обеспечить их единообразное представление. Например, если registry.dat содержит только раздел «Foo», при чтении куста *HKLM\Software* во время выполнения создастся впечатление, что этот куст также содержит раздел «Foo» (в дополнение ко всем собственным разделам системы). 

В состав пакета входят только разделы внутри куста *HKLM\Software*; разделы внутри куста *HKCU* или другие составляющие реестра к пакету не относятся. Операции записи в разделы или значения в пакете не допускаются. Операции записи в разделы или значения, которые не входят в пакет, мостом игнорируются и допускаются, если у пользователя есть на них разрешение.

Все операции записи внутри куста HKCU копируются при записи в расположение, отдельное для каждого пользователя и каждого приложения. Это обеспечивает те же преимущества, связанные с очисткой при удалении приложения, что и аналогичная обработка мостом операций записи в файловую систему. Как правило, при удалении приложения не удается очистить раздел *HKEY_CURRENT_USER*, потому что данные реестра для вышедших из системы пользователей размонтированы и недоступны. 

Результаты всех операций записи сохраняются при обновлении пакета, и удаляются только при полном удалении приложения. 

### Типичные операции

В этой краткой справочной таблице приведены типичные операции с реестром с указанием того, как они обрабатываются мостом. 

Операция | Результат | Пример
:--- | :--- | :---
Чтение или перечисление куста *HKLM\Software* | Динамическое объединение куста пакета с локальным системным эквивалентом. | Например, если registry.dat содержит только раздел «Foo», операция чтения куста *HKLM\Software* во время выполнения возвратит содержимое и *HKLM\Software*, и *HKLM\Software\Foo*. 
Запись внутри куста HKCU | Копирование при записи в закрытое расположение, отдельное для каждого пользователя и каждого приложения. | (Аналогично AppData для файлов.) 
Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри куста *HKLM\Software* не допускаются, если в кусте пакета существует соответствующая пара «раздел-значение».
Запись за пределами пакета | Игнорируется мостом. Допускается, если у пользователя есть разрешения. | Операции записи внутри куста *HKLM\Software* допускаются при условии, что в кусте пакета нет соответствующей пары «раздел-значение», и что у пользователя есть соответствующие разрешения на доступ.

## Удаление 

При удалении пакета пользователем все файлы и папки, расположенные в папке *C:\Program Files\WindowsApps\имя_пакета*, удаляются, вместе с результатами всех перенаправленных операций записи в папку AppData или реестра, зафиксированных мостом. 



<!--HONumber=Nov16_HO1-->


