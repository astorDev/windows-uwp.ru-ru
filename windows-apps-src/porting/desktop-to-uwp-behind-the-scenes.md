---
author: normesta
Description: This article provides a deeper dive on how the Desktop Bridge works under the covers.
title: Как устроен мост для классических приложений
ms.author: normesta
ms.date: 05/25/2017
ms.topic: article
keywords: windows 10, uwp
ms.assetid: a399fae9-122c-46c4-a1dc-a1a241e5547a
ms.localizationpriority: medium
ms.openlocfilehash: 2ff5cd40cad43a73a8ba51a25710e2f2cbaf2a7b
ms.sourcegitcommit: e38b334edb82bf2b1474ba686990f4299b8f59c7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/15/2018
ms.locfileid: "6849870"
---
# <a name="behind-the-scenes-of-your-packaged-desktop-application"></a>Незаметно упакованного классического приложения

В этой статье подробно внутренняя на что происходит с файлы и параметры реестра, при создании пакета приложения для Windows для классического приложения.

Главная задача современных пакетов — отделить состояние приложения от состояния системы максимально при этом сохраняя совместимость с другими приложениями. Для этого мост помещает приложение в пакет универсальной платформы Windows Platform (UWP), а затем определяет и перенаправляет некоторые изменения, вносимые приложением в файловую систему и реестр во время выполнения.

Пакеты, создаваемые вами для классического приложения представляют собой пригодные для запуска только с полным доверием, не и виртуализированных или изолированного. Это позволяет им взаимодействовать с другими приложениями точно так же, как это делают классические приложения.

## <a name="installation"></a>Установка

Пакеты приложения устанавливаются в папку *C:\Program Files\WindowsApps\имя_пакета*; исполняемый файл имеет имя вида *имя_приложение.exe*. Каждая папка пакета содержит манифест (с именем AppxManifest.xml), содержащий специальное пространство имен XML для упакованных приложений. Внутри этого файла манифеста находится элемент ```<EntryPoint>```, который указывает на приложение с полным доверием. При запуске этого приложения, не запускается в контейнере приложения, но вместо этого он выполняется как пользователь, как обычно.

После развертывания пакета файлы помечаются как доступные только для чтения и блокируются операционной системой. Windows не позволяет запускать приложения, если в эти файлы внесены несанкционированные изменения.

## <a name="file-system"></a>Файловая система

Чтобы располагать состоянием приложения, изменения вносит приложение AppData регистрируются. Все операции записи в папку AppData пользователя (например, *C:\Users\имя_пользователя\AppData*), включая создание, удаление и обновление, при записи копируются в закрытое расположение, отдельное для каждого пользователя и каждого приложения. Это создает впечатление, что упакованное приложение редактирует реальных AppData при самом деле изменения закрытую копию. Перенаправляя операции записи таким образом, система может отслеживать все изменения, вносимые приложением в файлы. Это позволяет системе очистить эти файлы при удалении приложения, тем самым уменьшая «деградацию системы» и удаления приложения более комфортной для пользователя.

В дополнение к перенаправлению изменений в AppData известные папки Windows (System32, Program Files (x86), и т. д) динамически объединяются с соответствующими каталогами в пакете приложения. В корне каждого пакета содержится папка с именем VFS. Все операции чтения каталогов или файлов в каталоге VFS во время выполнения объединяются с их системными эквивалентами. Например приложение может содержать *C:\Program Files\WindowsApps\package_name\VFS\SystemX86\vc10.dll* как часть пакета приложения, но файл будет выглядеть установлен в *C:\Windows\System32\vc10.dll*.  Это обеспечивает совместимость с классическими приложениями, которые могут ожидать, что файлы будут находиться не в пакете.

Операции записи в файлы и папки в пакете приложения не допускаются. Операции записи в файлы и папки, которые не входят в пакет, мостом игнорируются и допускаются при условии, что у пользователя есть на них разрешение.

### <a name="common-operations"></a>Типичные операции

В этой краткой справочной таблице приведены типичные операции с файловой системой с указанием того, как они обрабатываются мостом.

Операция | Результат | Пример
:--- | :--- | :---
Чтение или перечисление известного файла или папки Windows | Динамическое объединение *C:\Program Files\имя_пакета\VFS\известная_папка* с локальным системным эквивалентом. | Операция чтения *C:\Windows\System32* возвращает содержимое *C:\Windows\System32* плюс содержимое *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86*.
Запись в папке AppData | Копирование при записи в расположение, отдельное для каждого пользователя и каждого приложения. | Папка AppData— это обычно *C:\Users\имя_пользователя\AppData*.  
Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри папки *C:\Program Files\WindowsApps\имя_пакета* не допускаются.
Запись за пределами пакета | Допускается, если у пользователя есть разрешения. | Операция записи в *C:\Windows\System32\foo.dll* допускается, если пакет не содержит файла *C:\Program Files\WindowsApps\имя_пакета\VFS\SystemX86\foo.dll* и у пользователя есть разрешения.

### <a name="packaged-vfs-locations"></a>Расположения, соответствующие расположениям в каталоге VFS пакета

В следующей таблице показано, где в системе для приложения создаются оверлеи файлов, поставляемых в составе пакета. Ваше приложение будет считать, что эти файлы находятся в указанных системных расположениях, на самом деле они находятся в перенаправленных расположениях внутри *C:\Program Files\WindowsApps\package_name\VFS*. Расположения FOLDERID происходят от констант [**KNOWNFOLDERID**](https://msdn.microsoft.com/library/windows/desktop/dd378457.aspx).

Системное расположение | Перенаправленное расположение (в [Корневой каталог пакета]\VFS\) | Действительно для следующих архитектур
 :--- | :--- | :---
FOLDERID_SystemX86 | SystemX86 | x86, amd64
FOLDERID_System | SystemX64 | amd64
FOLDERID_ProgramFilesX86 | ProgramFilesX86 | x86, amd6
FOLDERID_ProgramFilesX64 | ProgramFilesX64 | amd64
FOLDERID_ProgramFilesCommonX86 | ProgramFilesCommonX86 | x86, amd64
FOLDERID_ProgramFilesCommonX64 | ProgramFilesCommonX64 | amd64
FOLDERID_Windows | Windows | x86, amd64
FOLDERID_ProgramData | Common AppData | x86, amd64
FOLDERID_System\catroot | AppVSystem32Catroot | x86, amd64
FOLDERID_System\catroot2 | AppVSystem32Catroot2 | x86, amd64
FOLDERID_System\drivers\etc | AppVSystem32DriversEtc | x86, amd64
FOLDERID_System\driverstore | AppVSystem32Driverstore | x86, amd64
FOLDERID_System\logfiles | AppVSystem32Logfiles | x86, amd64
FOLDERID_System\spool | AppVSystem32Spool | x86, amd64

## <a name="registry"></a>Реестр

Пакеты приложений содержат файл registry.dat, который выступает в качестве логического эквивалента куста *HKLM\Software* в реальном реестре. Во время выполнения этот виртуальный реестр объединяет содержимое этого куста с собственным кустом системы, чтобы обеспечить их единообразное представление. Например, если registry.dat содержит только раздел «Foo», при чтении куста *HKLM\Software* во время выполнения создастся впечатление, что этот куст также содержит раздел «Foo» (в дополнение ко всем собственным разделам системы).

В состав пакета входят только разделы внутри куста *HKLM\Software*; разделы внутри куста *HKCU* или другие составляющие реестра к пакету не относятся. Операции записи в разделы или значения в пакете не допускаются. Операции записи в разделы или значения не входят в пакет разрешены до тех пор, пока пользователь имеет разрешение.

Все операции записи внутри куста HKCU копируются при записи в расположение, отдельное для каждого пользователя и каждого приложения. Как правило, при удалении приложения не удается очистить раздел *HKEY_CURRENT_USER*, потому что данные реестра для вышедших из системы пользователей размонтированы и недоступны.

Все операции записи сохраняются при обновлении пакета и удаляются только при полном удалении приложения.

### <a name="common-operations"></a>Типичные операции

В этой краткой справочной таблице приведены типичные операции с реестром с указанием того, как они обрабатываются мостом.

Операция | Результат | Пример
:--- | :--- | :---
Чтение или перечисление куста *HKLM\Software* | Динамическое объединение куста пакета с локальным системным эквивалентом. | Например, если registry.dat содержит только раздел «Foo», операция чтения куста *HKLM\Software* во время выполнения возвратит содержимое и *HKLM\Software*, и *HKLM\Software\Foo*.
Запись внутри куста HKCU | Копирование при записи в закрытое расположение, отдельное для каждого пользователя и каждого приложения. | (Аналогично AppData для файлов.)
Запись внутри пакета | Не допускается. Пакет доступен только для чтения. | Операции записи внутри куста *HKLM\Software* не допускаются, если в кусте пакета существует соответствующая пара «раздел-значение».
Запись за пределами пакета | Игнорируется мостом. Допускается, если у пользователя есть разрешения. | Операции записи внутри куста *HKLM\Software* допускаются при условии, что в кусте пакета нет соответствующей пары «раздел-значение», и что у пользователя есть соответствующие разрешения на доступ.

## <a name="uninstallation"></a>Удаление

При удалении пакета пользователем все файлы и папки, расположенные в папке *C:\Program Files\WindowsApps\package_name* , удаляются, а также всех перенаправленных операций записи в папку AppData или реестра, зафиксированных в процессе упаковки.

## <a name="next-steps"></a>Дальнейшие действия

**Поиск ответов на вопросы**

Есть вопросы? Задайте их на Stack Overflow. Наша команда следит за этими [тегами](http://stackoverflow.com/questions/tagged/project-centennial+or+desktop-bridge). Вы также можете задать нам вопросы [здесь](https://social.msdn.microsoft.com/Forums/en-US/home?filter=alltypes&sort=relevancedesc&searchTerm=%5BDesktop%20Converter%5D).

**Оставьте отзыв или предложите новые возможности для реализации**

См. раздел [UserVoice](https://wpdev.uservoice.com/forums/110705-universal-windows-platform/category/161895-desktop-bridge-centennial)
