---
author: mcleanbyron
Description: "Независимо от того, является ли ваше приложение бесплатным или нет, вы можете продавать содержимое, другие приложения или новые функциональные возможности (например, разблокирование следующего уровня игры) прямо из приложения. В этом разделе рассказывается о том, как разрешить такие покупки."
title: "Поддержка покупок внутренних продуктов приложения"
ms.assetid: D158E9EB-1907-4173-9889-66507957BD6B
keywords: "Пример кода продажи из приложения"
translationtype: Human Translation
ms.sourcegitcommit: ffda100344b1264c18b93f096d8061570dd8edee
ms.openlocfilehash: 1cd748cd1b6ca7e85cfb86daba367540af25db88

---

# <a name="enable-in-app-product-purchases"></a>Поддержка покупок внутренних продуктов приложения

>**Примечание.**&nbsp;&nbsp;В этой статье показано, как использовать члены пространства имен [Windows.ApplicationModel.Store](https://msdn.microsoft.com/library/windows/apps/windows.applicationmodel.store.aspx). Если приложение предназначено для Windows 10 версии 1607 или более поздней, для управления надстройками (также называемыми внутренними продуктами приложения или IAP) рекомендуется использовать члены пространства имен [Windows.Services.Store](https://msdn.microsoft.com/library/windows/apps/windows.services.store.aspx), а не пространство имен **Windows.ApplicationModel.Store**. Подробнее см. в разделе [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md).

Независимо от того, является ли ваше приложение бесплатным или нет, вы можете продавать содержимое, другие приложения или новые функциональные возможности (например, разблокирование следующего уровня игры) прямо из приложения. В этом разделе рассказывается о том, как разрешить такие покупки.

> **Примечание.**&nbsp;&nbsp;Внутренние продукты приложения не могут предлагаться в пробной версии. Пользователи пробной версии приложения смогут купить внутренний продукт приложения, только если приобретут полную версию этого приложения.

## <a name="prerequisites"></a>Необходимые условия

-   Приложение для Windows, в которое предполагается добавить компоненты для продажи.
-   Когда вы создадите код для продаж внутренних продуктов приложения и будете проверять его в первый раз, используйте объект [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766) вместо объекта [CurrentApp](https://msdn.microsoft.com/library/windows/apps/hh779765). В этом случае вы сможете проверить логику лицензирования путем имитации обращения к серверу лицензирования вместо вызова реального сервера. Для этого необходимо изменить файл с именем WindowsStoreProxy.xml в папке %userprofile%\\AppData\\local\\packages\\&lt;имя пакета&gt;\\LocalState\\Microsoft\\Windows Store\\ApiData. Имитатор Microsoft Visual Studio создает этот файл при первом запуске приложения. Также можно загрузить собственный его вариант во время выполнения. Дополнительные сведения см. в разделе [Использование файла WindowsStoreProxy.xml с CurrentAppSimulator](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md#proxy).
-   В этом разделе также приведены ссылки на примеры кода из статьи [Пример для Магазина](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store). Этот пример дает отличную возможность поэкспериментировать с разными способами оплаты, доступными для приложений универсальной платформы Windows (UWP).

## <a name="step-1-initialize-the-license-info-for-your-app"></a>Шаг 1. Инициализация сведений о лицензии для приложения

Во время инициализации приложения получите для него объект [LicenseInformation](https://msdn.microsoft.com/library/windows/apps/br225157) путем инициализации [CurrentApp](https://msdn.microsoft.com/library/windows/apps/hh779765) или [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766), чтобы включить покупки внутренних продуктов приложения.

> [!div class="tabbedCodeSnippets"]
[!code-cs[EnableInAppPurchases](./code/InAppPurchasesAndLicenses/cs/EnableInAppPurchases.cs#InitializeLicenseTest)]

## <a name="step-2-add-the-in-app-offers-to-your-app"></a>Шаг 2. Добавление в приложение функции продажи из приложения

Для каждого компонента, доступ к которому будет открываться после его покупки как внутреннего продукта приложения, реализуйте функцию продажи и добавьте ее в свое приложение.

> **Важно!**&nbsp;&nbsp;В приложение необходимо добавить все внутренние продукты приложения, предназначенные для продажи клиентам, до отправки в Магазин. Если потом вы захотите добавить новые продукты из приложения, вам придется обновить приложение и отправить в Магазин новую версию.

1.  **Создание маркера продажи из приложения**

    Вы определяете каждый внутренний продукт приложения в своем приложении по маркеру. Маркер — это строка, которую вы определяете и используете в своем приложении и в Магазине для идентификации определенного продукта из приложения. Присвойте маркеру имя, понятное и уникальное для вашего приложения, чтобы быстро определять, какой компонент он представляет, при написании кода. Вот несколько примеров имен:

    -   "SpaceMissionLevel4"

    -   "ContosoCloudSave"

    -   "RainbowThemePack"

2.  **Помещение кода компонента в условный блок**

    Код компонента, связанного с внутренним продуктом приложения, необходимо поместить в условный блок, который проверяет наличие у пользователя лицензии на использование этого компонента.

    Вот пример кода для возможности продукта под названием **featureName** в условном блоке лицензирования. Строка **featureName** — это маркер, однозначно определяющий этот продукт в приложении и в Магазине.

    > [!div class="tabbedCodeSnippets"]
    [!code-cs[EnableInAppPurchases](./code/InAppPurchasesAndLicenses/cs/EnableInAppPurchases.cs#CodeFeature)]

3.  **Добавление пользовательского интерфейса покупки для данного компонента**

    В приложении вам также следует реализовать возможность покупки продукта или компонента, предлагаемого для продукта из приложения. Пользователи не могут приобрести их через Магазин, как приобрели само приложение.

    В следующем примере показано, как проверить, есть ли у пользователя продукт, предлагаемый для продажи из приложения, и если нет, отобразить диалоговое окно покупки. Замените комментарий "показать диалоговое окно покупки" своим кодом для вызова диалогового окна (например, страницы с понятной кнопкой "Купить это приложение") .

    > [!div class="tabbedCodeSnippets"]
    [!code-cs[EnableInAppPurchases](./code/InAppPurchasesAndLicenses/cs/EnableInAppPurchases.cs#BuyFeature)]

## <a name="step-3-change-the-test-code-to-the-final-calls"></a>Шаг 3. Замена тестового кода окончательной версией

Это просто: замените в коде приложения все ссылки на [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766) ссылками на [CurrentApp](https://msdn.microsoft.com/library/windows/apps/hh779765). Файл WindowsStoreProxy.xml больше не нужен, поэтому удалите его из пути приложения (хотя его можно сохранить для справки до следующего этапа настройки продажи из приложения).

## <a name="step-4-configure-the-in-app-product-offer-in-the-store"></a>Шаг 4. Настройте продажу продукта из приложения в Магазине

На информационной панели Центра разработки укажите код продукта, тип, цену и другие свойства внутреннего продукта приложения. Убедитесь, что настройка идентична выполненной в WindowsStoreProxy.xml настройке при тестировании. Подробнее: [Сообщения IAP](https://msdn.microsoft.com/library/windows/apps/mt148551).

## <a name="remarks"></a>Примечания

Если вы хотите предоставить пользователям возможность покупать потребляемые товары из приложения (элементы, которые можно приобрести, использовать, а затем по желанию приобрести еще раз), перейдите к разделу [Поддержка покупок потребляемых внутренних продуктов приложения](enable-consumable-in-app-product-purchases.md).

Если вам нужны квитанции для подтверждения совершения пользователем покупки из приложения, ознакомьтесь с разделом [Проверка покупок продуктов с помощью квитанций](use-receipts-to-verify-product-purchases.md).

## <a name="related-topics"></a>Связанные разделы


* [Поддержка покупок потребляемых внутренних продуктов приложения](enable-consumable-in-app-product-purchases.md)
* [Управление большим каталогом внутренних продуктов приложения](manage-a-large-catalog-of-in-app-products.md)
* [Проверка покупок продуктов с помощью квитанций](use-receipts-to-verify-product-purchases.md)
* [Пример для Магазина (демонстрация пробных версий и покупок из приложения)](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store)



<!--HONumber=Dec16_HO1-->


