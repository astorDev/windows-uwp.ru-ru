---
author: mcleanbyron
ms.assetid: B071F6BC-49D3-4E74-98EA-0461A1A55EFB
description: "Если у вас имеется каталог приложений и внутренних продуктов приложения (IAP), с помощью API коллекции Магазина Windows и API покупок в Магазине Windows вы можете получить доступ к информации о принадлежности этих продуктов из ваших служб."
title: "Просмотр и предоставление продуктов из службы"
ms.sourcegitcommit: 204bace243fb082d3ca3b4259982d457f9c533da
ms.openlocfilehash: 1e17703442ce539de941890a0616fc5e08391d70

---

# Просмотр и предоставление продуктов из службы


\[ Обновлено для приложений UWP в Windows10. Статьи о Windows8.x см. в [архиве](http://go.microsoft.com/fwlink/p/?linkid=619132) \]


Если у вас имеется каталог приложений и внутренних продуктов приложения (IAP), с помощью *API коллекции Магазина Windows* и *API покупок в Магазине Windows* вы можете получить доступ к информации о принадлежности этих продуктов из ваших служб.

Эти API состоят из методов REST, предназначенных для использования разработчиками с каталогами IAP, которые поддерживаются кроссплатформенными службами. Эти API позволяют выполнять следующие действия.

-   API коллекции Магазина Windows: запрос приложений и IAP, принадлежащих определенному пользователю или отчет о потребляемом продукте как о выполненном.
-   API покупок в Магазине Windows: предоставление бесплатного приложения или IAP определенному пользователю.

## Работа с API коллекции Магазина Windows и API покупок в Магазине Windows


Для получения доступа к информации о принадлежности API коллекции Магазина Windows и API покупок в Магазине Windows используют проверку подлинности Azure Active Directory (Azure AD). Перед вызовом этих API на информационной панели центра разработки для Windows необходимо применить некоторые метаданные Azure AD к вашему приложению и сгенерировать несколько необходимых маркеров доступа и ключей. Далее описан весь процесс.

1.  
            [Настройте веб-приложение в Azure AD](#step-1:-configure-a-web-application-in-azure-ad). Это приложение представляет ваши кросс-платформенные службы в контексте Azure AD.
2.  
            [Привяжите свой идентификатор клиента Azure AD к своему приложению на информационной панели Центра разработки для Windows](#step-2:-associate-your-azure-ad-client-id-with-your-application-in-the-windows-dev-denter-dashboard).
3.  В своей службе [создайте маркеры доступа Azure AD](#step-3:-retrieve-access-tokens-from-azure-ad), представляющие ваше удостоверение издателя.
4.  В клиентском коде в приложении для Windows [создайте ключ идентификатора Магазина Windows](#step-4:-generate-a-windows-store-id-key-from-client-side-code-in-your-app), который представляет удостоверение текущего пользователя, и передайте этот ключ идентификатора Магазина Windows обратно в службу.
5.  После получения требуемого маркера доступа Azure AD и ключа идентификатора Магазина Windows [вызовите API коллекции Магазина Windows или API покупок в Магазине Windows из своей службы](#step-5:-call-the-windows-store-collection-api-or-purchase-api-from-your-service).

Эти действия более подробно описаны в следующих разделах.

### Шаг 1. Настройка веб-приложения в Azure AD.

1.  Чтобы добавить веб-приложение в Azure AD, следуйте инструкциям в статье [Интеграция приложений с Azure Active Directory](http://go.microsoft.com/fwlink/?LinkId=722502).

    > 
            **Примечание.**  На странице **Расскажите о своем приложении** следует выбрать вариант **Веб-приложение и веб-API**. Это необходимо для получения ключа (также называемого *секретом клиента*) для приложения. В последнем шаге для вызова API коллекции Магазина Windows или API покупок в Магазине Windows необходимо предоставить секрет клиента при запросе маркера доступа от Azure AD.

2.  На [портале управления Azure](http://manage.windowsazure.com/) перейдите в раздел **Active Directory**. Выберите каталог, откройте вкладку **Приложения** в верхней части экрана, а затем выберите приложение.
3.  Откройте вкладку **Настройка**. На этой вкладке получите идентификатора клиента для своего приложения и запросите ключ (в последующих шагах он называется *секретом клиента*).
4.  В нижней части экрана щелкните **Управление манифестом**. Скачайте манифест приложения Azure AD и замените раздел `"identifierUris"` следующим текстом.

    ```json
    "identifierUris" : [                                
            "https://onestore.microsoft.com",
            "https://onestore.microsoft.com/b2b/keys/create/collections",
            "https://onestore.microsoft.com/b2b/keys/create/purchase"
        ],
    ```

    В этих строках указывается аудитория, на которую рассчитано ваше приложение. Далее вы создадите маркеры доступа Azure AD, связанные с каждым из этих значений аудитории. Дополнительную информацию о том, как скачать манифест приложения, см. в статье [Основные сведения о манифесте приложения Azure Active Directory]( http://go.microsoft.com/fwlink/?LinkId=722500).

5.  Сохраните манифест, а затем добавьте его в свое приложение на [портале управления Azure](http://manage.windowsazure.com/).

### Шаг 2. Привязка идентификатора клиента Azure AD к приложением в информационной панели центра разработки для Windows.

API коллекции Магазина Windows и API покупок в Магазине Windows предоставляют доступ только к информации о принадлежности приложения и внутренних продуктов приложения, которые связаны с вашим идентификатором клиента Azure AD.

1.  Выполните вход в [информационную панель Центра разработки для Windows](https://dev.windows.com/overview) и выберите свое приложение.
2.  Перейдите на страницу **Службы**&gt;**Коллекции продуктов и покупки** и введите идентификатор клиента Azure AD в одно из доступных полей.

### Шаг 3. Получение маркера доступа из Azure AD.

Перед получением ключа идентификатора Магазина Windows или перед вызовом API коллекции Магазина Windows или API покупок в Магазине Windows необходимо сначала запросить три маркера доступа Azure AD, являющихся вашим удостоверением издателя. Каждый из этих маркеров доступа связан с отдельным URI аудитории и используется в отдельном вызове API. Срок действия каждого маркера составляет 60минут. После истечения срока действия их можно обновить.

Для создания маркеров доступа используйте OAuth 2.0 API в службе, следуя инструкциям из раздела [Вызовы для связи между службами с помощью учетных данных клиентов](https://msdn.microsoft.com/library/azure/dn645543.aspx). Для каждого маркера укажите следующие параметры.

-   Для параметров *client\_id* и *client\_secret* укажите идентификатор клиента и секрет клиента для вашего приложения, полученные на [портале управления Azure](http://manage.windowsazure.com/). Оба этих параметра нужны для создания маркера доступа с уровнем проверки подлинности, необходимым для API коллекции Магазина Windows или API покупок в Магазине Windows.
-   Для параметра *resource* укажите один из следующих URI идентификатора приложения (это те же самые URI, которые вы ранее добавили в раздел `"identifierUris"` манифеста приложения). В конце этой процедуры вы получите три маркера доступа, с каждым из которых связан один из этих URI идентификатора приложения.
    -   `https://onestore.microsoft.com/b2b/keys/create/collections`: на последующем этапе необходимо использовать маркер доступа, созданный с помощью этого URI, для запроса ключа идентификатора Магазина Windows, который можно использовать с API коллекции Магазина Windows.
    -   `https://onestore.microsoft.com/b2b/keys/create/purchase`: на последующем этапе необходимо использовать маркер доступа, созданный с помощью этого URI, для запроса ключа идентификатора Магазина Windows, который можно использовать с API покупок в Магазине Windows.
    -   `https://onestore.microsoft.com`: на последующем этапе необходимо использовать маркер доступа, созданный с помощью этого URI, в прямых вызовах API коллекции Магазина Windows или API покупок в Магазине Windows.

    > 
            **Важно!** Используйте аудиторию `https://onestore.microsoft.com` только с маркерами доступа, которые хранятся безопасно в рамках службы. Использование маркеров доступа для этой аудитории за пределами вашей службы может сделать ее уязвимой для атак с повторением пакетов.

Дополнительную информацию о структуре маркера доступа см. в статье [Поддерживаемые токены и типы утверждений](http://go.microsoft.com/fwlink/?LinkId=722501).

> 
            **Внимание!**  Необходимо создавать маркеры доступа Azure AD только в контексте службы, а не в приложении. При отправке секрета клиента в приложение этот секрет может быть скомпрометирован.

### Шаг 4. Создание ключа идентификатора Магазина Windows в клиентском коде приложения

Прежде чем вызывать API коллекции Магазина Windows или API покупок в Магазине Windows, служба должна получить ключ идентификатора Магазина Windows. Это веб-токен JSON (JWT), который представляет удостоверение пользователя— владельца продукта, доступ к данным о котором вы хотите получить. Подробнее об утверждениях в этом ключе см. в статье [Утверждения в ключе идентификатора Магазина Windows](#windowsstorekey).

На данный момент единственным способом получить ключ идентификатора Магазина Windows является вызов API платформы универсальных приложений для Windows (UWP) из клиентского кода в приложении для получения идентификатора пользователя, вошедшего в Магазин Windows. Генерация ключа идентификатора Магазина Windows

1.  Передайте один из следующих маркеров доступа из вашей службы в клиентское приложение.
    -   Чтобы получить ключ идентификатора Магазина Windows, который можно использовать с API коллекции Магазина Windows, передайте маркер доступа Azure AD, созданный с помощью URI аудитории `https://onestore.microsoft.com/b2b/keys/create/collections`.
    -   Чтобы получить ключ идентификатора Магазина Windows, который можно использовать с API покупок в Магазине Windows, передайте маркер доступа Azure AD, созданный с помощью URI аудитории `https://onestore.microsoft.com/b2b/keys/create/purchase`.

2.  Чтобы получить ключ идентификатора Магазина Windows, в коде приложения вызовите один из следующих методов класса [**CurrentApp**](https://msdn.microsoft.com/library/windows/apps/hh779765).

    -   
            [
              **GetCustomerCollectionsIdAsync**
            ](https://msdn.microsoft.com/library/windows/apps/mt608674): вызовите этот метод, если вы планируете использовать API коллекции Магазина Windows.
    -   
            [
              **GetCustomerPurchaseIdAsync**
            ](https://msdn.microsoft.com/library/windows/apps/mt608675): вызовите этот метод, если вы планируете использовать API покупок Магазина Windows.

    Для любого их этих методов передайте маркер доступа Azure AD параметру *serviceTicket*. При желании можно передать идентификатор параметру *publisherUserId*, который определяет текущего пользователя в контексте служб. Если вы используете идентификаторы пользователей для своих служб, можно использовать этот параметр, чтобы соотнести эти идентификаторы с вызовами API коллекции Магазина Windows или API покупок в Магазине Windows.

3.  После того как приложение успешно получит ключ идентификатора Магазина Windows, передайте этот ключ своей службе.

> 
            **Примечание.**  Каждый ключ идентификатора Магазина Windows действителен в течение 90дней. После истечения срока действия ключа можно [обновить его](renew-a-windows-store-id-key.md). Рекомендуется обновлять ключи идентификаторов Магазина Windows, а не создавать новые.

### Шаг 5. Вызов API коллекции Магазина Windows или API покупок в Магазине Windows из службы.

После того как служба получит ключ идентификатора Магазина Windows, который позволит ей получать доступ к информации о принадлежности продукта определенного пользователя, она сможет вызывать API коллекции Магазина Windows или API покупок в Магазине Windows из службы. Используйте инструкции, соответствующие вашему сценарию.

-   [Запрос продуктов](query-for-products.md)
-   [Объявление потребляемого продукта в качестве выполненного](report-consumable-products-as-fulfilled.md)
-   [Предоставление бесплатных продуктов](grant-free-products.md)

Для каждого сценария передайте API-интерфейсу следующие данные.

-   Маркер доступа Azure AD, созданный ранее с помощью URI аудитории `https://onestore.microsoft.com`. Этот маркер представляет ваше удостоверение издателя. Передайте этот маркер в заголовке запроса.
-   Ключ идентификатора Магазина Windows, полученный в приложении от [**GetCustomerCollectionsIdAsync**](https://msdn.microsoft.com/library/windows/apps/mt608674) или [**GetCustomerPurchaseIdAsync**](https://msdn.microsoft.com/library/windows/apps/mt608675). Этот ключ представляет удостоверение пользователя– владельца продукта, доступ к данным о котором вы хотите получить.

## Утверждения в ключе идентификатора Магазина Windows


Ключ идентификатора магазина Windows— это веб-маркер JSON (JWT), который представляет удостоверение пользователя— владельца продукта, доступ к данным о котором вы хотите получить. После расшифровки в Base64 ключ идентификатора Магазина Windows содержит следующие утверждения.

| Имя утверждения                                                             | Описание                                                                                                                                                                                                                                                                                                                                                                             |
|------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| iat                                                                    | Указывает время выпуска ключа. Это утверждение можно использовать для определения возраста маркера. Это значение выражается как время эпохи.                                                                                                                                                                                                                                       |
| iss                                                                    | Определяет издателя. Имеет такое же значение, что и утверждение *aud*.                                                                                                                                                                                                                                                                                                                      |
| aud                                                                    | Указывает аудиторию. Должно иметь одно из следующих значений: `https://collections.mp.microsoft.com/v6.0/keys` или `https://purchase.mp.microsoft.com/v6.0/keys`.                                                                                                                                                                                                                    |
| exp                                                                    | Указывает период истечения срока действия, после которого ключ будет приниматься только для продления ключей. Для обработки другой информации ключ приниматься не будет. Значение этого утверждения выражается как время эпохи.                                                                                                                                                                                               |
| nbf                                                                    | Определяет период времени, в который маркер будет принят для обработки. Значение этого утверждения выражается как время эпохи.                                                                                                                                                                                                                                                             |
| `http://schemas.microsoft.com/marketplace/2015/08/claims/key/clientId`   | Идентификатор клиента, который определяет разработчика.                                                                                                                                                                                                                                                                                                                                            |
| `http://schemas.microsoft.com/marketplace/2015/08/claims/key/payload`    | Непрозрачные полезные данные (зашифрованные и закодированные в Base64), которые содержат сведения, предназначенные только для использования службами Магазина Windows.                                                                                                                                                                                                                                                     |
| `http://schemas.microsoft.com/marketplace/2015/08/claims/key/userId`     | Идентификатор, который определяет текущего пользователя в контексте ваших служб. Это то же значение, которое вы передаете необязательному параметру *publisherUserId* метода [**GetCustomerCollectionsIdAsync**](https://msdn.microsoft.com/library/windows/apps/mt608674) или [**GetCustomerPurchaseIdAsync**](https://msdn.microsoft.com/library/windows/apps/mt608675) при создании ключа. |
| `http://schemas.microsoft.com/marketplace/2015/08/claims/key/refreshUri` | URI, который вы можете использовать, чтобы обновить ключ.                                                                                                                                                                                                                                                                                                                                              |

 

Вот пример расшифрованного заголовка ключа идентификатора Магазина Windows.

```json
{
    "typ":"JWT",
    "alg":"RS256",
    "x5t":"agA_pgJ7Twx_Ex2_rEeQ2o5fZ5g"
}
```

Вот пример расшифрованного набора утверждений ключа идентификатора Магазина Windows.

```json
{
    "http://schemas.microsoft.com/marketplace/2015/08/claims/key/clientId": "1d5773695a3b44928227393bfef1e13d",
    "http://schemas.microsoft.com/marketplace/2015/08/claims/key/payload": "ZdcOq0/N2rjytCRzCHSqnfczv3f0343wfSydx7hghfu0snWzMqyoAGy5DSJ5rMSsKoQFAccs1iNlwlGrX+/eIwh/VlUhLrncyP8c18mNAzAGK+lTAd2oiMQWRRAZxPwGrJrwiq2fTq5NOVDnQS9Za6/GdRjeiQrv6c0x+WNKxSQ7LV/uH1x+IEhYVtDu53GiXIwekltwaV6EkQGphYy7tbNsW2GqxgcoLLMUVOsQjI+FYBA3MdQpalV/aFN4UrJDkMWJBnmz3vrxBNGEApLWTS4Bd3cMswXsV9m+VhOEfnv+6PrL2jq8OZFoF3FUUpY8Fet2DfFr6xjZs3CBS1095J2yyNFWKBZxAXXNjn+zkvqqiVRjjkjNajhuaNKJk4MGHfk2rZiMy/aosyaEpCyncdisHVSx/S4JwIuxTnfnlY24vS0OXy7mFiZjjB8qL03cLsBXM4utCyXSIggb90GAx0+EFlVoJD7+ZKlm1M90xO/QSMDlrzFyuqcXXDBOnt7rPynPTrOZLVF+ODI5HhWEqArkVnc5MYnrZD06YEwClmTDkHQcxCvU+XUEvTbEk69qR2sfnuXV4cJRRWseUTfYoGyuxkQ2eWAAI1BXGxYECIaAnWF0W6ThweL5ZZDdadW9Ug5U3fZd4WxiDlB/EZ3aTy8kYXTW4Uo0adTkCmdLibw=",
    "http://schemas.microsoft.com/marketplace/2015/08/claims/key/userId": "infusQMLaYCrgtC0d/SZWoPB4FqLEwHXgZFuMJ6TuTY=",
    "http://schemas.microsoft.com/marketplace/2015/08/claims/key/refreshUri": "https://collections.mp.microsoft.com/v6.0/b2b/keys/renew",
    "iat": 1442395542,
    "iss": "https://collections.mp.microsoft.com/v6.0/keys",
    "aud": "https://collections.mp.microsoft.com/v6.0/keys",
    "exp": 1450171541,
    "nbf": 1442391941
}
```

## Связанные разделы

* [Запрос продуктов](query-for-products.md)
* [Объявление потребляемого продукта в качестве выполненного](report-consumable-products-as-fulfilled.md)
* [Предоставление бесплатных продуктов](grant-free-products.md)
* [Обновление ключа идентификатора Магазина Windows](renew-a-windows-store-id-key.md)
* [Интеграция приложений с Azure Active Directory](http://go.microsoft.com/fwlink/?LinkId=722502)
* [Основные сведения о манифесте приложения Azure Active Directory]( http://go.microsoft.com/fwlink/?LinkId=722500)
* [Поддерживаемые токены и типы утверждений](http://go.microsoft.com/fwlink/?LinkId=722501)
 

 



<!--HONumber=Jun16_HO5-->


