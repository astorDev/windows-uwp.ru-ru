---
author: mcleanbyron
ms.assetid: F37C2CEC-9ED1-4F9E-883D-9FBB082504D4
description: Использование этого метода в API покупок Microsoft Store для изменения состояния выставления счетов за подписку для пользователя.
title: Изменение состояния выставления счетов за подписку для пользователя
ms.author: mcleans
ms.date: 08/01/2018
ms.topic: article
ms.prod: windows
ms.technology: uwp
keywords: windows 10, uwp, API покупок Microsoft Store, подписки
ms.localizationpriority: medium
ms.openlocfilehash: d8734c1fe25cf6c22d88d2d50b323b7d3ee86710
ms.sourcegitcommit: 194ab5aa395226580753869c6b66fce88be83522
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2018
ms.locfileid: "4154069"
---
# <a name="change-the-billing-state-of-a-subscription-for-a-user"></a>Изменение состояния выставления счетов за подписку для пользователя

Использование этого метода в API покупок Microsoft Store для изменения состояния выставления счетов надстройки с подпиской для конкретного пользователя. Можно отменить, расширить, компенсировать или отключить автоматическое возобновление для подписки.

> [!NOTE]
> Этот метод может использоваться только учетными записями разработчиков, которые были выделены корпорацией Майкрософт для создания надстроек с подпиской для приложений универсальной платформы Windows (UWP). Надстройки подписки недоступны в настоящее время большинству учетных записей разработчика.

## <a name="prerequisites"></a>Что вам понадобится

Для использования этого метода вам понадобится:

* Маркер доступа Azure AD, имеющий значение URI аудитории `https://onestore.microsoft.com`.
* Ключ идентификатора Microsoft Store, который представляет идентификатор пользователя, имеющего разрешение на подписку, которую вы хотите изменить.

Дополнительные сведения см. в разделе [Управление правами на продукты из службы](view-and-grant-products-from-a-service.md).

## <a name="request"></a>Запрос


### <a name="request-syntax"></a>Синтаксис запроса

| Метод | URI запроса                                            |
|--------|--------------------------------------------------------|
| POST   | ```https://purchase.mp.microsoft.com/v8.0/b2b/recurrences/{recurrenceId}/change``` |


### <a name="request-header"></a>Заголовок запроса

| Заголовок         | Тип   | Описание   |
|----------------|--------|-------------|
| Authorization  | string | Обязательный. Маркер доступа Azure AD в формате **Bearer** &lt;*token*&gt;.                           |
| Host           | строка | Должен иметь значение **purchase.mp.microsoft.com**.                                            |
| Content-Length | Число | Длина текста запроса.                                                                       |
| Content-Type   | Строка | Указывает тип запросов и ответов. На данный момент единственным поддерживаемым значением является **application/json**. |


### <a name="request-parameters"></a>Параметры запроса

| Имя         | Тип  | Описание   |  Обязательные  |
|----------------|--------|-------------|-----------|
| recurrenceId | Строка | Идентификатор подписки, которую необходимо изменить. Для получения этого идентификатора, вызовите метод [get подписки для пользователя](get-subscriptions-for-a-user.md) , определите запись текста ответа, который представляет надстройку подписки, которую вы хотите изменить и используйте значение поля **идентификатора** для записи.     | Да      |


### <a name="request-body"></a>Текст запроса

| Поле      | Тип   | Описание   | Обязательные |
|----------------|--------|---------------|----------|
| b2bKey         | Строка | [Ключ идентификатора Microsoft Store](view-and-grant-products-from-a-service.md#step-4), представляющий идентификатор пользователя, подписку которого требуется изменить.     | Да      |
| changeType     | Строка |  Одна из следующих строк, которая определяет тип вносимого изменения:<ul><li>**Cancel**: отменяет подписку.</li><li>**Extend**: расширяет подписку. Если задать это значение, необходимо также включить параметр *extensionTimeInDays*.</li><li>**Refund**: возмещение клиенту денег за подписку.</li><li>**ToggleAutoRenew**: отключение автоматического продления подписки. Если автоматическое обновление в настоящее время отключено для подписки, это значение ни на что не влияет.</li></ul>   | Да      |
| extensionTimeInDays  | Строка  | Если параметр *changeType* имеет значение **Extend**, он указывает количество дней для расширения подписки. |  Да, если *changeType* имеет значение **Extend**, в противном случае нет.  ||


### <a name="request-example"></a>Пример запроса

В следующем примере показано, как использовать этот метод, чтобы расширить период подписки на 5 дней. Замените значение *b2bKey* [ключом идентификатора Microsoft Store](view-and-grant-products-from-a-service.md#step-4), представляющим идентификатор пользователя, подписку которого вы хотите изменить.

```json
POST https://purchase.mp.microsoft.com/v8.0/b2b/recurrences/mdr:0:bc0cb6960acd4515a0e1d638192d77b7:77d5ebee-0310-4d23-b204-83e8613baaac/change HTTP/1.1
Authorization: Bearer <your access token>
Content-Type: application/json
Host: https://purchase.mp.microsoft.com

{
  "b2bKey":  "eyJ0eXAiOiJ...",
  "changeType": "Extend",
  "extensionTimeInDays": "5"
}
```


## <a name="response"></a>Ответ

Этот метод возвращает текст ответа JSON со сведениями об измененной надстройке подписки, в том числе об измененных полях. В следующем примере показан текст ответа для этого метода.

```json
{
  "items": [
    {
      "autoRenew":true,
      "beneficiary":"pub:gFVuEBiZHPXonkYvtdOi+tLE2h4g2Ss0ZId0RQOwzDg=",
      "expirationTime":"2017-06-16T03:07:49.2552941+00:00",
      "id":"mdr:0:bc0cb6960acd4515a0e1d638192d77b7:77d5ebee-0310-4d23-b204-83e8613baaac",
      "lastModified":"2017-01-10T21:08:13.1459644+00:00",
      "market":"US",
      "productId":"9NBLGGH52Q8X",
      "skuId":"0024",
      "startTime":"2017-01-10T21:07:49.2552941+00:00",
      "recurrenceState":"Active"
    }
  ]
}
```


### <a name="response-body"></a>Текст ответа

Текст ответа содержит следующие данные.

| Значение        | Тип   | Описание                                                                 |
|---------------|--------|-----------------------------------------------|
| autoRenew | Логическое |  Указывает, настроено ли в подписке автоматическое продление в конце текущего периода.   |
| beneficiary | Строка |  Идентификатор бенефициара права, связанного с этой подпиской.   |
| expirationTime | Строка | Дата и время завершения подписки в формате ISO 8601. Это поле доступно только при определенных состояниях подписки. Время окончания срока действия обычно означает окончание срока действия текущего состояния. Например, для активной подписки дата окончания срока действия указывает, когда произойдет следующее автоматическое продление.    |
| expirationTimeWithGrace | string | Дата и время подписки истекает период отсрочки, в том числе в формате ISO 8601. Это значение указывает, когда пользователи потеряют доступ к подписке, после сбоя для автоматического продления подписки.    |
| id | Строка |  Идентификатор подписки. Используйте это значение для подписки, которую вы хотите изменить при вызове метода [изменение состояния выставления счетов подписки для пользователя](change-the-billing-state-of-a-subscription-for-a-user.md).    |
| isTrial | Логическое |  Указывает, является ли подписка пробной версией.     |
| lastModified | Строка |  Дата и время последнего изменения подписки в формате ISO 8601.      |
| market | Строка | Код страны (в двухбуквенном формате ISO 3166-1 alpha-2), в которой пользователь приобрел подписку.      |
| productId | Строка | [Код продукта в Store](in-app-purchases-and-trials.md#store-ids) для [продукта](in-app-purchases-and-trials.md#products-skus-and-availabilities), который представляет надстройку подписки в каталоге Microsoft Store. Пример кода продукта в Store: 9NBLGGH42CFD.     |
| skuId | Строка |  [Код продукта в Store](in-app-purchases-and-trials.md#store-ids) для [номера SKU](in-app-purchases-and-trials.md#products-skus-and-availabilities), который представляет надстройку подписки в каталоге Microsoft Store. Пример кода продукта в Store для номера SKU: 0010.    |
| startTime | Строка |  Дата и время начала для подписки в формате ISO 8601.     |
| recurrenceState | Строка  |  Принимает одно из следующих значений:<ul><li>**None**:&nbsp;&nbsp;означает бессрочную подписку.</li><li>**Active**:&nbsp;&nbsp;подписка активна, пользователь имеет право пользоваться службами.</li><li>**Inactive**:&nbsp;&nbsp;срок действия подписки истек, пользователь отключил ее автоматическое продление.</li><li>**Canceled**:&nbsp;&nbsp;срок действия подписки намеренно прерван до даты окончания срока действия, с возмещением денежных средств или без.</li><li>**InDunning**:&nbsp;&nbsp;подписка находится в *процессе напоминания* (приближается срок окончания действия подписки, и Майкрософт пытается получить средства для ее автоматического продления).</li><li>**Failed**:&nbsp;&nbsp;период напоминания закончился, не удалось продлить подписку после нескольких попыток.</li></ul><p>**Примечание.**</p><ul><li>**Inactive**/**Canceled**/**Failed**— состояния окончания. Когда подписка переходит в одно из этих состояний, пользователь должен повторно приобрести подписку, чтобы активировать ее снова. Пользователь не имеет права работать со службами в этих состояниях.</li><li>Если состояние подписки **Canceled**, значение expirationTime будет обновлено с указанием даты и времени отмены.</li><li>Идентификатор подписки будет оставаться неизменным в течение всего времени существования. Он не меняется при включении или выключении автоматического обновления. Если пользователь повторно приобретет подписку после достижения состояния окончания, будет создан новый идентификатор подписки.</li><li>Идентификатор подписки следует использовать для выполнения любой операции с отдельной подпиской.</li><li>Когда пользователь повторно приобретет подписку после ее отмены или завершения, на запрос по такому пользователю будут возвращены две записи: одна с идентификатором старой подписки в состоянии окончания, а другая — с идентификатором новой подписки в активном состоянии.</li><li>Всегда рекомендуется проверять recurrenceState и expirationTime, так как обновления recurrenceState могут быть отложены на несколько минут (а иногда на несколько часов).       |
| cancellationDate | Строка   |  Дата и время отмены подписки пользователя в формате ISO 8601.     |


## <a name="related-topics"></a>Статьи по теме


* [Управление правами на продукты из службы](view-and-grant-products-from-a-service.md)
* [Получение подписок для пользователя](get-subscriptions-for-a-user.md)
* [Запрос продуктов](query-for-products.md)
* [Объявление потребляемого продукта в качестве выполненного](report-consumable-products-as-fulfilled.md)
* [Обновление ключа идентификатора Microsoft Store](renew-a-windows-store-id-key.md)
