---
author: mcleanbyron
ms.assetid: D1F233EC-24B5-4F84-A92F-2030753E608E
description: Используйте этот метод в API коллекции Магазина Windows для получения всех продуктов, принадлежащих пользователю, для приложений, связанных с вашим идентификатором клиента Azure AD. Вы можете ограничить запрос определенным продуктом или использовать другие фильтры.
title: Запрос продуктов
---

# Запрос продуктов


\[ Обновлено для приложений UWP в Windows 10. Статьи о Windows 8.x см. в [архиве](http://go.microsoft.com/fwlink/p/?linkid=619132) \]

Используйте этот метод в API коллекции Магазина Windows для получения всех продуктов, принадлежащих пользователю, для приложений, связанных с вашим идентификатором клиента Azure AD. Вы можете ограничить запрос определенным продуктом или использовать другие фильтры.

Этот метод вызывается вашей службой в ответ на сообщение из вашего приложения. Ваша служба не должна регулярно опрашивать всех пользователей в расписании.

## Необходимые условия


Для использования этого метода вам понадобится:

-   маркер доступа Azure AD, созданный с помощью URI аудитории **https://onestore.microsoft.com**;
-   Ключ идентификатора Магазина Windows, который был создан с помощью метода [**GetCustomerCollectionsIdAsync**](https://msdn.microsoft.com/library/windows/apps/mt608674), вызываемого в клиентском коде вашего приложения.

Подробные сведения см. в разделе [Просмотр и предоставление продуктов из службы](view-and-grant-products-from-a-service.md).

## Запрос

### Синтаксис запроса

| Метод | URI запроса                                                 |
|--------|-------------------------------------------------------------|
| POST   | https://collections.mp.microsoft.com/v6.0/collections/query |

 
### Заголовок запроса

| Заголовок         | Тип   | Описание                                                                                           |
|----------------|--------|-------------------------------------------------------------------------------------------------------|
| Authorization  | строковый | Обязательное. 1Маркер доступа Azure AD в форме**Bearer**&lt;*token*&gt;.                           |
| Host           | строковый | Должен иметь значение **collections.mp.microsoft.com**.                                            |
| Content-Length | Число | Длина тела запроса.                                                                       |
| Content-Type   | Строка | Указывает тип запросов и ответов. На данный момент единственным поддерживаемым значением является **application/json**. |

 

### Тело запроса

| Параметр         | Тип         | Описание                                                                                                                                                                                                                                                          | Обязательный параметр |
|-------------------|--------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| beneficiaries     | UserIdentity | Объект UserIdentity, который представляет пользователя, опрашиваемого на предмет продуктов.                                                                                                                                                                                           | Да      |
| continuationToken | Строка       | Если имеется несколько наборов продуктов, то по достижении лимита для страницы тело ответа возвращает маркер продолжения. Укажите здесь этот маркер продолжения, чтобы в последующих вызовах получить информацию об оставшихся продуктах.                                                      | Нет       |
| maxPageSize       | Число       | Максимальное количество продуктов, возвращаемых в одном ответе. Стандартное и максимальное значение — 100.                                                                                                                                                                      | Нет       |
| modifiedAfter     | Дата и время     | Если параметр указан, служба возвращает только продукты, которые были изменены после этой даты.                                                                                                                                                                             | Нет       |
| parentProductId   | строковый       | Если параметр указан, служба возвращает только IAP, которые соответствуют указанному приложению.                                                                                                                                                                                    | Нет       |
| productSkuIds     | ProductSkuId | Если параметр указан, служба возвращает только продукты, соответствующие предоставленным парам «продукт — SKU».                                                                                                                                                                        | Нет       |
| productTypes      | строковый       | Если параметр указан, служба возвращает только продукты, соответствующие указанным типам продуктов. Поддерживаемые типы продуктов: **Application**, **Durable** и **UnmanagedConsumable**.                                                                                       | Нет       |
| validityType      | Строка       | Если выбрано значение **All**, возвращаются все продукты пользователя, в том числе продукты с истекшим сроком. Если выбрано значение **Valid**, возвращаются только продукты, действительные на данный момент (то есть в активном состоянии, с датой начала &lt; ранее текущего момента и датой окончания &gt; позднее текущего момента). | Нет       |

 

Объект UserIdentity содержит следующие параметры.

| Параметр            | Тип   | Описание                                                                                                                                                                                                                  | Обязательный параметр |
|----------------------|--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| identityType         | Строка | Укажите строковое значение **b2b**.                                                                                                                                                                                            | Да      |
| identityValue        | Строка | Строковое значение ключа идентификатора Магазина Windows.                                                                                                                                                                                    | Да      |
| localTicketReference | строковый | Запрошенный идентификатор для возвращаемых продуктов. Элементы, возвращаемые в теле ответа, будут иметь совпадающее значение параметра *localTicketReference*. Рекомендуется использовать то же значение, которое использует утверждение *userId* в ключе идентификатора Магазина Windows. | Да      |

 

Объект ProductSkuId содержит следующие параметры.

| Параметр | Тип   | Описание                                                                                                                                                                                                                                                                                                            | Обязательный параметр |
|-----------|--------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| productId | строковый | Код продукта из каталога Магазина Windows. Чтобы получить код продукта, выберите свое приложение в информационной панели Центра разработки для Windows, перейдите к странице **Управление приложениями**&gt;**Удостоверение приложения** и восстановите суффикс строки, которая отображается в поле **URL-адрес для Windows 10**. Пример кода продукта: 9WZDNCRFJ3Q8. | Да      |
| skuID     | строковый | Код SKU из каталога Магазина Windows. Пример команды кода SKU: 0010.                                                                                                                                                                                                                                                | Да      |

 

### Пример запроса

```syntax
POST https://collections.mp.microsoft.com/v6.0/collections/query HTTP/1.1
Authorization: Bearer eyJ0eXAiOiJKV1Q…….
Host: collections.mp.microsoft.com
Content-Length: 2531
Content-Type: application/json

{
    "maxPageSize": 100,
    "beneficiaries": [
            {
                "localTicketReference": "1055521810674918",
                "identityValue": "eyJ0eXAiOiJ……",
                "identityType": "b2b"
            }
        ],
    "modifiedAfter": "\/Date(-62135568000000)\/",
    "productSkuIds": [
            {
                "productId": "9NBLGGH5WVP6",
                "skuId": "0010"
            }
        ],
    "productTypes": [
            "UnmanagedConsumable"
        ],
    "validityType": "All"
}
```

## Ответ


### Тело ответа

| Параметр         | Тип                     | Описание                                                                                                                                                                                | Обязательный параметр |
|-------------------|--------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| continuationToken | строковый                   | Если имеется несколько наборов продуктов, то по достижении лимита для страницы возвращается этот маркер. Вы можете указать маркер продолжения в последующих вызовах для извлечения остальных продуктов. | Нет       |
| Items             | CollectionItemContractV6 | Массив продуктов для указанного пользователя.                                                                                                                                               | Нет       |

 

Объект CollectionItemContractV6 содержит следующие параметры.

| Параметр            | Тип               | Описание                                                                                                                                        | Обязательный параметр |
|----------------------|--------------------|----------------------------------------------------------------------------------------------------------------------------------------------------|----------|
| acquiredDate         | Дата и время           | Дата приобретения элемента пользователем.                                                                                                      | Да      |
| campaignId           | строковый             | Идентификатор кампании, предоставленный во время покупки для этого элемента.                                                                                  | Нет       |
| devOfferId           | строковый             | Идентификатор предложения покупки из приложения.                                                                                                              | Нет       |
| endDate              | Дата и время           | Дата окончания срока действия элемента.                                                                                                                          | Да      |
| fulfillmentData      | строковый             | Н/д                                                                                                                                                | Нет       |
| inAppOfferToken      | строковый             | Указанная разработчиком строка кода продукта, назначенная элементу на информационной панели Центра разработки для Windows. Пример кода продукта: product123. | Нет       |
| itemId               | строковый             | Идентификатор, отличающий этот элемент коллекции от других элементов, принадлежащих пользователю. Этот идентификатор уникален для каждого продукта.                                          | Да      |
| localTicketReference | строковый             | Идентификатор ранее предоставленного в тексте запроса параметра `localTicketReference`.                                                                      | Да      |
| modifiedDate         | Дата и время           | Дата последнего изменения элемента.                                                                                                              | Да      |
| orderId              | строковый             | Если он указан, идентификатор заказа, из которого был получен данный элемент.                                                                                          | Нет       |
| orderLineItemId      | строковый             | Если указан, означает позицию конкретного заказа данного элемента.                                                                | Нет       |
| ownershipType        | строковый             | Строка OwnedByBeneficiary.                                                                                                                   | Да      |
| productId            | строковый             | Код продукта из каталога Магазина Windows. Пример кода продукта: 9WZDNCRFJ3Q8.                                                            | Да      |
| productType          | Строка             | Один из следующих типов продукта: **Application**, **Durable** и **UnmanagedConsumable**.                                                     | Да      |
| purchasedCountry     | Строка             | Н/д.                                                                                                                                               | Нет       |
| purchaser            | IdentityContractV6 | Если он указан, означает удостоверение покупателя элемента. Сведения для этого объекта см. ниже.                                      | Нет       |
| Quantity             | Число             | Количество экземпляров элемента. На данный момент это значение всегда составляет 1.                                                                                        | Нет       |
| skuId                | строковый             | Код SKU из каталога Магазина Windows. Пример команды кода SKU: 0010.                                                                            | Да      |
| skuType              | Строка             | Тип SKU. Возможные значения включают **Trial**, **Full** и **Rental**.                                                                      | Да      |
| startDate            | Дата и время           | Дата, начиная с которой элемент действителен.                                                                                                         | Да      |
| Состояние               | Строка             | Состояние элемента. Возможные значения включают **Active**, **Expired**, **Revoked** и **Banned**.                                              | Да      |
| Tags                 | Строка             | Н/д                                                                                                                                                | Да      |
| transactionId        | Guid               | Идентификатор транзакции в результате покупки элемента. Может использоваться для объявления элемента в качестве выполненного.                                       | Да      |

 

Объект IdentityContractV6 содержит следующие параметры.

| Параметр     | Тип   | Описание                                                                        | Обязательный параметр |
|---------------|--------|------------------------------------------------------------------------------------|----------|
| identityType  | Строка | Содержит значение **"pub"**.                                                      | Да      |
| identityValue | Строка | Строковое значение *publisherUserId* конкретного ключа идентификатора Магазина Windows. | Да      |

 

### Пример ответа

```syntax
HTTP/1.1 200 OK
Content-Length: 7241
Content-Type: application/json
MS-CorrelationId: 699681ce-662c-4841-920a-f2269b2b4e6c
MS-RequestId: a9988cf9-652b-4791-beba-b0e732121a12
MS-CV: xu2HW6SrSkyfHyFh.0.1
MS-ServerId: 020022359
Date: Tue, 22 Sep 2015 20:28:18 GMT

{
    "items" : [
        {
            "acquiredDate" : "2015-09-22T19:22:51.2068724+00:00",
            "devOfferId" : "f9587c53-540a-498b-a281-8a349491ed47",
            "endDate" : "9999-12-31T23:59:59.9999999+00:00",
            "fulfillmentData" : [],
            "inAppOfferToken" : "consumable2",
            "itemId" : "4b8fbb13127a41f299270ea668681c1d",
            "localTicketReference" : "1055521810674918",
            "modifiedDate" : "2015-09-22T19:22:51.2513155+00:00",
            "orderId" : "4ba5960d-4ec6-4a81-ac20-aafce02ddf31",
            "ownershipType" : "OwnedByBeneficiary",
            "productId" : "9NBLGGH5WVP6",
            "productType" : "UnmanagedConsumable",
            "purchaser" : {
                "identityType" : "pub",
                "identityValue" : "user123"
            },
            "skuId" : "0010",
            "skuType" : "Full",
            "startDate" : "2015-09-22T19:22:51.2068724+00:00",
            "status" : "Active",
            "tags" : [],
            "transactionId" : "4ba5960d-4ec6-4a81-ac20-aafce02ddf31"
        }
    ]
}
```

## Связанные разделы

* [Просмотр и предоставление продуктов из службы](view-and-grant-products-from-a-service.md)
* [Объявление потребляемого продукта в качестве выполненного](report-consumable-products-as-fulfilled.md)
* [Предоставление бесплатных продуктов](grant-free-products.md)
* [Обновление ключа идентификатора Магазина Windows](renew-a-windows-store-id-key.md)


<!--HONumber=May16_HO2-->


