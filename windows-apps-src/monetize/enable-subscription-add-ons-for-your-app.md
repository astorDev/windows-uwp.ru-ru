---
author: mcleanbyron
description: "Узнайте, как использовать пространство имен Windows.Services.Store для реализации надстроек с подпиской."
title: "Включение надстроек с подпиской для приложения"
keywords: "windows 10, uwp, подписки, надстройки, покупки из приложения, IAP, Windows.Services.Store"
ms.author: mcleans
ms.date: 08/01/2017
ms.topic: article
ms.prod: windows
ms.technology: uwp
ms.openlocfilehash: 16e2e8d160ad2236220dc6f19f578bbaa82c9dc0
ms.sourcegitcommit: de6bc8acec2cd5ebc36bb21b2ce1a9980c3e78b2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/17/2017
---
# <a name="enable-subscription-add-ons-for-your-app"></a>Включение надстроек с подпиской для приложения

> [!IMPORTANT]
> В настоящее время возможность создавать надстройки с подпиской доступна только нескольким учетным записям разработчиков, которые участвуют в программе раннего внедрения. В будущем мы предоставим надстройки с подпиской для всех учетных записей разработчиков. Задачей этого документа является предварительное ознакомление разработчиков с этой возможностью.

Если ваше приложение UWP предназначено для Windows 10 версии 1607 или более поздней версии, вы можете предлагать покупки из приложения для надстроек с *подпиской* своим пользователям. Подписки можно использовать для продажи цифровых продуктов в приложении (например, функций приложения или цифрового содержимого) с автоматическим периодическим выставлением счетов.

## <a name="feature-highlights"></a>Особенности функции

Надстройки с подпиской для приложений UWP поддерживают следующие возможности.

* Вы можете выбрать следующие варианты длительности подписки: 1 месяц, 3 месяца, 6 месяцев, 1 год или 2 года. Некоторые приложения также могут использовать 6-часовую подписку для тестирования.
* Можно добавить в подписку бесплатные пробные периоды длительностью 1 неделя или 1 месяц.
* Windows SDK [предоставляет API-интерфейсы](#code-examples), которые можно использовать в приложении, чтобы получить сведения о доступных надстройках с подпиской для приложения и включить покупку надстроек с подпиской. Мы также предоставляем API-интерфейсы REST, которые можно вызывать из своих служб для [управления подписками пользователя](#manage-subscriptions).
* Можно просмотреть аналитические отчеты, содержащие количество покупок подписки, активных подписчиков и отмененных подписок за определенный период времени.
* Пользователи могут управлять своей подпиской на странице [http://account.microsoft.com/services](http://account.microsoft.com/services) своей учетной записи Майкрософт. Пользователи могут использовать эту страницу для просмотра всех приобретенных подписок, отмены подписки и изменения способа оплаты, связанного с подпиской.

> [!NOTE]
> Чтобы обеспечить возможность покупки надстроек с подпиской в приложении, ваше приложение должно быть предназначено для Windows 10 версии 1607 или более поздней, а также должно использовать API-интерфейсы в пространстве имен **Windows.Services.Store** для реализации покупок из приложения, а не пространство имен **Windows.ApplicationModel.Store**. Дополнительные сведения о различиях между этими пространствами имен см. в разделе [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md).

## <a name="steps-to-enable-a-subscription-add-on-for-your-app"></a>Действия для включения надстроек с подпиской для приложения

Чтобы обеспечить возможность покупки надстройки с подпиской в приложении, выполните следующие действия.

1. [Создайте отправку надстройки](../publish/add-on-submissions.md) для подписки на информационной панели Центра разработки и опубликуйте эту отправку. При выполнении процесса отправки надстройки обратите особое внимание на следующие свойства.

  * [Тип продукта](../publish/set-your-add-on-product-id.md#product-type): обязательно выберите **Подписка**.

  * [Период подписки](../publish/enter-add-on-properties.md#subscription-period): выберите периодичность выставления счетов по вашей подписке. Изменить периодичность подписки после публикации надстройки невозможно.

    Каждая надстройка с подпиской поддерживает один вариант периода подписки и пробного периода. Необходимо создать различные надстройки с подпиской для каждого типа подписки, который вы собираетесь предлагать в своем приложении. Например, если вы хотите предложить месячную подписку без пробного периода, месячную подписку с пробным периодом в один месяц, годовую подписку без пробного периода и годовую подписку с пробным периодом в один месяц, вам потребуется создать четыре разных надстройки с подпиской.
        > [!NOTE]
        > If you are in the process of implementing the in-app purchase experience for your subscription, we recommend that you create a test add-on with the **For testing only – 6 hours** subscription period to help you test the experience. You can choose this test period only if you select one of the **Hidden in the Store** [visibility options](../publish/set-add-on-pricing-and-availability.md#visibility) for your test add-on.

  * [Пробный период](../publish/enter-add-on-properties.md#free-trial): выберите длительность пробного периода подписки в 1 неделю или 1 месяц, чтобы пользователи могли попробовать предлагаемое по подписке содержимое, прежде чем приобрести его. Изменить или удалить пробный период после публикации надстройки с подпиской невозможно.

    Чтобы получить бесплатную пробную версию подписки, пользователю необходимо приобрести вашу подписку путем стандартной процедуры покупки из приложения, также указав допустимый способ оплаты. В течение пробного периода денежные средства с пользователей не взымаются. По окончании пробного периода подписка автоматически преобразуется в полную подписку, и указанное пользователем платежное средство используется для оплаты за первый период платной подписки. Если пользователь решит отменить подписку в течение пробного периода, подписка останется активной до окончания пробного периода.
        > [!NOTE]
        > Some trial durations are not available for all subscription periods.

  * [Видимость](../publish/set-add-on-pricing-and-availability.md#visibility): если вы создаете тестовую надстройку, которую будете использовать только для тестирования функции покупки из приложения, рекомендуется выбрать один из вариантов **Скрыто в Магазине**. В противном случае можно выбрать оптимальную для вашего сценария видимость.

  * [Цена](../publish/set-add-on-pricing-and-availability.md?#pricing): выберите стоимость вашей подписки в этом разделе. После публикации надстройки повысить цену подписки невозможно (однако в дальнейшем можно снизить цену).
      > [!IMPORTANT]
      > По умолчанию при создании любой надстройки цене изначально устанавливается значение **Бесплатно**. Поскольку повысить цену надстройки с подпиской после завершения отправки надстройки невозможно, не забудьте выбрать здесь стоимость вашей подписки.

2. В приложении используйте API-интерфейсы в пространстве имен [**Windows.Services.Store**](https://docs.microsoft.com/uwp/api/windows.services.store), чтобы проверить, приобрел ли текущий пользователь вашу надстройку с подпиской, и затем предложить ее пользователю в качестве покупки из приложения. В разделе [примеры кода](#code-examples) этой статьи приводятся дополнительные сведения.

3. Протестируйте реализацию покупок из приложения для подписки в приложении. Вам потребуется один раз скачать свое приложение из Магазина на свое устройство разработки, чтобы использовать его лицензию для тестирования. Дополнительные сведения по покупкам из приложения см. в [руководстве по тестированию](in-app-purchases-and-trials.md#testing).  
    > [!NOTE]
    > Если ваше приложение предлагает период подписки **Только для тестирования — 6 часов**, рекомендуется создать тестовую надстройку с таким периодом, чтобы проверить, как это работает. Этот период тестирования можно выбрать только в том случае, если вы выбрали [параметр видимости](../publish/set-add-on-pricing-and-availability.md#visibility) **Скрыто в магазине** для тестирования надстройки.

4. Создайте и опубликуйте отправку приложения, которая включает в себя обновленный пакет приложения, включая тестируемый код. Более подробные сведения см. в разделе [Отправки приложений](../publish/app-submissions.md).

<span id="code-examples"/>
## <a name="code-examples"></a>Примеры кода

В примерах кода в этом разделе показано, как использовать API-интерфейсы в пространстве имен [**Windows.Services.Store**](https://docs.microsoft.com/uwp/api/windows.services.store) для получения сведений о надстройках с подпиской для текущего приложения и запроса покупки надстройки с подпиской от имени текущего пользователя.

Для этих примеров необходимо выполнение следующих предварительных условий.
* Создан проект Visual Studio для приложения универсальной платформы Windows (UWP), предназначенный для Windows 10 версии 1607 и выше.
* Создана [отправка приложения](https://msdn.microsoft.com/windows/uwp/publish/app-submissions) на информационной панели Центра разработки для Windows, и это приложение опубликовано в Магазине. При необходимости можно настроить приложение, чтобы его нельзя было найти в Магазине, пока вы его тестируете. Подробнее см. в [руководстве по тестированию](in-app-purchases-and-trials.md#testing).
* Создана [надстройка с подпиской для приложения](../publish/add-on-submissions.md) на информационной панели Центра разработки.

В коде из этих примеров предполагается следующее.
* Код выполняется в контексте страницы [**Page**](https://msdn.microsoft.com/library/windows/apps/windows.ui.xaml.controls.page.aspx), которая содержит [**ProgressRing**](https://msdn.microsoft.com/library/windows/apps/windows.ui.xaml.controls.progressring.aspx) с именем ```workingProgressRing``` и [**TextBlock**](https://msdn.microsoft.com/library/windows/apps/windows.ui.xaml.controls.textblock.aspx) с именем ```textBlock```. Эти объекты используются для индикации выполнения асинхронной операции и отображения выводимых сообщений, соответственно.
* Файл кода содержит оператор **using** для пространства имен **Windows.Services.Store**.
* Приложение является однопользовательским и выполняется только в контексте пользователя, запустившего его. Подробнее см. в разделе [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md#api_intro).

> [!NOTE]
> Если у вас есть классическое приложение, которое использует [мост для классических приложений](https://developer.microsoft.com/windows/bridges/desktop), вам может потребоваться добавить дополнительный код, не показанный в этих примерах, для настройки объекта [**StoreContext**](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx). Дополнительные сведения см. в разделе [Использование класса StoreContext в классическом приложение, в котором применяется мост для классических приложений](in-app-purchases-and-trials.md#desktop).

### <a name="get-info-about-subscription-add-ons-for-the-current-app"></a>Получение информации о надстройках с подпиской для текущего приложения

В этом примере кода показано, как получить сведения о надстройках с подпиской, доступных в вашем приложении. Чтобы получить эти сведения, сначала используйте метод [**GetAssociatedStoreProductsAsync**](https://docs.microsoft.com/uwp/api/Windows.Services.Store.StoreContext#Windows_Services_Store_StoreContext_GetAssociatedStoreProductsAsync_), чтобы получить коллекцию объектов [**StoreProduct**](https://docs.microsoft.com/uwp/api/Windows.Services.Store.StoreProduct), представляющих каждую из доступных надстроек для приложения. Затем получите [**StoreSku**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku) для каждого продукта и используйте свойства [**IsSubscription**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku#Windows_Services_Store_StoreSku_IsSubscription_) и [**SubscriptionInfo**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku#Windows_Services_Store_StoreSku_SubscriptionInfo_) для доступа к сведениям о подписке.

> [!div class="tabbedCodeSnippets"]
[!code-cs[Подписки](./code/InAppPurchasesAndLicenses_RS1/cs/GetSubscriptionAddOnsPage.xaml.cs#GetSubscriptions)]

### <a name="purchase-a-subscription-add-on"></a>Покупка надстройки с подпиской

В этом примере показано, как использовать метод [**RequestPurchaseAsync**](https://docs.microsoft.com/uwp/api/windows.services.store.storeproduct#Windows_Services_Store_StoreProduct_RequestPurchaseAsync_) класса [**StoreContext**](https://docs.microsoft.com/uwp/api/windows.services.store.storeproduct) для приобретения надстройки с подпиской. В этом примере предполагается, что вы уже знаете [код продукта в Магазине](in-app-purchases-and-trials.md#store-ids) надстройки с подпиской, которую требуется приобрести.

> [!div class="tabbedCodeSnippets"]
[!code-cs[Подписки](./code/InAppPurchasesAndLicenses_RS1/cs/PurchaseSubscriptionAddOnPage.xaml.cs#PurchaseSubscription)]

<span id="manage-subscriptions" />
## <a name="manage-subscriptions-from-your-services"></a>Управление подписками из ваших служб

После того как ваше обновленное приложение появится в Магазине и пользователи смогут покупать надстройку с подпиской, возможно, возникнут ситуации, в которых вам потребуется управлять подпиской пользователя. Мы предоставляем API-интерфейсы REST, которые можно вызывать из ваших служб для выполнения следующих задач по управления подпиской.

* [Получение подписок, на которые у пользователя есть права](get-subscriptions-for-a-user.md). Если ваша подписка является частью кроссплатформенной службы, можно вызвать этот API, чтобы определить, имеет ли указанный пользователь право на подписку, и состояние подписки в контексте вашего приложения UWP. Затем эти сведения можно использовать для обновления состояния подписки на других платформах, поддерживаемых вашей службой.

* [Изменение состояния выставления счетов за подписку для пользователя](change-the-billing-state-of-a-subscription-for-a-user.md). Используйте этот API, чтобы отменить, расширить, компенсировать или отключить автоматическое возобновление для подписки.

<span id="cancellations" />
## <a name="cancellations"></a>Отмены

Пользователи могут использовать страницу [http://account.microsoft.com/services](http://account.microsoft.com/services) своей учетной записи Майкрософт для просмотра всех приобретенных подписок, отмены подписки и изменения способа оплаты, связанного с подпиской. Если пользователь отменяет подписку с помощью этой страницы, он по-прежнему имеет доступ к этой подписке в течение текущего цикла выставления счетов. Он не получает возврат денежных средств за какую-либо часть текущего цикла выставления счетов. В конце текущего цикла выставления счетов подписка будет отключена.

Также можно отменить подписку от имени пользователя с помощью нашего API-интерфейса REST для [изменения состояния выставления счетов для данного пользователя](change-the-billing-state-of-a-subscription-for-a-user.md).

## <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

Следующие сценарии не поддерживаются для надстроек с подпиской.

* В настоящее время не поддерживается продажа подписок пользователям напрямую в Магазине. Подписки доступны только для покупок цифровых продуктов из приложения.
* Пользователи не могут изменять периоды подписки на странице [http://account.microsoft.com/services](http://account.microsoft.com/services) своей учетной записи Майкрософт. Чтобы переключиться на другой период подписки, пользователю необходимо отменить свою текущую подписку и затем приобрести подписку с другим периодом из вашего приложения.
* Переключение уровней для надстроек с подпиской в настоящее время не поддерживается (например, переход с базовой подписки на подписку уровня Премиум с увеличенным числом функций).
* [Продажи](../publish/put-apps-and-add-ons-on-sale.md) и [рекламные коды](../publish/generate-promotional-codes.md) для надстроек с подпиской в настоящее время не поддерживаются.


## <a name="related-topics"></a>Еще по теме:

* [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md)
* [Получение информации о продукте для приложений и надстроек](get-product-info-for-apps-and-add-ons.md)
