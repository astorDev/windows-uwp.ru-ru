---
description: Узнайте, как использовать пространство имен Windows.Services.Store для реализации надстроек с подпиской.
title: Включение надстроек с подпиской для приложения
keywords: windows 10, uwp, подписки, надстройки, покупки из приложения, IAP, Windows.Services.Store
ms.date: 12/06/2017
ms.topic: article
ms.localizationpriority: medium
ms.openlocfilehash: f46c566712f7f0c2bca45db5a107738c4104e037
ms.sourcegitcommit: 681c70f964210ab49ac5d06357ae96505bb78741
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/26/2018
ms.locfileid: "7697497"
---
# <a name="enable-subscription-add-ons-for-your-app"></a>Включение надстроек с подпиской для приложения

Ваше приложение универсальной платформы Windows (UWP) может предлагать покупки из приложения для надстроек с *подпиской* своим пользователям. Подписки можно использовать для продажи цифровых продуктов в приложении (например, функций приложения или цифрового содержимого) с автоматическим периодическим выставлением счетов.

> [!NOTE]
> Чтобы включить покупку надстроек с подпиской в приложении, ваш проект должен иметь в качестве целевой версии **Windows 10 Anniversary Edition (10.0; сборка 14393)** или более поздний выпуска в Visual Studio (это соответствует Windows 10 версии 1607), и он должен использовать API-интерфейсы в пространстве имен **Windows.Services.Store** для реализации возможности покупки из приложения вместо пространства имен **Windows.ApplicationModel.Store**. Дополнительные сведения о различиях между этими пространствами имен см. в разделе [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md).

## <a name="feature-highlights"></a>Особенности функции

Надстройки с подпиской для приложений UWP поддерживают следующие возможности.

* Вы можете выбрать следующие варианты длительности подписки: 1 месяц, 3 месяца, 6 месяцев, 1 год или 2 года.
* Можно добавить в подписку бесплатные пробные периоды длительностью 1 неделя или 1 месяц.
* Windows SDK [предоставляет API-интерфейсы](#code-examples), которые можно использовать в приложении, чтобы получить сведения о доступных надстройках с подпиской для приложения и включить покупку надстроек с подпиской. Мы также предоставляем API-интерфейсы REST, которые можно вызывать из своих служб для [управления подписками пользователя](#manage-subscriptions).
* Можно просмотреть аналитические отчеты, содержащие количество покупок подписки, активных подписчиков и отмененных подписок за определенный период времени.
* Пользователи могут управлять своей подпиской на странице [http://account.microsoft.com/services](http://account.microsoft.com/services) своей учетной записи Майкрософт. Пользователи могут использовать эту страницу для просмотра всех приобретенных подписок, отмены подписки и изменения способа оплаты, связанного с подпиской.

## <a name="steps-to-enable-a-subscription-add-on-for-your-app"></a>Действия для включения надстроек с подпиской для приложения

Чтобы обеспечить возможность покупки надстройки с подпиской в приложении, выполните следующие действия.

1. [Создание отправки надстройки](../publish/add-on-submissions.md) подписки в центре партнеров и опубликуйте эту отправку. При выполнении процесса отправки надстройки обратите особое внимание на следующие свойства.

    * [Тип продукта](../publish/set-your-add-on-product-id.md#product-type): обязательно выберите **Подписка**.

    * [Период подписки](../publish/enter-add-on-properties.md#subscription-period): выберите периодичность выставления счетов по вашей подписке. Изменить периодичность подписки после публикации надстройки невозможно.

        Каждая надстройка с подпиской поддерживает один вариант периода подписки и пробного периода. Необходимо создать различные надстройки с подпиской для каждого типа подписки, который вы собираетесь предлагать в своем приложении. Например, если вы хотите предложить месячную подписку без пробного периода, месячную подписку с пробным периодом в один месяц, годовую подписку без пробного периода и годовую подписку с пробным периодом в один месяц, вам потребуется создать четыре разных надстройки с подпиской.

    * [Пробный период](../publish/enter-add-on-properties.md#free-trial): выберите длительность пробного периода подписки в 1 неделю или 1 месяц, чтобы пользователи могли попробовать предлагаемое по подписке содержимое, прежде чем приобрести его. Изменить или удалить пробный период после публикации надстройки с подпиской невозможно.

        Чтобы получить бесплатную пробную версию подписки, пользователю необходимо приобрести вашу подписку путем стандартной процедуры покупки из приложения, также указав допустимый способ оплаты. В течение пробного периода денежные средства с пользователей не взымаются. По окончании пробного периода подписка автоматически преобразуется в полную подписку, и указанное пользователем платежное средство используется для оплаты за первый период платной подписки. Если пользователь решит отменить подписку в течение пробного периода, подписка останется активной до окончания пробного периода. Некоторые варианты пробного периода недоступны для всех периодов подписки.

        > [!NOTE]
        > Каждый клиент может получить бесплатную пробную подписку на надстройку только один раз. Если клиент получает бесплатную пробную подписку, Store запрещает тому же пользователю снова приобрести такую же бесплатную пробную подписку.

    * [Видимость](../publish/set-add-on-pricing-and-availability.md#visibility): если вы создаете тестовую надстройку, которую будете использовать только для тестирования функции покупки из приложения, рекомендуется выбрать один из вариантов **Скрыто в Store**. В противном случае можно выбрать оптимальную для вашего сценария видимость.

    * [Цена](../publish/set-add-on-pricing-and-availability.md?#pricing): выберите стоимость вашей подписки в этом разделе. Повысить стоимость подписки после публикации надстройки невозможно. Однако можно в дальнейшем снизить стоимость.
        > [!IMPORTANT]
        > По умолчанию при создании любой надстройки цене изначально устанавливается значение **Бесплатно**. Поскольку повысить цену надстройки с подпиской после завершения отправки надстройки невозможно, не забудьте выбрать здесь стоимость вашей подписки.

2. В приложении используйте API-интерфейсы в пространстве имен [**Windows.Services.Store**](https://docs.microsoft.com/uwp/api/windows.services.store), чтобы определить, приобрел ли текущий пользователь вашу надстройку с подпиской, и затем предложить ее пользователю в качестве покупки из приложения. В разделе [примеры кода](#code-examples) этой статьи приводятся дополнительные сведения.

3. Протестируйте реализацию покупок из приложения для подписки в приложении. Вам потребуется один раз скачать свое приложение из Магазина на свое устройство разработки, чтобы использовать его лицензию для тестирования. Дополнительные сведения по покупкам из приложения см. в [руководстве по тестированию](in-app-purchases-and-trials.md#testing).  

4. Создайте и опубликуйте отправку приложения, которая включает в себя обновленный пакет приложения, включая тестируемый код. Более подробные сведения см. в разделе [Отправки приложений](../publish/app-submissions.md).

<span id="code-examples"/>

## <a name="code-examples"></a>Примеры кода

В примерах кода в этом разделе показано, как использовать API-интерфейсы в пространстве имен [**Windows.Services.Store**](https://docs.microsoft.com/uwp/api/windows.services.store) для получения сведений о надстройках с подпиской для текущего приложения и запроса покупки надстройки с подпиской от имени текущего пользователя.

Для этих примеров необходимо выполнение следующих предварительных условий.
* Создан проект Visual Studio для приложения универсальной платформы Windows (UWP), предназначенный для **Windows 10 Anniversary Edition (10.0; сборка 14393)** и более поздних выпусков.
* У вас есть [создали отправку приложения](https://docs.microsoft.com/windows/uwp/publish/app-submissions) в центре партнеров, и это приложение опубликовано в магазине. При необходимости можно настроить приложение, чтобы его нельзя было найти в Магазине, пока вы его тестируете. Подробнее см. в [руководстве по тестированию](in-app-purchases-and-trials.md#testing).
* У вас есть [создания надстройки с подпиской для приложения](../publish/add-on-submissions.md) в центре партнеров.

В коде из этих примеров предполагается следующее.
* В файле кода используются операторы **using** для пространств имен **Windows.Services.Store** и **System.Threading.Tasks**.
* Приложение — однопользовательское и выполняется только в контексте пользователя, запустившего его. Подробнее см. в разделе [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md#api_intro).

> [!NOTE]
> Если у вас есть классическое приложение, которое использует [мост для классических приложений](https://developer.microsoft.com/windows/bridges/desktop), вам может потребоваться добавить дополнительный код, не показанный в этих примерах, для настройки объекта [**StoreContext**](https://docs.microsoft.com/uwp/api/Windows.Services.Store.StoreContext). Дополнительные сведения см. в разделе [Использование класса StoreContext в классическом приложении, в котором применяется мост для классических приложений](in-app-purchases-and-trials.md#desktop).

### <a name="purchase-a-subscription-add-on"></a>Покупка надстройки с подпиской

В этом примере показано, как запросить приобретение известной подписки на надстройку для вашего приложения от имени текущего пользователя. В этом примере также показано, как обрабатывать ситуации, в которых у подписки есть пробный период.

1. Код сначала определяет, есть ли у клиента уже активная лицензия для подписки. Если у клиента уже есть активная лицензия, ваш код должен разблокировать возможности подписки согласно необходимости (так как это уникально в каждом приложении, этот фрагмент обозначен в примере комментарием).
2. Затем код получает объект [**StoreProduct**](https://docs.microsoft.com/uwp/api/windows.services.store.storeproduct), представляющий подписку, которую требуется приобрести от имени пользователя. Предполагается, что вы уже знаете [код продукта в Store](in-app-purchases-and-trials.md#store-ids) для подписки на надстройку, которую требуется приобрести, и уже присвоили это значение переменной *subscriptionStoreId*.
3. Затем код определяет, доступна ли пробная версия подписки. Кроме того ваше приложение может использовать эти сведения для отображения информации о доступной пробной версии или полной подписке для пользователя.
4. Наконец, код вызывает метод [**RequestPurchaseAsync**](https://docs.microsoft.com/uwp/api/windows.services.store.storeproduct.RequestPurchaseAsync) для запроса приобретения подписки. Если доступна пробная версия подписки, она будет предложена пользователю для приобретения. В противном случае будет предложена полная версия подписки.

> [!div class="tabbedCodeSnippets"]
[!code-cs[Subscriptions](./code/InAppPurchasesAndLicenses_RS1/cs/PurchaseSubscriptionAddOnTrialPage.xaml.cs#PurchaseTrialSubscription)]

### <a name="get-info-about-subscription-add-ons-for-the-current-app"></a>Получение информации о надстройках с подпиской для текущего приложения

В этом примере кода показано, как получить сведения обо всех надстройках с подпиской, доступных в вашем приложении. Чтобы получить эти сведения, сначала используйте метод [**GetAssociatedStoreProductsAsync**](https://docs.microsoft.com/uwp/api/Windows.Services.Store.StoreContext.GetAssociatedStoreProductsAsync), чтобы получить коллекцию объектов [**StoreProduct**](https://docs.microsoft.com/uwp/api/Windows.Services.Store.StoreProduct), представляющих каждую из доступных надстроек для приложения. Затем получите [**StoreSku**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku) для каждого продукта и используйте свойства [**IsSubscription**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku.IsSubscription) и [**SubscriptionInfo**](https://docs.microsoft.com/uwp/api/windows.services.store.storesku.SubscriptionInfo) для доступа к сведениям о подписке.

> [!div class="tabbedCodeSnippets"]
[!code-cs[Subscriptions](./code/InAppPurchasesAndLicenses_RS1/cs/GetSubscriptionAddOnsPage.xaml.cs#GetSubscriptions)]

<span id="manage-subscriptions" />

## <a name="manage-subscriptions-from-your-services"></a>Управление подписками из ваших служб

После того как ваше обновленное приложение появится в Магазине и пользователи смогут покупать надстройку с подпиской, возможно, возникнут ситуации, в которых вам потребуется управлять подпиской пользователя. Мы предоставляем API-интерфейсы REST, которые можно вызывать из ваших служб для выполнения следующих задач по управления подпиской.

* [Получение подписок, на которые у пользователя есть права](get-subscriptions-for-a-user.md). Если ваша подписка является частью кроссплатформенной службы, можно вызвать этот API, чтобы определить, имеет ли указанный пользователь право на подписку, и состояние подписки в контексте вашего приложения UWP. Затем эти сведения можно использовать для обновления состояния подписки на других платформах, поддерживаемых вашей службой.

* [Изменение состояния выставления счетов за подписку для пользователя](change-the-billing-state-of-a-subscription-for-a-user.md). Используйте этот API, чтобы отменить, расширить, компенсировать или отключить автоматическое возобновление для подписки.

## <a name="cancellations"></a>Отмены

Пользователи могут использовать страницу [http://account.microsoft.com/services](http://account.microsoft.com/services) в учетной записи Майкрософт для просмотра всех приобретенных подписок, отмены подписки и изменения способа оплаты, связанного с подпиской. Если пользователь отменяет подписку с помощью этой страницы, он по-прежнему имеет доступ к этой подписке в течение текущего периода выставления счетов. Он не получает возврат денежных средств за какую-либо часть текущего периода выставления счетов. В конце текущего периода выставления счетов подписка будет отключена.

Также можно отменить подписку от имени пользователя с помощью нашего API-интерфейса REST для [изменения состояния выставления счетов для данного пользователя](change-the-billing-state-of-a-subscription-for-a-user.md).

## <a name="subscription-renewals-and-grace-periods"></a>Обновление подписки и периоды отсрочки

В определенный момент в каждом периоде выставления счетов мы попытаемся снять с кредитной карты клиента сумму за следующий период выставления счетов. В случае отказа подписка клиента переходит в состояние *dunning*. Это означает, что подписка по-прежнему активна в течение оставшейся части текущего периода выставления счетов, но мы будем периодически пытаться снять с кредитной карты соответствующую сумму для автоматического продления подписки. Это состояние может длиться до двух недель, пока не истечет текущий период выставления счетов и не наступит дата продления для следующего периода выставления счетов.

Мы не предлагаем периоды отсрочки при выставлении счетов по подпискам. Если нам не удается получить оплату с кредитной карты пользователя к окончанию текущего периода выставления счетов, подписка отменяется, и пользователь больше не имеет доступа к подписке после окончания текущего периода выставления счетов.

## <a name="unsupported-scenarios"></a>Неподдерживаемые сценарии

Следующие сценарии не поддерживаются для надстроек с подпиской.

* В настоящее время не поддерживается продажа подписок пользователям напрямую в Магазине. Подписки доступны только для покупок цифровых продуктов из приложения.
* Пользователи не могут менять периоды подписки на странице [http://account.microsoft.com/services](http://account.microsoft.com/services) своей учетной записи Майкрософт. Чтобы переключиться на другой период подписки, клиентам необходимо отменить свою текущую подписку и затем приобрести подписку с другим периодом из вашего приложения.
* Переключение уровней для надстроек с подпиской в настоящее время не поддерживается (например, переход с базовой подписки на подписку уровня Премиум с увеличенным числом функций).
* [Продажи](../publish/put-apps-and-add-ons-on-sale.md) и [рекламные коды](../publish/generate-promotional-codes.md) для надстроек с подпиской в настоящее время не поддерживаются.


## <a name="related-topics"></a>Еще по теме:

* [Покупки из приложения и пробные версии](in-app-purchases-and-trials.md)
* [Получение информации о продукте для приложений и надстроек](get-product-info-for-apps-and-add-ons.md)
