---
author: mcleanbyron
ms.assetid: F45E6F35-BC18-45C8-A8A5-193D528E2A4E
description: "Узнайте, как включить покупки из приложения и пробные версии в приложениях UWP."
title: "Покупки из приложения и пробные версии"
translationtype: Human Translation
ms.sourcegitcommit: 5f975d0a99539292e1ce91ca09dbd5fac11c4a49
ms.openlocfilehash: 99143d48a5f2155b0a47008574d0a78243dea925

---

# Покупки из приложения и пробные версии

Пакет Windows SDK предоставляет API, которые можно использовать для добавления функций совершения покупок из приложения и пробных версий в ваше приложение UWP, чтобы получать доход от приложения и расширять его функциональность. Эти API также предоставляют доступ к лицензионной информации вашего приложения.

Для этих сценариев Windows 10 предлагает два разных API.

* API для покупок из приложения и лицензионных сведений в пространстве имен [Windows.ApplicationModel.Store](https://msdn.microsoft.com/library/windows/apps/windows.applicationmodel.store.aspx) поддерживается во всех версиях Windows10.

* В Windows 10 (версия 1607) впервые появился альтернативный API для покупок из приложения и лицензионных сведений в пространстве имен [Windows.Services.Store](https://msdn.microsoft.com/library/windows/apps/windows.services.store.aspx).  

Несмотря на то что API в этих пространствах имен служат тем же целям, они различаются принципами разработки и имеют несовместимый код. Если ваше приложение предназначено для Windows 10 (версия 1607) или выше, рекомендуется использовать пространство имен **Windows.Services.Store**. Это пространство имен поддерживает новейшие типы надстроек, включая потребляемые надстройки, управляемые Магазином, а его архитектура обеспечивает совместимость с будущими продуктами и компонентами, которые поддерживаются Центром разработки Windows и Магазином. Пространство имен **Windows.Services.Store** также отличается повышенной производительностью.

В этой статье содержатся вводные сведения о покупках из приложения для приложений UWP и обзор пространства имен **Windows.Services.Store**, доступного в Windows 10 версии 1607 и выше. Сведения об использовании элементов в пространстве имен **Windows.ApplicationModel.Store** см. в разделе [Внутренние покупки приложения и пробные версии, использующие пространство имен Windows.ApplicationModel.Store](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md).


## Обзор покупок из приложения в приложениях UWP

В этом разделе описаны основные принципы осуществления покупок из приложений и использования пробных версий в приложениях UWP в Магазине. Большая часть сказанного здесь актуальна для обоих пространств имен: **Windows.Services.Store** и **Windows.ApplicationModel.Store**.

Каждый элемент, предлагаемый в Магазине, как правило, называется *продукт*. Большинство разработчиков работают со следующими типами продуктов: *приложения* и *надстройки* (которые также известны под названием «продукты из приложения» или API). Надстройкой называют продукт или функцию, которую вы предоставляете своим клиентам (пользователям) в контексте приложения. Надстройка может представлять любую функциональную возможность, предлагаемую клиентам в приложении: например, валюту для использования в приложении или игре, новые карты или оружие для игры, возможность использовать приложение без рекламы, а также цифровое содержимое (музыку или видео) для приложений, в которых реализована возможность предоставления такого типа содержимого.

С каждым приложением и каждой надстройкой связана лицензия, указывающая, имеет ли пользователь право на использование приложения или надстройки. Если пользователь имеет право на использование приложения или надстройки в качестве пробной версии, лицензия также предоставляет дополнительную информацию об этой пробной версии.

Чтобы предложить надстройку пользователям вашего приложения, сначала [определите надстройки для вашего приложения на информационной панели Центра разработки](https://msdn.microsoft.com/windows/uwp/publish/iap-submissions). Затем напишите код в своем приложении, чтобы определить, имеет ли пользователь лицензию на использование функции, реализованной в надстройке, и предложить пользователю приобрести надстройку (в качестве покупки из приложения), если лицензия на нее отсутствует. Примеры, демонстрирующие выполнение соответствующих задач с использованием пространства имен **Windows.Services.Store** в приложениях для Windows 10 (версия 1607 и выше), доступны в следующих статьях.

* [Получение информации о продукте для приложений и надстроек](get-product-info-for-apps-and-add-ons.md)
* [Получение информации о лицензии для приложений и надстроек](get-license-info-for-apps-and-add-ons.md)
* [Поддержка покупок приложений и расширений внутри приложения](enable-in-app-purchases-of-apps-and-add-ons.md)
* [Поддержка покупок потребляемых надстроек](enable-consumable-add-on-purchases.md)
* [Реализация пробной версии приложения](implement-a-trial-version-of-your-app.md)

Примеры, демонстрирующие выполнение соответствующих задач с использованием пространства имен **Windows.ApplicationModel.Store**, доступны в статье [Внутренние покупки приложения и пробные версии, использующие пространство имен Windows.ApplicationModel.Store](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md).

Все разработчики могут создавать следующие типы надстроек.

| Тип надстройки |  Описание  |
|---------|-------------------|
| Надстройка длительного пользования  |  Надстройка, которая существует в течение срока, указанного вами на [информационной панели Центра разработки для Windows](https://msdn.microsoft.com/windows/uwp/publish/enter-iap-properties). <p/><p/>По умолчанию срок действия надстроек длительного пользования никогда не истекает, а приобрести их можно только один раз. Если указать для надстройки определенный срок действия, пользователь сможет повторно приобрести ее по окончании срока действия.  |
| Потребляемые надстройки, управляемые разработчиком  |  Надстройка, которую можно приобрести, использовать и приобрести снова. Этот тип надстройки, как правило, используется для валюты в приложении. <p/><p/>Для этого типа потребляемых надстроек вы отвечаете за отслеживание баланса пользователя по продуктам, представляемым надстройкой, а также за сообщение Магазину о том, что купленная надстройка израсходована, после того как пользователь израсходует все элементы. Пользователь не может снова приобрести надстройку, пока ваше приложение не сообщит об израсходовании предыдущей покупки. <p/><p/>Например, если ваша надстройка представляет 100 игровых монет и пользователь израсходовал 10 монет, ваше приложение или служба должны поддерживать для пользователя новый баланс остатка в 90 монет. Когда пользователь израсходует все 100 монет, ваше приложение должно сообщить, что надстройка израсходована, после чего пользователь снова сможет приобрести 100 монет из надстройки.    |
| Потребляемые надстройки, управляемые Магазином  |  Надстройка, которую можно приобрести, использовать и приобрести снова. Этот тип надстройки, как правило, используется для валюты в приложении.<p/><p/>Для этого типа потребляемых надстроек учет баланса пользователя производится Магазином. Когда пользователь использует какие-либо элементы, вы должны сообщить Магазину, что эти элементы израсходованы, после чего Магазин обновляет баланс пользователя. Приложение может в любой момент запросить текущий баланс пользователя. Когда пользователь израсходует все элементы, он снова может приобрести надстройку.  <p/><p/> Например, если надстройка представляет начальную сумму в 100 игровых монет и пользователь израсходовал 10 монет, приложение сообщает Магазину, что израсходованы 10 единиц надстройки, и Магазин обновляет баланс. Когда пользователь израсходует все 100 монет, он сможет снова купить 100 монет надстройки. <p/><p/> **Потребляемые надстройки, управляемые Магазином, доступны начиная с Windows 10 (версия 1607). Скоро будет реализована возможность создавать потребляемые надстройки, управляемые Магазином, на информационной панели Центра разработки для Windows.**  |

<span />

>**Примечание.**&nbsp;&nbsp;Другие типы надстроек, например надстройки длительного пользования с пакетами (также известны как «загружаемое содержимое» или DLC), доступны ограниченному кругу разработчиков и не освещаются в этой документации.

<span id="api_intro" />
## Вводные сведения о пространстве имен Windows.Services.Store

Главной точкой входа в пространство имен **Windows.Services.Store** является класс [StoreContext](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx). Этот класс предоставляет методы, которые можно использовать, чтобы получить сведения о текущем приложении и его доступных надстройках, приобрести приложение или надстройку для текущего пользователя, получить лицензионные сведения о текущем приложении или его надстройках и решить другие задачи. Чтобы получить объект [StoreContext](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx), выполните одно из следующих действий.

* В однопользовательском приложении (то есть приложении, которое работает только в контексте пользователя, который запустил это приложение) воспользуйтесь методом [GetDefault](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.getdefault.aspx), чтобы получить объект **StoreContext**, который можно использовать для доступа к актуальным для пользователя данным, связанным с Магазином Windows, и управлять ими. Большинство приложений UWP— это однопользовательские приложения.

  ```csharp
  Windows.Services.Store.StoreContext context = StoreContext.GetDefault();
  ```

* В многопользовательском приложении используйте метод [GetForUser](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.getforuser.aspx), чтобы получить объект **StoreContext**, который можно использовать для доступа к данным, связанным с Магазином Windows, и управлять ими. Речь идет о данных для конкретного пользователя, который при работе с приложением выполнил вход с учетной записью Майкрософт. Дополнительные сведения о многопользовательских приложениях см. в разделе [Вводные сведения о многопользовательских приложениях](https://msdn.microsoft.com/windows/uwp/xbox-apps/multi-user-applications). В следующем примере мы получим объект **StoreContext** для первого доступного пользователя.

  ```csharp
  var users = await Windows.System.User.FindAllAsync();
  Windows.Services.Store.StoreContext context = StoreContext.GetForUser(users[0]);
  ```

Получив объект [StoreContext](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx), можно начинать вызывать методы для приобретения приложения или надстройки для текущего пользователя и решения других задач. Дополнительные сведения доступны в следующих статьях.

* [Получение информации о продукте для приложений и надстроек](get-product-info-for-apps-and-add-ons.md)
* [Получение информации о лицензии для приложений и надстроек](get-license-info-for-apps-and-add-ons.md)
* [Поддержка покупок приложений и расширений внутри приложения](enable-in-app-purchases-of-apps-and-add-ons.md)
* [Поддержка покупок потребляемых надстроек](enable-consumable-add-on-purchases.md)
* [Реализация пробной версии приложения](implement-a-trial-version-of-your-app.md)

Полный пример, в котором показана реализация пробных версий и покупок из приложения с использованием пространства имен **Windows.Services.Store**, доступен в разделе [Пример для Магазина](https://github.com/Microsoft/Windows-universal-samples/tree/master/Samples/Store).

<span />
### Объектная модель для продуктов, SKU и доступности

Каждый продукт в Магазине имеет по меньшей мере одну *SKU*, а каждая SKU— по меньшей мере одну *доступность*. Разработчики избавлены от необходимости работать с этими абстрактными концепциями на информационной панели Центра разработки для Windows, и большинство разработчиков никогда не определяют SKU или доступности для своих приложений или надстроек. Поскольку объектная модель для продуктов из Магазина в пространстве имен **Windows.Services.Store** все же содержит SKU и доступности, общие сведения об этих понятиях будут вам полезны.

| Тип объекта |  Описание  |
|---------|-------------------|
| Продукт  |  Класс [StoreProduct](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeproduct.aspx) представляет любой тип продукта, который доступен в Магазине, включая приложение или надстройку. Этот класс предоставляет свойства, которые можно использовать для получения доступа к данным, таким как код продукта в Магазине, изображения и видео для описания в Магазине и сведения о ценах. Кроме того, класс предоставляет методы, которые можно использовать для приобретения продукта. |
| SKU |  Класс [StoreSku](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storesku.aspx) представляет *SKU* для продукта. SKU— это конкретная версия продукта с уникальным описанием, ценой и прочими сведениями. У каждого приложения или надстройки имеется SKU по умолчанию. Единственный случай, когда разработчик может иметь несколько SKU для приложения, это если публикуется и полная, и пробная версии приложения (в каталоге Магазина каждая из этих версий будет иметь свою SKU одного и того же приложения). <p/><p/> Некоторые издатели могут определять собственные SKU. Например, крупный издатель игр может выпустить игру с одной SKU для стран, где показывать кровь красным запрещено и, следовательно, нужно показать ее зеленым цветом, а другую SKU— чтобы показывать кровь красной в любых странах. Кроме того, издатель, продающий цифровое видеосодержимое, может опубликовать две SKU для видео: одну— для версии высокой четкости, а другую— для версии стандартной четкости. <p/><p/> Каждый продукт имеет свойство [Skus](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeproduct.skus.aspx), которое можно использовать для доступа к SKU. |
| Доступность  |  Класс [StoreAvailability](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeavailability.aspx) представляет *доступность* для SKU. Доступность— это конкретная версия SKU с уникальной ценовой информацией. Каждая SKU имеет доступность по умолчанию. Некоторые издатели имеют возможность определять собственные доступности, предлагая разные ценовые варианты для данной SKU. <p/><p/> Каждая SKU имеет свойство [Availabilities](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storesku.availabilities.aspx), которое можно использовать для доступа к доступности. Для большинства разработчиков каждая SKU имеет одну доступность по умолчанию.  |

<span id="store_ids" />
### Коды продукта в Магазине

С каждым приложением и каждой надстройкой в Магазине связан специальный **код продукта в Магазине**. Многие API в пространстве имен **Windows.Services.Store** требуют указания кода продукта в Магазине для выполнения операции с приложением или надстройкой. Продукты, SKU и доступности имеют код продукта в Магазине разных форматов.

| Тип объекта |  Формат кода продукта в Магазине  |
|---------|-------------------|
| Продукт  |  Код любого продукта в Магазине— это буквенно-цифровая строка, состоящая из 12 символов, например ```9NBLGGH4R315```. Код приложения или надстройки в Магазине доступен на информационной панели Центра разработки для Windows и возвращается объектом [StoreProduct](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeproduct.storeid.aspx) свойства [StoreId](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeproduct.aspx). Этот идентификатор иногда называется *кодом продукта в Магазине*. |
| SKU |  Код SKU в Магазине имеет формат ```<product Store ID>/xxxx```, где ```xxxx```— это буквенно-цифровая строка из 4 символов, идентифицирующая SKU для продукта. Например, ```9NBLGGH4R315/000N```. Этот идентификатор возвращается свойством [StoreId](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storesku.storeid.aspx) объекта [StoreSku](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storesku.aspx) и иногда называется *кодом SKU в Магазине*. |
| Доступность  |  Код доступности в Магазине имеет формат ```<product Store ID>/xxxx/yyyyyyyyyyyy```, где ```xxxx```— это буквенно-цифровая строка из 4 символов, которая определяет SKU для продукта, а ```yyyyyyyyyyyy```— это буквенно-цифровая строка из 12 символов, которая определяет доступность для SKU. Например, ```9NBLGGH4R315/000N/4KW6QZD2VN6X```. Этот идентификатор возвращается свойством [StoreId](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeavailability.storeid.aspx) объекта [StoreAvailability](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storeavailability.aspx) и иногда называется *кодом доступности в Магазине*.  |

<span id="testing" />
### Тестирование приложений, использующих пространство имен Windows.Services.Store

Пространство имен **Windows.Services.Store** не предоставляет класс, который можно использовать для имитации лицензионных сведений во время тестирования. Вместо этого необходимо опубликовать приложение в Магазине и скачать его на свое устройство разработки, чтобы использовать его лицензию для тестирования. В приложениях, использующих пространство имен **Windows.ApplicationModel.Store**, действует несколько другой принцип, поскольку эти приложения могут использовать класс [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766) для моделирования лицензионных сведений во время тестирования.

Если приложение использует API в пространстве имен **Windows.Services.Store** для доступа к информации для вашего приложения и его надстроек, выполните следующие инструкции, чтобы протестировать код.

1. Если приложение уже опубликовано и доступно в Магазине и требуется обновить это приложение для использования API в пространстве имен **Windows.Services.Store**, вы готовы приступить. Если нужно предложить надстройки для приложения, обязательно [определите надстройки для своего приложения](https://msdn.microsoft.com/windows/uwp/publish/iap-submissions) на информационной панели Центра разработки.

  Если у вас еще нет опубликованного и доступного в Магазине приложения, создайте базовое приложение, соответствующее минимальным требованиям [комплекта сертификации приложений для Windows](https://developer.microsoft.com/windows/develop/app-certification-kit) и [отправьте это приложение](https://msdn.microsoft.com/windows/uwp/publish/app-submissions) на информационную панель Центра разработки для Windows. Если вы хотите предложить надстройки для приложения, обязательно [определите надстройки для своего приложения](https://msdn.microsoft.com/windows/uwp/publish/iap-submissions). Кроме того, на время тестирования [приложение можно скрыть из Магазина](https://msdn.microsoft.com/windows/uwp/publish/set-app-pricing-and-availability).

2. Создайте в своем приложении код, который использует один из методов [StoreContext](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx) в пространстве имен **Windows.Services.Store**, чтобы выполнить такие задачи, как [обеспечение доступности надстроек для текущего приложения](get-product-info-for-apps-and-add-ons.md), [приобретение приложения или надстройки](enable-in-app-purchases-of-apps-and-add-ons.md) и [получение лицензионных сведений для приложения](get-license-info-for-apps-and-add-ons.md). См. другие примеры в разделе «Связанные статьи» ниже.

3. В Visual Studio щелкните **Меню проекта**, укажите на **Магазин** и выберите **Связать приложение с Магазином**. Выполните инструкции мастера, чтобы связать проект приложения с приложением в вашей учетной записи Центра разработки для Windows, которое требуется использовать для тестирования.

  >**Примечание.**&nbsp;&nbsp;Если не связать свой проект с приложением в Магазине, методы[StoreContext](https://msdn.microsoft.com/library/windows/apps/windows.services.store.storecontext.aspx) присвоят свойству **ExtendedError** возвращаемых значений этих методов значение кода ошибки 0x803F6107. Это значение указывает, что Магазин ничего не знает об этом приложении.

4. Если вы еще не сделали этого, установите приложение из Магазина (см. предыдущий шаг), запустите приложение один раз и затем закройте его. Это гарантирует, что на устройстве разработки установлена действующая лицензия приложения.

5. Запустите свой проект или начните его отладку в Visual Studio. Код должен извлечь данные приложения и надстройки из приложения Магазина, которое вы связали с локальным проектом. В ответ на предложение переустановить приложение выполните инструкции, а затем запустите свой проект или начните его отладку.

## Связанные статьи

* [Получение информации о продукте для приложений и надстроек](get-product-info-for-apps-and-add-ons.md)
* [Получение информации о лицензии для приложений и надстроек](get-license-info-for-apps-and-add-ons.md)
* [Поддержка покупок приложений и расширений внутри приложения](enable-in-app-purchases-of-apps-and-add-ons.md)
* [Поддержка покупок потребляемых расширений внутри приложения](enable-consumable-add-on-purchases.md)
* [Реализация пробной версии приложения](implement-a-trial-version-of-your-app.md)
* [Внутренние покупки приложения и пробные версии, использующие пространство имен Windows.ApplicationModel.Store](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md)



<!--HONumber=Aug16_HO5-->


