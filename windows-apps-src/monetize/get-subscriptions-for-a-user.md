---
author: Xansky
ms.assetid: 94B5B2E9-BAEE-4B7F-BAF1-DA4D491427D7
description: Используйте этот метод в API покупок Microsoft Store для получения подписок, на которые имеет право определенный пользователь.
title: Получение подписок для пользователя
ms.author: mhopkins
ms.date: 07/10/2018
ms.topic: article
keywords: windows 10, uwp, API покупок Microsoft Store, подписки
ms.localizationpriority: medium
ms.openlocfilehash: b8fe6262ca6ef52ca94ade2c56b18f5e71951f07
ms.sourcegitcommit: e814a13978f33654d8e995584f4b047cb53e0aef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2018
ms.locfileid: "6051939"
---
# <a name="get-subscriptions-for-a-user"></a>Получение подписок для пользователя

Используйте этот метод в API покупок Microsoft Store для получения надстроек подписки, на которые имеет право определенный пользователь.

> [!NOTE]
> Этот метод может использоваться только учетными записями разработчиков, которые были выделены корпорацией Майкрософт для создания надстроек с подпиской для приложений универсальной платформы Windows (UWP). Надстройки подписки недоступны в настоящее время большинству учетных записей разработчика.

## <a name="prerequisites"></a>Что вам понадобится

Для использования этого метода вам понадобится:

* Маркер доступа Azure AD, имеющий значение URI аудитории `https://onestore.microsoft.com`.
* Ключ идентификатора Microsoft Store, представляющий идентификатор пользователя, подписки которого вы хотите получить.

Дополнительные сведения см. в разделе [Управление правами на продукты из службы](view-and-grant-products-from-a-service.md).

## <a name="request"></a>Запрос


### <a name="request-syntax"></a>Синтаксис запроса

| Метод | URI запроса                                            |
|--------|--------------------------------------------------------|
| POST   | ```https://purchase.mp.microsoft.com/v8.0/b2b/recurrences/query``` |


### <a name="request-header"></a>Заголовок запроса

| Заголовок         | Тип   | Описание      |
|----------------|--------|-------------------|
| Authorization  | string | Обязательный. Маркер доступа Azure AD в формате **Bearer** &lt;*token*&gt;.                           |
| Host           | строка | Должен иметь значение **purchase.mp.microsoft.com**.                                            |
| Content-Length | Число | Длина текста запроса.                                                                       |
| Content-Type   | Строка | Указывает тип запросов и ответов. На данный момент единственным поддерживаемым значением является **application/json**. |


### <a name="request-body"></a>Тело запроса

| Параметр      | Тип   | Описание     | Обязательные |
|----------------|--------|-----------------|----------|
| b2bKey         | строка | [Ключ идентификатора Microsoft Store](view-and-grant-products-from-a-service.md#step-4), представляющий идентификатор пользователя, чьи подписки вам нужно получить.  | Да      |
| continuationToken |  Строка     |  Если у пользователя есть права на несколько подписок, текст ответа возвращает маркер продолжения по достижении лимита для страницы. Укажите здесь этот маркер продолжения, чтобы в последующих вызовах получить информацию об оставшихся продуктах.    | Нет      |
| pageSize       | Строка | Максимальное количество подписок, возвращаемых в одном ответе. Значение по умолчанию:25.     |  Нет      |


### <a name="request-example"></a>Пример запроса

Приведенный ниже пример демонстрирует, как использовать этот метод для получения надстроек подписки, на которые имеет право определенный пользователь. Замените значение *b2bKey* [ключом идентификатора Microsoft Store](view-and-grant-products-from-a-service.md#step-4), представляющим идентификатор пользователя, подписки которого вы хотите получить.

```json
POST https://purchase.mp.microsoft.com/v8.0/b2b/recurrences/query HTTP/1.1
Authorization: Bearer <your access token>
Content-Type: application/json
Host: https://purchase.mp.microsoft.com

{
  "b2bKey":  "eyJ0eXAiOiJ..."
}
```


## <a name="response"></a>Ответ

Этот метод возвращает текст ответа JSON с коллекцией объектов данных, описывающих надстройки подписки, на которые есть права у пользователя. В следующем примере показан текст ответа для пользователя, имеющего право на одну подписку.

```json
{
  "items": [
    {
      "autoRenew":true,
      "beneficiary":"pub:gFVuEBiZHPXonkYvtdOi+tLE2h4g2Ss0ZId0RQOwzDg=",
      "expirationTime":"2017-06-11T03:07:49.2552941+00:00",
      "id":"mdr:0:bc0cb6960acd4515a0e1d638192d77b7:77d5ebee-0310-4d23-b204-83e8613baaac",
      "lastModified":"2017-01-08T21:07:51.1459644+00:00",
      "market":"US",
      "productId":"9NBLGGH52Q8X",
      "skuId":"0024",
      "startTime":"2017-01-10T21:07:49.2552941+00:00",
      "recurrenceState":"Active"
    }
  ]
}
```


### <a name="response-body"></a>Текст ответа

Текст ответа содержит следующие данные.

| Значение        | Тип   | Описание            |
|---------------|--------|---------------------|
| items | Массив | Массив объектов, содержащий данные о каждой надстройке подписки, на которую имеет право указанный пользователь. Дополнительные сведения о данных в каждом объекте см. в следующей таблице.  |


Каждый объект в массиве *items* содержит следующие значения.

| Значение        | Тип   | Описание                                                                 |
|---------------|--------|-----------------------------------------------|
| autoRenew | Логическое |  Указывает, настроено ли в подписке автоматическое продление в конце текущего периода.   |
| beneficiary | Строка |  Идентификатор бенефициара права, связанного с этой подпиской.   |
| expirationTime | Строка | Дата и время завершения подписки в формате ISO 8601. Это поле доступно только при определенных состояниях подписки. Время окончания срока действия обычно означает окончание срока действия текущего состояния. Например, для активной подписки дата окончания срока действия указывает, когда произойдет следующее автоматическое продление.    |
| expirationTimeWithGrace | string | Дата и время подписки истекает период отсрочки, в том числе в формате ISO 8601. Это значение указывает, когда пользователи потеряют доступ к подписке, после сбоя для автоматического продления подписки.    |
| id | Строка |  Идентификатор подписки. Используйте это значение для подписки, которую вы хотите изменить при вызове метода [изменение состояния выставления счетов подписки для пользователя](change-the-billing-state-of-a-subscription-for-a-user.md).    |
| isTrial | Логическое |  Указывает, является ли подписка пробной версией.     |
| lastModified | Строка |  Дата и время последнего изменения подписки в формате ISO 8601.      |
| market | Строка | Код страны (в двухбуквенном формате ISO 3166-1 alpha-2), в которой пользователь приобрел подписку.      |
| productId | Строка |  [Код продукта в Store](in-app-purchases-and-trials.md#store-ids) для [продукта](in-app-purchases-and-trials.md#products-skus-and-availabilities), который представляет надстройку подписки в каталоге Microsoft Store. Пример кода продукта в Store: 9NBLGGH42CFD.     |
| skuId | Строка |  [Код продукта в Store](in-app-purchases-and-trials.md#store-ids) для [номера SKU](in-app-purchases-and-trials.md#products-skus-and-availabilities), который представляет надстройку подписки в каталоге Microsoft Store. Пример кода продукта в Store для номера SKU: 0010.    |
| startTime | Строка |  Дата и время начала для подписки в формате ISO 8601.     |
| recurrenceState | Строка  |  Принимает одно из следующих значений:<ul><li>**None**:&nbsp;&nbsp;означает бессрочную подписку.</li><li>**Active**:&nbsp;&nbsp;подписка активна, пользователь имеет право пользоваться службами.</li><li>**Inactive**:&nbsp;&nbsp;срок действия подписки истек, пользователь отключил ее автоматическое продление.</li><li>**Canceled**:&nbsp;&nbsp;срок действия подписки намеренно прерван до даты окончания срока действия, с возмещением денежных средств или без.</li><li>**InDunning**:&nbsp;&nbsp;подписка находится в *процессе напоминания* (приближается срок окончания действия подписки, и Майкрософт пытается получить средства для ее автоматического продления).</li><li>**Failed**:&nbsp;&nbsp;период напоминания закончился, не удалось продлить подписку после нескольких попыток.</li></ul><p>**Примечание.**</p><ul><li>**Inactive**/**Canceled**/**Failed**— состояния окончания. Когда подписка переходит в одно из этих состояний, пользователь должен повторно приобрести подписку, чтобы активировать ее снова. Пользователь не имеет права работать со службами в этих состояниях.</li><li>Если состояние подписки **Canceled**, значение expirationTime будет обновлено с указанием даты и времени отмены.</li><li>Идентификатор подписки будет оставаться неизменным в течение всего времени существования. Он не меняется при включении или выключении автоматического обновления. Если пользователь повторно приобретет подписку после достижения состояния окончания, будет создан новый идентификатор подписки.</li><li>Идентификатор подписки следует использовать для выполнения любой операции с отдельной подпиской.</li><li>Когда пользователь повторно приобретет подписку после ее отмены или завершения, на запрос по такому пользователю будут возвращены две записи: одна с идентификатором старой подписки в состоянии окончания, а другая — с идентификатором новой подписки в активном состоянии.</li><li>Всегда рекомендуется проверять recurrenceState и expirationTime, так как обновления recurrenceState могут быть отложены на несколько минут (а иногда на несколько часов).       |
| cancellationDate | Строка   |  Дата и время отмены подписки пользователя в формате ISO 8601.     |


## <a name="related-topics"></a>Статьи по теме

* [Управление правами на продукты из службы](view-and-grant-products-from-a-service.md)
* [Изменение состояния выставления счетов за подписку для пользователя](change-the-billing-state-of-a-subscription-for-a-user.md)
* [Запрос продуктов](query-for-products.md)
* [Объявление потребляемого продукта в качестве выполненного](report-consumable-products-as-fulfilled.md)
* [Обновление ключа идентификатора Microsoft Store](renew-a-windows-store-id-key.md)
