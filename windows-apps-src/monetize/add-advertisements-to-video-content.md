---
author: Xansky
ms.assetid: cc24ba75-a185-4488-b70c-fd4078bc4206
description: Узнайте, как использовать класс AdScheduler для показа рекламы в видеосодержимом.
title: Показ рекламы в видеосодержимом
ms.author: mhopkins
ms.date: 03/22/2018
ms.topic: article
keywords: windows 10, uwp, реклама, рекламные материалы, видео, планировщик, javascript
ms.localizationpriority: medium
ms.openlocfilehash: 158817aa0abea1ddb1247188ec69389a7682e899
ms.sourcegitcommit: cd00bb829306871e5103db481cf224ea7fb613f0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/31/2018
ms.locfileid: "5867174"
---
# <a name="show-ads-in-video-content"></a>Показ рекламы в видеосодержимом

В этом пошаговом руководстве показано, как использовать класс **AdScheduler** для показа рекламы в видеосодержимом в приложении универсальной платформы Windows (UWP), написанном с использованием JavaScript и HTML.

> [!NOTE]
> Сейчас эта возможность поддерживается только для приложений UWP, написанных с использованием JavaScript и HTML.

Класс **AdScheduler** работает с прогрессивным и потоковым мультимедиа и использует форматы полезной нагрузки VAST 2.0/3.0 и VMAP. Благодаря использованию стандартов **AdScheduler** не зависит от рекламной службы, с которой он взаимодействует.

Реклама для видеосодержимое зависит от того, превышает ли длительность программа 10 минут (длинная форма) или нет (короткая форма). Хотя в первом случае настроить службу немного сложнее, в написании клиентского кода различий фактически нет. Если **AdScheduler** получает полезные данные VAST с одной рекламой вместо манифеста, они рассматриваются как манифест, который вызывается для одного предварительного рекламного ролика (один разрыв в 00:00).

## <a name="prerequisites"></a>Необходимые компоненты

* Установка [Microsoft Advertising SDK](http://aka.ms/ads-sdk-uwp) с помощью Visual Studio 2015 или более поздней версии.

* В проекте необходимо использовать элемент управления [MediaPlayer](https://github.com/Microsoft/TVHelpers/wiki/MediaPlayer-Overview), чтобы обслуживать видеосодержимое, в котором планируется показывать рекламу. Этот элемент управления доступен в коллекции библиотек [TVHelpers](https://github.com/Microsoft/TVHelpers) от корпорации Майкрософт на портале GitHub.

  Ниже показано, как объявить [MediaPlayer](https://github.com/Microsoft/TVHelpers/wiki/MediaPlayer-Overview) в разметке HTML. Как правило, эта разметка размещена в разделе `<body>` файла index.html (или другого HTML-файла, в зависимости от конкретного проекта).

  ``` html
  <div id="MediaPlayerDiv" data-win-control="TVJS.MediaPlayer">
    <video src="URL to your content">
    </video>
  </div>
  ```

  В следующем примере показано, как настроить [MediaPlayer](https://github.com/Microsoft/TVHelpers/wiki/MediaPlayer-Overview) в коде JavaScript.

  [!code-javascript[TrialVersion](./code/AdvertisingSamples/AdSchedulerSamples/js/js/main.js#Snippet1)]

## <a name="how-to-use-the-adscheduler-class-in-your-code"></a>Использование класса AdScheduler в коде

1. В Visual Studio откройте свой проект либо создайте новый.

2. Если ваш проект направлен на работу на **Любом ЦП**, обновите его, чтобы он использовал результаты сборки, предназначенные для определенной архитектуры (например **x86**). Если ваш проект направлен на работу на **Любом ЦП**, вам не удастся надлежащим образом добавить ссылку на Microsoft Advertising в приведенных ниже шагах. Дополнительные сведения см. в разделе [Ошибки, вызванные указанием Любого ЦП как целевого в вашем проекте](known-issues-for-the-advertising-libraries.md#reference_errors).

3. Добавьте в проект ссылку на библиотеку **Microsoft Advertising SDK для JavaScript**.

    1. В **Обозревателе решений** щелкните правой кнопкой мыши элемент **Ссылки** и выберите **Добавить ссылку...**.
    2. В **Диспетчере ссылок** разверните раздел **Универсальная платформа Windows**, нажмите **Расширения** и выберите флажок рядом с **Microsoft Advertising SDK для JavaScript** (версия 10.0).
    3. В **диспетчере ссылок** нажмите "ОК".

4.  Добавьте файл AdScheduler.js в проект:

    1. В Visual Studio щелкните **Проект** и выберите параметр **Управление пакетами NuGet**.
    2. В поле поиска введите **Microsoft.StoreServices.VideoAdScheduler** и установите пакет Microsoft.StoreServices.VideoAdScheduler. Файл AdScheduler.js будет добавлен в подкаталог ../js в проекте.

5.  Откройте файл index.html (или другой html-файл, в зависимости от конкретного проекта). В разделе `<head>` после ссылок на JavaScript проекта из default.css и main.js добавьте ссылку на ad.js и adscheduler.js.

    ``` html
    <script src="//Microsoft.Advertising.JavaScript/ad.js"></script>
    <script src="/js/adscheduler.js"></script>
    ```

    > [!NOTE]
    > Эта строка должна располагаться в разделе `<head>` после включения main.js. В противном случае при сборке проекта будет выдано сообщение об ошибке.

6.  В файле main.js проекта добавьте код, который создает объект **AdScheduler**. Передайте объект **MediaPlayer**, в котором размещено видеосодержимое. Код должен быть размещен так, чтобы он выполнялся после [WinJS.UI.processAll](https://docs.microsoft.com/en-us/previous-versions/windows/apps/hh440975).

    [!code-javascript[TrialVersion](./code/AdvertisingSamples/AdSchedulerSamples/js/js/main.js#Snippet2)]

7.  Используйте метод **requestSchedule** или **requestScheduleByUrl** объекта **AdScheduler** для запроса расписания рекламы с сервера и его вставки во временную шкалу **MediaPlayer**, а затем воспроизведите видео.

    * Если вы — партнер корпорации Майкрософт, который получил разрешение на запрос расписания рекламы с сервера Майкрософт, используйте **requestSchedule** и укажите идентификатор приложения и идентификатор рекламного блока, предоставленные Майкрософт.

        Этот метод принимает форму [Promise](https://docs.microsoft.com/windows/uwp/threading-async/asynchronous-programming-universal-windows-platform-apps#asynchronous-patterns-in-uwp-using-javascript), который является асинхронной конструкцией, которой передаются два указателя на функции: указатель для функции **onComplete**, которую необходимо вызвать после успешного завершения обещания и указатель для функции **onError**, которую необходимо вызвать, если возникает ошибка. В функции **onComplete** начните воспроизведение видеосодержимого. Воспроизведение рекламы начинается в запланированное время. В функции **onError** обработайте ошибку и запустите воспроизведение своего видео. Видеосодержимое будет воспроизведено без рекламы. Аргумент функции **onError** — это объект, содержащий следующие элементы.

        [!code-javascript[TrialVersion](./code/AdvertisingSamples/AdSchedulerSamples/js/js/main.js#Snippet3)]

    * Для запроса расписания рекламы от стороннего сервера используйте **requestScheduleByUrl** и передайте URI-адрес сервера. Этот метод также принимает форму **Promise**, принимающего указатели для функций **onComplete** и **onError**. Полезные данные рекламы, которые возвращаются с сервера, должны соответствовать форматам полезной нагрузки шаблона выдачи видеорекламы (VAST) или списка воспроизведения нескольких видеореклам (VMAP).

        [!code-javascript[TrialVersion](./code/AdvertisingSamples/AdSchedulerSamples/js/js/main.js#Snippet4)]

    > [!NOTE]
    > Необходимо дождаться возврата из **requestSchedule** или **requestScheduleByUrl** перед началом воспроизведения основного видеосодержимого в **MediaPlayer**. Если начать воспроизведение мультимедиа до возврата из **requestSchedule** (в случае показа рекламы перед содержимым), показ рекламы прервет воспроизведение основного видеосодержимого. Необходимо вызывать метод **play**, даже если функция завершится ошибкой, так как **AdScheduler** сообщит **MediaPlayer** о необходимости пропустить рекламу и сразу перейти к содержимому. Могут существовать другие бизнес-требования, например вставка встроенной рекламы, если удаленно получить рекламное объявление не удалось.

8.  Во время воспроизведения можно обрабатывать дополнительные события, которые позволяют приложению отслеживать ход выполнения, и (или) ошибки, которые могут возникнуть после начального процесса сопоставления рекламы. В следующем примере кода показаны некоторые из этих событий, в том числе **onPodStart**, **onPodEnd**, **onPodCountdown**, **onAdProgress**, **onAllComplete** и **onErrorOccurred**.

    [!code-javascript[TrialVersion](./code/AdvertisingSamples/AdSchedulerSamples/js/js/main.js#Snippet5)]

## <a name="adscheduler-members"></a>Элементы AdScheduler

Этот раздел содержит некоторые сведения об элементах объекта **AdScheduler**. Дополнительные сведения об этих элементах см. в примечаниях и определениях в файле AdScheduler.js вашего проекта.

### <a name="requestschedule"></a>requestSchedule

Этот метод запрашивает расписание рекламы с сервера рекламы Майкрософт и вставляет рекламу во временную шкалу **MediaPlayer**, переданную конструктору **AdScheduler**.

Необязательный третий параметр (*adTags*) — это JSON-коллекция пар имя–значение, которые могут использоваться для приложений, имеющих расширенное таргетирование. Например, приложение, которое воспроизводит несколько связанных с автомобилями видео, может дополнять идентификатор рекламного блока маркой и моделью показываемого автомобиля. Этот параметр предназначен для использования только теми партнерами, которые получили одобрение от Майкрософт на использование рекламных тегов.

Обратите внимание на следующие аспекты при использовании *adTags*:

* Этот параметр используется очень редко. Издатель должен тесно сотрудничать с Microsoft, чтобы использовать adTags.
* И имена, и значения должны быть предварительно определены в рекламной службе. Рекламные теги не относятся к неограниченному списку ключевых слов и поисковых запросов.
* Максимально допустимое число тегов равно 10.
* Имена тегов ограничены 16 символами.
* Значения тегов содержат не более 128 символов.

### <a name="requestschedulebyuri"></a>requestScheduleByUri

Этот метод запрашивает расписание рекламы со стороннего сервера рекламы, заданного в URI, и вставляет рекламу во временную шкалу **MediaPlayer**, переданную конструктору **AdScheduler**. Полезные данные рекламы, которые возвращаются сервером рекламы, должны соответствовать форматам полезной нагрузки шаблона выдачи видеорекламы (VAST) или списка воспроизведения нескольких видеореклам (VMAP).

### <a name="mediatimeout"></a>mediaTimeout

Это свойство возвращает или задает время в миллисекундах, в течение которого содержимое должно быть доступно для воспроизведения. Значение 0 сообщает системе, что время ожидания не ограничено. Значение по умолчанию — 30000 мс (30 секунд).

### <a name="playskippedmedia"></a>playSkippedMedia

Это свойство возвращает или задает **логическое** значение, указывающее, будет ли воспроизводиться запланированное мультимедийное содержимое, если пользователь переходит к точке после запланированного времени запуска.

Рекламный клиент и медиапроигрыватель будут использовать правила в отношении того, что происходит с объявлениями во время быстрой перемотки основного содержимого вперед и назад. В большинстве случаев разработчики приложений не разрешают полностью пропускать объявления, но стремятся обеспечить удобство для пользователя. Два приведенных ниже варианта соответствуют потребностям большинства разработчиков:

1. Разрешить конечным пользователям пропускать рекламные модули по своему усмотрению.
2. Разрешить пользователям пропускать рекламные модули, но воспроизвести самый ближний из пропущенных модуль при возобновлении воспроизведения.

Свойство **playSkippedMedia** имеет следующие состояния:

* Объявления невозможно пропустить или перемотать после начала его воспроизведения.
* Все рекламные материалы в модуле будут воспроизводиться после запуска модуля.
* После воспроизведения объявление не будет воспроизводиться во время просмотра основного содержимого (фильма, серии, и т. д.); маркеры объявление будет помечены как воспроизведенные или удаленные.
* Объявления перед началом воспроизведения не могут быть пропущены.

При возобновлении показа содержимого, содержащего рекламу, задайте для **playSkippedMedia** значение **false**, чтобы пропустить объявления перед началом показа и предотвратить прерывание последнего рекламного объявления. Затем, когда показ содержимого начнется, задайте для **playSkippedMedia** значение **true**, чтобы обеспечить невозможность перемотки последующих объявлений пользователем.

> [!NOTE]
> Модуль — это группа объявлений, показываемых друг за другом, как например группа объявлений, которые воспроизводятся во время рекламной паузы. Дополнительные сведения см. в разделе спецификации IAB Digital VAST.

### <a name="requesttimeout"></a>requestTimeout

Это свойство возвращает или задает число миллисекунд для ожидания ответа на запрос рекламы. Значение 0 сообщает системе, что время ожидания не ограничено. Значение по умолчанию — 30000 мс (30 секунд).

### <a name="schedule"></a>schedule

Это свойство возвращает данные расписания, полученные с сервера рекламы. Этот объект содержит полную иерархию данных, которая соответствует структуре полезных данных шаблона выдачи видеорекламы (VAST) или списка воспроизведения нескольких видеореклам (VMAP).

### <a name="onadprogress"></a>onAdProgress  

Это событие возникает, когда воспроизведение рекламы достигает контрольных точек. Второй параметр обработчика событий (*eventInfo*) — это объект JSON со следующими элементами:

* **progress**: состояние воспроизведения рекламы (одно из значений перечисления **MediaProgress**, заданных в AdScheduler.js).
* **clip**: воспроизводимый в этот момент видеоролик. Данный объект не предназначен для использования в коде.
* **adPackage**: объект, представляющий часть полезных данных рекламы, соответствующую воспроизводимому объявлению. Данный объект не предназначен для использования в коде.

### <a name="onallcomplete"></a>onAllComplete  

Это событие инициируется, когда основное содержимое достигает конца, и все запланированные объявления после окончания просмотра также завершаются.

### <a name="onerroroccurred"></a>onErrorOccurred  

Это событие возникает, когда **AdScheduler** сталкивается с ошибкой. Дополнительные сведения о значениях кодов ошибки см. в разделе [ErrorCode](https://docs.microsoft.com/uwp/api/microsoft.advertising.errorcode).

### <a name="onpodcountdown"></a>onPodCountdown

Это событие возникает, когда объявление воспроизводится, и указывает, сколько времени осталось в текущем модуле. Второй параметр обработчика событий (*eventData*) — это объект JSON со следующими элементами:

* **remainingAdTime**: оставшееся количество секунд для текущего объявления.
* **remainingPodTime**: оставшееся количество секунд для текущего модуля.

> [!NOTE]
> Модуль — это группа объявлений, показываемых друг за другом, как например группа объявлений, которые воспроизводятся во время рекламной паузы. Дополнительные сведения см. в разделе спецификации IAB Digital VAST.

### <a name="onpodend"></a>onPodEnd  

Это событие возникает при завершении рекламного модуля. Второй параметр обработчика событий (*eventData*) — это объект JSON со следующими элементами:

* **startTime**: время начала модуля в секундах.
* **pod**: объект, представляющий модуль. Данный объект не предназначен для использования в коде.

### <a name="onpodstart"></a>onPodStart

Это событие возникает при начале рекламного модуля. Второй параметр обработчика событий (*eventData*) — это объект JSON со следующими элементами:

* **startTime**: время начала модуля в секундах.
* **pod**: объект, представляющий модуль. Данный объект не предназначен для использования в коде.
