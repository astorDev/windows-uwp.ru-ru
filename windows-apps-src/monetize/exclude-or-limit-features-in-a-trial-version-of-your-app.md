---
Description: If you enable customers to use your app for free during a trial period, you can entice your customers to upgrade to the full version of your app by excluding or limiting some features during the trial period.
title: Исключение или ограничение функций в пробной версии
ms.assetid: 1B62318F-9EF5-432A-8593-F3E095CA7056
keywords: Windows 10, UWP, пробная версия, покупка из приложения, IAP, Windows.ApplicationModel.Store
ms.date: 08/25/2017
ms.topic: article
ms.localizationpriority: medium
ms.openlocfilehash: 36d7ada6567db95609203f8f163b78631e141b4f
ms.sourcegitcommit: d2517e522cacc5240f7dffd5bc1eaa278e3f7768
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2018
ms.locfileid: "8338088"
---
# <a name="exclude-or-limit-features-in-a-trial-version"></a>Исключение или ограничение функций в пробной версии

Если вы разрешаете пользователям бесплатно пользоваться вашим приложением в течение испытательного срока, можно привлечь их к обновлению до полной версии приложения путем удаления или ограничения некоторых функций в течение пробного периода. До начала программирования решите, какие функции лучше ограничить, и сделайте так, чтобы они были доступны только после покупки полной лицензии. Вы можете также включить такие компоненты, как баннеры или водяные знаки, которые будут отображаться только во время пробного периода, пока пользователь не купит приложение.

> [!IMPORTANT]
> В этой статье показано, как использовать члены пространства имен [Windows.ApplicationModel.Store](https://msdn.microsoft.com/library/windows/apps/windows.applicationmodel.store.aspx) для включения функции пробного периода. Это пространство имен больше не дополняется новыми функциями, и мы рекомендуем вместо него использовать пространство имен [Windows.Services.Store](https://msdn.microsoft.com/library/windows/apps/windows.services.store.aspx). Пространство имен **Windows.Services.Store** поддерживает новейшие типы надстроек, таких как подписки и потребляемые надстройки, управляемые магазином, а его архитектура обеспечивает совместимость с будущими продуктами и компонентами, которые поддерживаются центром партнеров и хранилище. Пространство имен **Windows.Services.Store** впервые появилось в Windows 10 версии 1607 и может использоваться только в проектах, предназначенных для **Windows 10 Anniversary Edition (10.0; сборка 14393)** или более поздней версии в Visual Studio. Дополнительные сведения о реализации функции пробного периода с помощью пространства имен **Windows.Services.Store** см. в [этой статье](implement-a-trial-version-of-your-app.md).

## <a name="prerequisites"></a>Необходимые условия

Приложение для Windows, в которое предполагается добавить компоненты для продажи.

## <a name="step-1-pick-the-features-you-want-to-enable-or-disable-during-the-trial-period"></a>Шаг 1. Выбор функций, которые вы хотите включить или выключить на время испытательного срока

Текущее состояние лицензии вашего приложения можно узнать из свойств класса [LicenseInformation](https://msdn.microsoft.com/library/windows/apps/br225157). Обычно функции, которые зависят от состояния лицензии, помещают в условный блок. Как это сделать, будет показано на следующем этапе. Разрабатывая эти функции, убедитесь, что они будут работать во всех состояниях лицензии.

Решите, каким образом вы будете обрабатывать изменения в лицензии приложения во время его работы. Ваше приложение может быть полнофункциональным, но в отличие от купленного иметь рекламные баннеры. Вы также можете запретить некоторые функции или регулярно показывать сообщения с предложением купить приложение.

Подумайте, какой способ ограничения функциональности больше всего подходит для вашего типа приложения. Для игры больше всего подойдет ограничение игрового контента, доступного пользователю. Для пробной версии служебной программы можно установить дату окончания пробного периода или ограничить некоторые функции, нужные потенциальному покупателю.

Для большинства неигровых приложений установка испытательного срока является удачным решением, так как пользователи смогут лучше разобраться в приложении в целом. Ниже приведено несколько распространенных сценариев окончания срока действия и варианты их обработки.

-   **Срок действия лицензии пробной версии истек во время работы приложения**

    Если срок действия лицензии пробной версии истек во время работы приложения, то можно:

    -   Не выполнять никаких действий.
    -   Вывести сообщение для клиента.
    -   Закрыть приложение.
    -   Предложить клиенту купить приложение.

    Рекомендуется вывести сообщение с предложением купить приложение и, если клиент его купит, включить все функции и продолжить работу. Если пользователь решит не покупать приложение, следует закрыть его или регулярно напоминать о покупке приложения.

-   **Срок действия лицензии пробной версии истек до запуска приложения**

    Если срок действия пробной версии окончится до того, как пользователь запустит программу, она не запустится. Вместо этого пользователи увидят диалоговое окно, с помощью которого они смогут приобрести ваше приложение в Магазине.

-   **Клиент покупает приложение во время его работы**

    Если клиент покупает приложение во время его работы, возможно несколько вариантов действий.

    -   Не выполнять никаких действий и предоставить клиенту возможность работать в режиме пробной версии до перезапуска приложения.
    -   Поблагодарить клиента за покупку или отобразить сообщение.
    -   Без предупреждения включить возможности, доступные в полной лицензионной версии (или отключить уведомления об использовании пробной версии).

Если вы хотите обнаруживать изменение лицензии и выполнять то или иное действие в приложении, нужно добавить обработчик событий для этого сценария, как показано на следующем этапе.

## <a name="step-2-initialize-the-license-info"></a>Шаг 2. Инициализация информации о лицензии

При инициализации приложения получите для него объект [LicenseInformation](https://msdn.microsoft.com/library/windows/apps/br225157), как показано в следующем примере. Будем считать, что **licenseInformation** является глобальной переменной или полем типа **LicenseInformation**.

На данный момент вы получите смоделированные сведения о лицензии с использованием [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766) вместо [CurrentApp](https://msdn.microsoft.com/library/windows/apps/hh779765). Перед отправкой окончательной версии приложения в **Магазин** необходимо заменить все ссылки **CurrentAppSimulator** в коде на **CurrentApp**.

> [!div class="tabbedCodeSnippets"]
[!code-cs[TrialVersion](./code/InAppPurchasesAndLicenses/cs/TrialVersion.cs#InitializeLicenseTest)]

Затем добавьте обработчик событий для получения уведомлений об изменении лицензии во время работы приложения. Лицензия приложения может изменяться — например, после окончания пробного периода или при покупке пользователем приложения в Магазине.

> [!div class="tabbedCodeSnippets"]
[!code-cs[TrialVersion](./code/InAppPurchasesAndLicenses/cs/TrialVersion.cs#InitializeLicenseTestWithEvent)]

## <a name="step-3-code-the-features-in-conditional-blocks"></a>Шаг 3. Написание кода компонентов в условных блоках

Когда возникает событие, связанное с изменением лицензии, ваше приложение должно вызвать API License, чтобы определить, изменился ли статус пробного периода. В примере кода показано, как организовать обработку этого события. Если пользователь купил приложение, рекомендуется сообщить ему об изменении состояния лицензирования. При необходимости попросите пользователя перезапустить приложение. Перевод приложения в новое состояние лицензирования должен быть максимально комфортным для пользователя.

В следующем примере показано, как оценить состояние лицензии приложения и провести соответствующее включение или выключение функции.

> [!div class="tabbedCodeSnippets"]
[!code-cs[TrialVersion](./code/InAppPurchasesAndLicenses/cs/TrialVersion.cs#ReloadLicense)]

## <a name="step-4-get-an-apps-trial-expiration-date"></a>Шаг 4. Получение даты окончания срока действия пробной версии

Включите в приложение следующий код, определяющий дату истечения пробного периода.

В этом примере приводится код функции, получающей дату окончания срока пробной версии приложения. Если лицензия еще действует, отображайте дату истечения испытательного срока и количество оставшихся до нее дней.

> [!div class="tabbedCodeSnippets"]
[!code-cs[TrialVersion](./code/InAppPurchasesAndLicenses/cs/TrialVersion.cs#DisplayTrialVersionExpirationTime)]

## <a name="step-5-test-the-features-using-simulated-calls-to-the-license-api"></a>Шаг 5. Проверка работы функций с использованием имитации вызовов лицензии API

Теперь протестируйте приложение с помощью смоделированных данных. **CurrentAppSimulator** получает информацию о лицензии для пробной версии из XML-файла WindowsStoreProxy.xml, расположенного в папке %UserProfile%\\AppData\\local\\packages\\&lt;имя пакета&gt;\\LocalState\\Microsoft\\Windows Store\\ApiData. Файл WindowsStoreProxy.xml можно отредактировать, изменив даты истечения пробного периода для вашего приложения и его компонентов. Протестируйте все возможные конфигурации лицензирования и пробных периодов и убедитесь, что все работает как надо. Дополнительные сведения см. в разделе [Использование файла WindowsStoreProxy.xml с CurrentAppSimulator](in-app-purchases-and-trials-using-the-windows-applicationmodel-store-namespace.md#proxy).

Если этот путь и файл не существуют, их нужно создать во время установки или выполнения приложения. Если файл WindowsStoreProxy.xml отсутствует в указанном выше расположении, при попытке обратиться к свойству [CurrentAppSimulator.LicenseInformation](https://docs.microsoft.com/uwp/api/windows.applicationmodel.store.currentappsimulator.licenseinformation) возникнет ошибка.

## <a name="step-6-replace-the-simulated-license-api-methods-with-the-actual-api"></a>Шаг 6. Замена сымитированных вызовов лицензии API на настоящие

После тестирования приложения с имитацией сервера лицензирования замените все **CurrentAppSimulator** элементами **CurrentApp**, как показано в следующем примере кода. После этого вы можете отправить приложение в Магазин для сертификации.

> [!IMPORTANT]
> Приложение, отправляемое в Store, должно использовать объект **CurrentApp**, иначе оно не пройдет сертификацию.

> [!div class="tabbedCodeSnippets"]
[!code-cs[TrialVersion](./code/InAppPurchasesAndLicenses/cs/TrialVersion.cs#InitializeLicenseRetailWithEvent)]

## <a name="step-7-describe-how-the-free-trial-works-to-your-customers"></a>Шаг 7. Описание работы с бесплатной пробной версией для пользователей

Не забудьте объяснить, как будет работать ваше приложение во время и после бесплатного пробного периода, чтобы поведение приложения не стало неожиданностью для клиентов.

Дополнительные сведения об описании приложения см. в разделе [Создание описаний приложений](https://msdn.microsoft.com/library/windows/apps/mt148529).

## <a name="related-topics"></a>Связанные разделы

* [Пример для Магазина (демонстрация пробных версий и покупок из приложения)](https://github.com/Microsoft/Windows-universal-samples/tree/win10-1507/Samples/Store)
* [Настройки цен и доступности приложений](https://msdn.microsoft.com/library/windows/apps/mt148548)
* [CurrentApp](https://msdn.microsoft.com/library/windows/apps/hh779765)
* [CurrentAppSimulator](https://msdn.microsoft.com/library/windows/apps/hh779766)
 

 
