---
author: eliotcowley
ms.assetid: A7E0DA1E-535A-459E-9A35-68A4150EE9F5
description: В данной статье рассказывается, как добавить аппаратное управление цифровыми правами PlayReady в приложение универсальной платформы Windows.
title: Аппаратное управление цифровыми правами (DRM)
---

# Аппаратное управление цифровыми правами (DRM)

\[ Обновлено для приложений UWP в Windows 10. Статьи, касающиеся Windows 8.x, см. в разделе [Архив](http://go.microsoft.com/fwlink/p/?linkid=619132) \]


В данной статье рассказывается, как добавить аппаратное управление цифровыми правами PlayReady в приложение универсальной платформы Windows.

**Примечание.** Аппаратное управление цифровыми правами поддерживается только на определенном оборудовании, на котором в качестве встроенного ПО используется Windows 10. Дополнительные сведения о предоставляемых гарантиях см. в статье [Правила обеспечения совместимости и надежности для PlayReady](http://www.microsoft.com/playready/licensing/compliance/).

Все чаще поставщики содержимого используют аппаратную защиту для предоставления разрешений на воспроизведение полноценного содержимого в приложениях. Для удовлетворения этих потребностей в PlayReady добавлена надежная поддержка аппаратной реализации криптографического ядра. Эта поддержка обеспечивает безопасное воспроизведение содержимого высокого (1080p) и сверхвысокого (UHD) разрешений на нескольких платформах устройств. Материал ключей (включая закрытые ключи, ключи содержимого и любой другой материал ключей, используемый для наследования или разблокировки указанных выше ключей), а также расшифрованные сжатые и несжатые примеры видео защищены с помощью аппаратной системы безопасности.

## Реализация надежной среды выполнения в Windows

В данной статье содержится краткий обзор того, как в Windows 10 реализована доверенная среда выполнения.

Предоставление подробных сведений о реализации надежной среды выполнения в Windows выходит за рамки данного документа. Тем не менее следует вкратце рассказать о разнице между стандартным портом надежной среды выполнения набора для портирования и портом Windows. Windows реализует уровень прокси-сервера изготовителя оборудования и передает сериализованные вызовы функций PRITEE в драйвер пользовательского режима в подсистеме Windows Media Foundation. В конечном счете происходит его маршрутизация либо в драйвер надежной среды выполнения в Windows, либо в графический драйвер изготовителя оборудования. Предоставление подробных сведений о каждом из этих подходов выходит за рамки данного документа. На схеме ниже показано общее взаимодействие компонентов для порта Windows. Если вы хотите разрабатывать реализации надежной среды выполнения PlayReady в Windows, обратитесь по адресу <WMLA@Microsoft.com>.

![Схема компонентов надежной среды выполнения в Windows](images/windowsteecomponentdiagram720.jpg)

## Рекомендации по использованию аппаратного управления цифровыми правами

В данной статье содержится краткий перечень того, что необходимо учесть при разработке приложений, использующих аппаратное управление цифровыми правами.

-   Технология Protected Media Process (PMP) не поддерживается.
-   Поддержка значения уровня защиты выходных данных (OPL) 270 (без ухудшения разрешения). Корпорация Microsoft рекомендует, чтобы содержимое высокого разрешения для аппаратного управления цифровыми правами имело значение показателя OPL более 270 (хотя это и необязательно). Использование значений показателя OPL больше 270 означает необходимость применения стандарта HDCP. Кроме того, корпорация Microsoft рекомендует использовать стандарт HDCP Type 1 (версия 2.2 или более поздняя).
-   В отличие от программного управления цифровыми правами защита выходных данных применяется на всех мониторах, при этом учитываются характеристики монитора с самыми худшими возможностями. Например, если у пользователя подключено два монитора, один из которых поддерживает стандарт HDCP, а другой — нет и при этом лицензия требует наличия стандарта HDCP, то не удастся воспроизвести содержимое даже если предполагается воспроизводить его только на мониторе, поддерживающем этот стандарт. При использовании программного управления цифровыми правами можно воспроизводить содержимое при условии, что оно будет отображаться только на мониторе, поддерживающем стандарт HDCP.
-   Чтобы аппаратное управление цифровыми правами гарантированно использовалось в клиенте и обеспечивало защиту, должны быть выполнены указанные ниже условия для ключей содержимого и лицензий.
    -   Звук должен быть незашифрованным. Если он зашифрован, то звук и видео должны быть зашифрованы с использованием разных ключей содержимого. Для повышения производительности во время воспроизведения корпорация Microsoft рекомендует использовать незашифрованный звук.
    -   Лицензия, используемая для ключа содержимого видео должна иметь уровень безопасности 3000.
-   При использовании сохраняемых лицензий отсутствует поддержка нескольких графических процессоров (GPU).

Для обработки сохраняемых лицензий на компьютерах с несколькими графическими процессорами (GPU) можно использовать указанный ниже сценарий.

1.  Клиент покупает новый компьютер со встроенной графической картой.
2.  Клиент использует приложение, которое получает сохраняемые лицензии при использовании аппаратного управления цифровыми правами.
3.  Теперь сохраняемая лицензия связана с ключами оборудования этой графической карты.
4.  Затем клиент устанавливает новую графическую карту.
5.  Все лицензии в хранилище хэшированных данных связаны со встроенной графической картой, но теперь клиенту необходимо воспроизвести защищенное содержимое с помощью новой графической карты.

Чтобы предотвратить сбой воспроизведения из-за невозможности расшифровки лицензий оборудованием, PlayReady использует отдельное хранилище хэшированных данных для каждой обнаруженной им графической карты. Из-за этого PlayReady попытается получить лицензию на содержимое, хотя при обычных обстоятельствах у PlayReady уже была бы лицензия (то есть в случае использовании программного управления цифровыми правами или в случае отсутствия изменений в составе оборудования PlayReady не потребовалось бы повторно получать лицензию). Таким образом, если приложение получает сохраняемую лицензию при использовании аппаратного управления цифровыми правами, оно должно быть способно обрабатывать ситуацию, когда эта лицензия фактически "теряется", если конечный пользователь устанавливает (или удаляет) графическую карту. Так как это довольно редкий сценарий, вы, возможно, предпочтете обрабатывать звонки в службу поддержки от клиентов, у которых содержимое не воспроизводится после изменения состава оборудования, а не писать код для клиента или сервера, обрабатывающий ситуации, в которых происходит изменение аппаратной конфигурации.

## Переопределение аппаратного управления цифровыми правами

В данном разделе рассказывается о том, как переопределить аппаратное управление цифровыми правами, если содержимое, которое необходимо воспроизвести, не поддерживает его.

По умолчанию аппаратное управление цифровыми правами используется, если система поддерживает его. Тем не менее некоторое содержимое не поддерживается аппаратным управлением цифровыми правами. Пример такого содержимого — Cocktail. Другой пример — любое содержимое, использующее видеокодек, отличный от H.264 или HEVC. Еще один пример — содержимое в формате HEVC, так как некоторые виды аппаратного управления цифровыми правами поддерживают стандарт HEVC, а другие — нет. Таким образом, если вам необходимо воспроизвести содержимое, а аппаратное управление цифровыми правами не поддерживает его на рассматриваемой системе, вам, возможно, потребуется отключить аппаратное управление цифровыми правами.

В примере ниже показано, как отключить аппаратное управление цифровыми правами. Необходимо сделать это до переключения. Кроме того, убедитесь, что в памяти нет никаких объектов PlayReady, иначе это может привести к непредсказуемым результатам.

```js
var applicationData = Windows.Storage.ApplicationData.current;
var localSettings = applicationData.localSettings.createContainer("PlayReady", Windows.Storage.ApplicationDataCreateDisposition.always);
localSettings.values["SoftwareOverride"] = 1;
```

Чтобы снова включить аппаратное управление цифровыми правами, присвойте параметру **SoftwareOverride** значение **0**.

Для каждого воспроизведения мультимедиа необходимо задать для **MediaProtectionManager** значение:

```js
mediaProtectionManager.properties["Windows.Media.Protection.UseSoftwareProtectionLayer"] = true;
```

Лучший способ определить, какое управление цифровыми правами используется, аппаратное или программное, — это изучить папку C:\\Users\\&lt;username&gt;\\AppData\\Local\\Packages\\&lt;имя приложения&gt;\\LocalState\\PlayReady\\\*

-   Если там присутствует файл mspr.hds, используется программное управление цифровыми правами DRM.
-   Если там имеется другой файл \*.hds, используется аппаратное управление DRM.
-   Вы можете удалить всю папку PlayReady и повторить тестирование.

## Определение типа аппаратного управления цифровыми правами

В данном разделе рассказывается, как определить тип аппаратного управления цифровыми правами, поддерживаемого в системе.

Чтобы узнать, поддерживает ли система определенный компонент аппаратного управления цифровыми правами, можно использовать метод [**PlayReadyStatics.CheckSupportedHardware**](https://msdn.microsoft.com/library/windows/apps/dn986441). Например, так:

```cpp
boolean PlayReadyStatics->CheckSupportedHardware(PlayReadyHardwareDRMFeatures enum);
```

Перечисление [**PlayReadyHardwareDRMFeatures**](https://msdn.microsoft.com/library/windows/apps/dn986265) содержит допустимый список значений компонентов аппаратного управления цифровыми правами, которые можно запросить. Чтобы определить, поддерживается ли аппаратное управление цифровыми правами, воспользуйтесь членом **HardwareDRM** в очереди. Чтобы определить, поддерживает ли оборудование кодек High Efficiency Video Coding (HEVC)/H.265, воспользуйтесь членом **HEVC** в очереди.

Кроме того, чтобы получить сведения об уровне безопасности сертификата клиента и определить, поддерживается ли аппаратное управление цифровыми правами, вы можете воспользоваться свойством [**PlayReadyStatics.PlayReadyCertificateSecurityLevel**](https://msdn.microsoft.com/library/windows/apps/windows.media.protection.playready.playreadystatics.playreadycertificatesecuritylevel.aspx). Если возвращенное значение уровня защиты сертификата клиента меньше 3000, то либо клиент не индивидуализирован или не подготовлен к работе (в этом случае свойство возвратит значение 0), либо аппаратное управление цифровыми правами не используется (в этом случае это свойство возвратит значение, меньшее 3000).



<!--HONumber=May16_HO2-->


