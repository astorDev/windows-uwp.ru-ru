---
ms.assetid: 3848cd72-eccd-400e-93ff-13649cd81b6c
description: В этой статье предоставляется поддержка для приложений, использующих традиционную модель воспроизведения мультимедиа в фоновом режиме, а также инструкции по переходу на новую модель.
title: Традиционное воспроизведение мультимедиа в фоновом режиме
ms.date: 02/08/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: ea8d387becaef171175fd5e91bfc3a1402e79faa
ms.sourcegitcommit: d2517e522cacc5240f7dffd5bc1eaa278e3f7768
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/30/2018
ms.locfileid: "8323368"
---
# <a name="legacy-background-media-playback"></a>Традиционное воспроизведение мультимедиа в фоновом режиме


В этой статье описывается традиционная двухпроцессная модель добавления поддержки воспроизведения звука в фоновом режиме в приложение UWP. Начиная с Windows 10 версии 1607 используется однопроцессная модель для воспроизведения звука в фоновом режиме, которую гораздо проще реализовать. Дополнительные сведения о текущих рекомендациях по воспроизведению звука в фоновом режиме см. в разделе [Воспроизведение мультимедиа в фоновом режиме](background-audio.md). В этой статье предоставляется поддержка для приложений, разработанных с использованием традиционной двухпроцессной модели.

> [!NOTE]
> Начиная с Windows версии 1703, **BackgroundMediaPlayer** устарел и могут быть недоступны в будущих версиях Windows.

## <a name="background-audio-architecture"></a>Архитектура фонового звука

Приложение, отвечающее за воспроизведение в фоновом режиме, выполняет два процесса. Первый процесс— это основное приложение, содержащее пользовательский интерфейс приложения и клиентскую логику, которые выполняются на переднем плане. Второй процесс— задача воспроизведения в фоновом режиме, которая реализует интерфейс [**IBackgroundTask**](https://msdn.microsoft.com/library/windows/apps/br224794), как и все фоновые задачи приложений UWP. Фоновая задача содержит логику воспроизведения в фоновом режиме и фоновые службы. Фоновая задача взаимодействует с системой с помощью системных элементов управления транспортировкой мультимедийных данных.

На следующей схеме представлен обзор разработанной системы.

![Архитектура фонового звука в Windows10](images/backround-audio-architecture-win10.png)
## <a name="mediaplayer"></a>MediaPlayer

Пространство имен [**Windows.Media.Playback**](https://msdn.microsoft.com/library/windows/apps/dn640562) включает интерфейсы API, используемые для воспроизведения звука в фоновом режиме. У каждого приложения есть один экземпляр класса [**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/dn652535), обеспечивающий воспроизведение. Ваше приложение для воспроизведения звука в фоновом режиме вызывает методы и устанавливает свойства для класса **MediaPlayer**, чтобы задать текущую дорожку, начать воспроизведение, выполнить приостановку, перемотку вперед или назад ит.д. Доступ к экземпляру объекта проигрывателя мультимедиа всегда обеспечивается с помощью свойства [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528).

## <a name="mediaplayer-proxy-and-stub"></a>Прокси-сервер и заглушка MediaPlayer

Когда вы получаете доступ к свойству **BackgroundMediaPlayer.Current** из фонового процесса приложения, в основном элементе фоновой задачи активируется экземпляр **MediaPlayer**, которым можно непосредственно управлять.

Когда вы получаете доступ к свойству **BackgroundMediaPlayer.Current** из приложения переднего плана, возвращенный экземпляр **MediaPlayer** фактически представляет собой прокси-сервер, который обменивается данными с заглушкой в фоновом процессе. Эта заглушка взаимодействует с фактическим экземпляром **MediaPlayer**, который также размещен в фоновом процессе.

Как процесс переднего плана, так и фоновый процесс могут получать доступ к большинству свойств экземпляра **MediaPlayer**. Исключение составляют свойства [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) и [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635), доступные только из фонового процесса. Приложение переднего плана и фоновый процесс могут получать уведомления о событиях, связанных с мультимедиа, таки как [**MediaOpened**](https://msdn.microsoft.com/library/windows/apps/dn652609), [**MediaEnded**](https://msdn.microsoft.com/library/windows/apps/dn652603) и [**MediaFailed**](https://msdn.microsoft.com/library/windows/apps/dn652606).

## <a name="playback-lists"></a>Списки воспроизведения

Распространенный сценарий для приложений фонового звука— воспроизведение нескольких элементов в строке. Этот сценарий легче всего реализовать в фоновом процессе с помощью объекта [**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955), который можно установить в качестве источника для класса **MediaPlayer**, назначив его свойству [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010).

Доступ к объекту **MediaPlaybackList** невозможно получить из процесса переднего плана, который задан в фоновом процессе.

## <a name="system-media-transport-controls"></a>Системные элементы управления транспортом мультимедиа

Пользователь может управлять воспроизведением звука, не используя непосредственно пользовательский интерфейс приложения, с помощью таких средств, как устройства Bluetooth, SmartGlass и системные элементы управления транспортировкой мультимедийных данных. Ваша фоновая задача использует класс [**SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn278677) для подписки на эти системные события, инициализированные пользователем.

Чтобы получить экземпляр **SystemMediaTransportControls** из фонового процесса, используйте свойство [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635). Приложения переднего плана получают экземпляр класса путем вызова метода [**SystemMediaTransportControls.GetForCurrentView**](https://msdn.microsoft.com/library/windows/apps/dn278708), но при этом возвращается только экземпляр переднего плана, не связанный с фоновой задачей.

## <a name="sending-messages-between-tasks"></a>Отправка сообщений между задачами

Иногда возникает необходимость установить связь между двумя процессами приложения фонового звука. Например, может потребоваться, чтобы фоновая задача уведомляла задачу переднего плана, что начинается проигрывание новой дорожки, и отправляла в задачу переднего плана название новой песни для отображения на экране.

Простой механизм связи позволяет вызывать события как в процессе переднего плана, так и в фоновом процессе. Каждый из методов [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) и [**SendMessageToBackground**](https://msdn.microsoft.com/library/windows/apps/dn652532) вызывает события в соответствующем процессе. Сообщения можно получить путем подписки на события [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) и [**MessageReceivedFromForeground**](https://msdn.microsoft.com/library/windows/apps/dn652531).

Данные можно передавать в качестве аргумента методам отправки сообщений, которые затем передаются в обработчики событий полученных сообщений. Передавайте данные с помощью класса [**ValueSet**](https://msdn.microsoft.com/library/windows/apps/dn636131). Этот класс представляет собой словарь, содержащий строку в качестве ключа и другие типы значений в качестве значений. Вы можете передавать простые типы значений, такие как целые числа, строки и логические значения.

## <a name="background-task-life-cycle"></a>Время существования фоновой задачи

Время существования фоновой задачи тесно связано с текущим состоянием воспроизведения приложения. Например, когда пользователь приостанавливает воспроизведение звука, система может завершить или отменить работу вашего приложения в зависимости от обстоятельств. Если звук не будет воспроизводиться в течение некоторого времени, система может автоматически завершить работу фоновой задачи.

Метод [**IBackgroundTask.Run**](https://msdn.microsoft.com/library/windows/apps/br224811) вызывается, когда приложение в первый раз получает доступ к свойству [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) из кода, выполняемого в приложении переднего плана, либо когда вы регистрируете обработчик события [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) в зависимости от того, что происходит раньше. Рекомендуется зарегистрировать обработчик полученного сообщения, прежде чем вызывать свойство **BackgroundMediaPlayer.Current** в первый раз, чтобы приложение переднего плана не пропустило сообщения, отправленные из фонового процесса.

Чтобы поддерживать активность фоновой задачи, ваше приложение должно запросить класс [**BackgroundTaskDeferral**](https://msdn.microsoft.com/library/windows/apps/hh700499) из метода **Run** и вызвать метод [**BackgroundTaskDeferral.Complete**](https://msdn.microsoft.com/library/windows/apps/hh700504), когда экземпляр задачи получает события [**Canceled**](https://msdn.microsoft.com/library/windows/apps/br224798) или [**Completed**](https://msdn.microsoft.com/library/windows/apps/br224788). Не используйте цикл или ожидание в методе **Run**, так как это ведет к потреблению ресурсов и может вызвать прерывание выполнения вашего приложения в фоновом режиме.

Ваша фоновая задача получает событие **Completed**, когда завершается метод **Run** и не запрашивается отсрочка выполнения. В некоторых случаях, когда ваше приложение получает событие **Canceled**, за ним может следовать событие **Completed**. Ваша задача может получить событие **Canceled** даже при выполнении метода **Run**, поэтому обязательно отслеживайте такую возможность синхронного захвата.

Фоновая задача может быть отменена в следующих ситуациях.

-   В системах, в которых применяется вспомогательная политика монопольности, запускается новое приложение, поддерживающее воспроизведение звука. См. раздел [Политики системы в течение времени существования фоновой задачи](#system-policies-for-background-audio-task-lifetime) ниже.

-   Фоновая задача запущена, но воспроизведение музыки не началось. В этом случае фоновая задача приостанавливается.

-   Воспроизведение мультимедиа прерывается другими способами, например вследствие входящих телефонных звонков или вызовов по протоколу VoIP.

Фоновая задача может быть завершена без предварительного уведомления в следующих ситуациях.

-   При поступлении вызова по протоколу VoIP в системе имеется недостаточно доступной памяти, чтобы поддерживать активность фоновой задачи.

-   Нарушается политика ресурсов.

-   Имеют место аварийные отмена или завершение задачи.

## <a name="system-policies-for-background-audio-task-lifetime"></a>Политики системы в течение времени существования фоновой задачи

Следующие политики помогают определить, как система управляет временем существования фоновых задач воспроизведения звука.

### <a name="exclusivity"></a>Монопольность

Если включить эту вспомогательную политику, число фоновых задач воспроизведения звука будет ограничено до 1 в любой момент времени. Эта политика активируется на мобильных устройствах и других SKU, отличных от настольных компьютеров.

### <a name="inactivity-timeout"></a>Время ожидания активности

Из-за ограничений на ресурсы система может завершить фоновую задачу после бездействия в течение определенного периода.

Фоновая задача считается "неактивной", если выполнены оба следующих условия:

-   приложение переднего плана невидима (его работа приостановлена или прекращена);

-   мультимедиапроигрыватель не воспроизводит содержимое в фоновом режиме.

Если удовлетворены оба этих условия, системная политика воспроизведения мультимедийных данных в фоновом режиме запустит таймер. Если ни одно из условий не изменилось по завершении отсчета таймера, эта системная политика прекратит выполнение фоновой задачи.

### <a name="shared-lifetime"></a>Общее время существования

Если включить эту вспомогательную политику, фоновая задача будет зависеть от времени существования задачи переднего плана. Если выполнение задачи переднего плана прекращено (пользователем или системой), фоновая задача также завершит работу.

Однако обратите внимание, что это не значит, что задача переднего плана зависит от фоновой задачи. Прекращение фоновой задачи не приводит к завершению работы задачи переднего плана.

В следующей таблице перечислены политики, применяемые к устройствам определенных типов.

| Вспомогательная политика             | Настольные ПК  | Мобильные устройства   | Другие    |
|------------------------|----------|----------|----------|
| **Монопольность**        | Отключена | Включена  | Включена  |
| **Время ожидания активности** | Отключена | Включена  | Отключена |
| **Общее время существования**    | Включена  | Отключена | Отключена |


 

 




