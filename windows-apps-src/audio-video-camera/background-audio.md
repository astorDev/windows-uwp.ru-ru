---
author: drewbatgit
ms.assetid: 923D8156-81D3-4A1E-9D02-DB219F600FDB
description: "В этой статье описано, как создать приложения для универсальной платформы Windows (UWP), которые воспроизводят звук в фоновом режиме."
title: "Воспроизведение звука в фоновом режиме"
ms.sourcegitcommit: 99d1ffa637fd8beca5d1e829cc7cacc18a9c21e9
ms.openlocfilehash: 9275a194017f08692adee6de1c4d1f6deb680613

---

# Воспроизведение звука в фоновом режиме

\[ Обновлено для приложений UWP в Windows 10. Статьи о Windows 8.x см. в разделе [Архив](http://go.microsoft.com/fwlink/p/?linkid=619132) \]


В этой статье описано, как создать приложения для универсальной платформы Windows (UWP), которые воспроизводят звук в фоновом режиме. Это значит, что даже после того, как пользователь свернет приложение, вернется на начальный экран или выйдет из приложения другим способом, ваше приложение продолжит воспроизводить звук. В этой статье обсуждаются компоненты приложения для воспроизведение звука в фоновом режиме, а также их совместная работа.

Сценарии воспроизведения звука в фоновом режиме включают следующие элементы.

-   **Долговременные плей-листы.** Пользователь кратковременно вызывает приложение переднего плана, чтобы выбрать и запустить плей-лист. После этого пользователь ожидает, что плей-лист продолжит воспроизведение в фоновом режиме.

-   **Использование переключателя задач:** пользователь кратковременно вызывает приложение переднего плана, чтобы запустить воспроизведение звука, а затем с помощью переключателя задач переключается на другое открытое приложение. Пользователь ожидает, что воспроизведение звука продолжится в фоновом режиме.

В этой статье описано, как повсеместно реализовать воспроизведение приложением звука в фоновом режиме на всех устройствах с Windows, включая мобильные устройства, настольные компьютеры и консоли Xbox.

**Примечание**  
В [Примере воспроизведения звука в фоновом режиме на платформе UWP](http://go.microsoft.com/fwlink/?LinkId=619485) реализован код, описанный в этом обзоре. Скачайте этот пример, чтобы просмотреть код в контексте или использовать пример как отправную точку для настройки вашего приложения.

 

## Архитектура фонового звука

Приложение, которое отвечает за воспроизведение в фоновом режиме, выполняет два процесса. Первый процесс — это основное приложение, содержащее пользовательский интерфейс приложения и клиентскую логику, которые выполняются на переднем плане. Второй процесс — задача воспроизведения в фоновом режиме, которая реализует интерфейс [**IBackgroundTask**](https://msdn.microsoft.com/library/windows/apps/br224794), как и все фоновые задачи приложений UWP. Фоновая задача содержит логику воспроизведения в фоновом режиме и фоновые службы. Фоновая задача взаимодействует с системой с помощью системных элементов управления транспортировкой мультимедийных данных.

На следующей схеме представлен обзор разработанной системы.

![Архитектура фонового звука в Windows 10](images/backround-audio-architecture-win10.png)
## MediaPlayer

Пространство имен [**Windows.Media.Playback**](https://msdn.microsoft.com/library/windows/apps/dn640562) включает интерфейсы API, используемые для воспроизведения звука в фоновом режиме. У каждого приложения есть один экземпляр класса [**MediaPlayer**](https://msdn.microsoft.com/library/windows/apps/dn652535), обеспечивающий воспроизведение. Ваше приложение для воспроизведения звука в фоновом режиме вызывает методы и устанавливает свойства для класса **MediaPlayer**, чтобы задать текущую дорожку, начать воспроизведение, выполнить приостановку, перемотку вперед или назад и т. д. Доступ к экземпляру объекта проигрывателя мультимедиа всегда обеспечивается с помощью свойства [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528).

## Прокси-сервер и заглушка MediaPlayer

Когда вы получаете доступ к свойству **BackgroundMediaPlayer.Current** из фонового процесса приложения, в основном элементе фоновой задачи активируется экземпляр **MediaPlayer**, которым можно непосредственно управлять.

Когда вы получаете доступ к свойству **BackgroundMediaPlayer.Current** из приложения переднего плана, возвращенный экземпляр **MediaPlayer** фактически представляет собой прокси-сервер, который обменивается данными с заглушкой в фоновом процессе. Эта заглушка взаимодействует с фактическим экземпляром **MediaPlayer**, который также размещен в фоновом процессе.

Как процесс переднего плана, так и фоновый процесс могут получать доступ к большинству свойств экземпляра **MediaPlayer**. Исключение составляют свойства [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010) и [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635), доступные только из фонового процесса. Приложение переднего плана и фоновый процесс могут получать уведомления о событиях, связанных с мультимедиа, таки как [**MediaOpened**](https://msdn.microsoft.com/library/windows/apps/dn652609), [**MediaEnded**](https://msdn.microsoft.com/library/windows/apps/dn652603) и [**MediaFailed**](https://msdn.microsoft.com/library/windows/apps/dn652606).

## Списки воспроизведения

Распространенный сценарий для приложений фонового звука — воспроизведение нескольких элементов в строке. Этот сценарий легче всего реализовать в фоновом процессе с помощью объекта [**MediaPlaybackList**](https://msdn.microsoft.com/library/windows/apps/dn930955), который можно установить в качестве источника для класса **MediaPlayer**, назначив его свойству [**MediaPlayer.Source**](https://msdn.microsoft.com/library/windows/apps/dn987010).

Доступ к объекту **MediaPlaybackList** невозможно получить из процесса переднего плана, который задан в фоновом процессе.

## Системные элементы управления транспортом мультимедиа

Пользователь может управлять воспроизведением звука, не используя непосредственно пользовательский интерфейс приложения, с помощью таких средств, как устройства Bluetooth, SmartGlass и системные элементы управления транспортировкой мультимедийных данных. Ваша фоновая задача использует класс [**SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn278677) для подписки на эти системные события, инициализированные пользователем.

Чтобы получить экземпляр **SystemMediaTransportControls** из фонового процесса, используйте свойство [**MediaPlayer.SystemMediaTransportControls**](https://msdn.microsoft.com/library/windows/apps/dn926635). Приложения переднего плана получают экземпляр класса путем вызова метода [**SystemMediaTransportControls.GetForCurrentView**](https://msdn.microsoft.com/library/windows/apps/dn278708), но при этом возвращается только экземпляр переднего плана, не связанный с фоновой задачей.

## Отправка сообщений между задачами

Иногда возникает необходимость установить связь между двумя процессами приложения фонового звука. Например, может потребоваться, чтобы фоновая задача уведомляла задачу переднего плана, что начинается проигрывание новой дорожки, и отправляла в задачу переднего плана название новой песни для отображения на экране.

Простой механизм связи позволяет вызывать события как в процессе переднего плана, так и в фоновом процессе. Каждый из методов [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533) и [**SendMessageToBackground**](https://msdn.microsoft.com/library/windows/apps/dn652532) вызывает события в соответствующем процессе. Сообщения можно получить путем подписки на события [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) и [**MessageReceivedFromForeground**](https://msdn.microsoft.com/library/windows/apps/dn652531).

Данные можно передавать в качестве аргумента методам отправки сообщений, которые затем передаются в обработчики событий полученных сообщений. Передавайте данные с помощью класса [**ValueSet**](https://msdn.microsoft.com/library/windows/apps/dn636131). Этот класс представляет собой словарь, содержащий строку в качестве ключа и другие типы значений в качестве значений. Вы можете передавать простые типы значений, такие как целые числа, строки и логические значения.

**Примечание.**  
Когда запущено приложение переднего плана, приложения должны вызвать только метод [**SendMessageToForeground**](https://msdn.microsoft.com/library/windows/apps/dn652533). При попытке вызова этого метода, когда приложение переднего плана не выполняется, будет вызвано исключение. Приложение отвечает за передачу состояния приложения переднего плана в фоновый процесс. Это можно сделано с помощью событий жизненного цикла приложения, значений состояния, хранящихся в локальном хранилище, и сообщений, отправляемых между процессами. 

## Время существования фоновой задачи

Время существования фоновой задачи тесно связано с текущим состоянием воспроизведения приложения. Например, когда пользователь приостанавливает воспроизведение звука, система может завершить или отменить работу вашего приложения в зависимости от обстоятельств. Если звук не будет воспроизводиться в течение некоторого времени, система может автоматически завершить работу фоновой задачи.

Метод [**IBackgroundTask.Run**](https://msdn.microsoft.com/library/windows/apps/br224811) вызывается, когда приложение в первый раз получает доступ к свойству [**BackgroundMediaPlayer.Current**](https://msdn.microsoft.com/library/windows/apps/dn652528) из кода, выполняемого в приложении переднего плана, либо когда вы регистрируете обработчик события [**MessageReceivedFromBackground**](https://msdn.microsoft.com/library/windows/apps/dn652530) в зависимости от того, что происходит раньше. Рекомендуется зарегистрировать обработчик полученного сообщения, прежде чем вызывать свойство **BackgroundMediaPlayer.Current** в первый раз, чтобы приложение переднего плана не пропустило сообщения, отправленные из фонового процесса.

Чтобы поддерживать активность фоновой задачи, ваше приложение должно запросить класс [**BackgroundTaskDeferral**](https://msdn.microsoft.com/library/windows/apps/hh700499) из метода **Run** и вызвать метод [**BackgroundTaskDeferral.Complete**](https://msdn.microsoft.com/library/windows/apps/hh700504), когда экземпляр задачи получает события [**Canceled**](https://msdn.microsoft.com/library/windows/apps/br224798) или [**Completed**](https://msdn.microsoft.com/library/windows/apps/br224788). Не используйте цикл или ожидание в методе **Run**, так как это ведет к потреблению ресурсов и может вызвать прерывание выполнения вашего приложения в фоновом режиме.

Ваша фоновая задача получает событие **Completed**, когда завершается метод **Run** и не запрашивается отсрочка выполнения. В некоторых случаях, когда ваше приложение получает событие **Canceled**, за ним может следовать событие **Completed**. Ваша задача может получить событие **Canceled** даже при выполнении метода **Run**, поэтому обязательно отслеживайте такую возможность синхронного захвата.

Фоновая задача может быть отменена в следующих ситуациях.

-   В системах, в которых применяется вспомогательная политика монопольности, запускается новое приложение, поддерживающее воспроизведение звука. См. раздел [Политики системы в течение времени существования фоновой задачи](#system-policies-for-background-audio-task-lifetime) ниже.

-   Фоновая задача запущена, но воспроизведение музыки не началось. В этом случае фоновая задача приостанавливается.

-   Воспроизведение мультимедиа прерывается другими способами, например вследствие входящих телефонных звонков или вызовов по протоколу VoIP.

Фоновая задача может быть завершена без предварительного уведомления в следующих ситуациях.

-   При поступлении вызова по протоколу VoIP в системе имеется недостаточно доступной памяти, чтобы поддерживать активность фоновой задачи.

-   Нарушается политика ресурсов.

-   Имеют место аварийные отмена или завершение задачи.

## Политики системы в течение времени существования фоновой задачи

Следующие политики помогают определить, как система управляет временем существования фоновых задач воспроизведения звука.

### Монопольность

Если включить эту вспомогательную политику, число фоновых задач воспроизведения звука будет ограничено до 1 в любой момент времени. Эта политика активируется на мобильных устройствах и других SKU, отличных от настольных компьютеров.

### Время ожидания активности

Из-за ограничений на ресурсы система может завершить фоновую задачу после бездействия в течение определенного периода.

Фоновая задача считается "неактивной", если выполнены оба следующих условия:

-   приложение переднего плана невидима (его работа приостановлена или прекращена);

-   мультимедиапроигрыватель не воспроизводит содержимое в фоновом режиме.

Если удовлетворены оба этих условия, системная политика воспроизведения мультимедийных данных в фоновом режиме запустит таймер. Если ни одно из условий не изменилось по завершении отсчета таймера, эта системная политика прекратит выполнение фоновой задачи.

### Общее время существования

Если включить эту вспомогательную политику, фоновая задача будет зависеть от времени существования задачи переднего плана. Если выполнение задачи переднего плана прекращено (пользователем или системой), фоновая задача также завершит работу.

Однако обратите внимание, что это не значит, что задача переднего плана зависит от фоновой задачи. Прекращение фоновой задачи не приводит к завершению работы задачи переднего плана.

В следующей таблице перечислены политики, применяемые к устройствам определенных типов.

| Вспомогательная политика             | Настольные ПК  | Мобильные устройства   | Другие    |
|------------------------|----------|----------|----------|
| **Монопольность**        | Отключена | Включена  | Включена  |
| **Время ожидания активности** | Отключена | Включена  | Отключена |
| **Общее время существования**    | Включена  | Отключена | Отключена |

 

 

 







<!--HONumber=Jun16_HO5-->


