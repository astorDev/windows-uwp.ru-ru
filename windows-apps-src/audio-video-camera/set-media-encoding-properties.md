---
ms.assetid: 09BA9250-A476-4803-910E-52F0A51704B1
description: Статья рассказывает, как с помощью IMediaEncodingProperties задать разрешение и частоту кадров потока предварительного просмотра камеры, а также фото и видео.
title: Задание свойств кодирования мультимедиа
---

# Задание свойств кодирования мультимедиа

\[ Обновлено для приложений UWP в Windows 10. Статьи о Windows 8.x см. в [архиве](http://go.microsoft.com/fwlink/p/?linkid=619132) \]


В этой статье рассказывается, как с помощью интерфейса [**IMediaEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh701011) задать разрешение и частоту кадров потока предварительного просмотра камеры, а также снятых фотографий и видео. Кроме того, здесь рассказывается, как обеспечить соответствие пропорций потока предварительного просмотра пропорциям записи мультимедиа.

Профили камеры предлагают более современный способ обнаружения и задания свойств потока камеры, но они поддерживаются не на всех устройствах. Дополнительные сведения см. в разделе [Профили камеры](camera-profiles.md).

В этой статье используется код, адаптированный из [примера CameraResolution](http://go.microsoft.com/fwlink/p/?LinkId=624252&clcid=0x409). Вы можете скачать этот пример, чтобы просмотреть код в контексте или использовать пример как отправную точку для настройки собственного приложения.

**Примечание.**  
В этой статье используются понятия и код из статьи [Фото- и видеозахват с помощью MediaCapture](capture-photos-and-video-with-mediacapture.md), в которой описаны этапы реализации основных принципов фото- и видеозахвата. Мы рекомендуем ознакомиться с базовым шаблоном захвата мультимедиа в этой статье, прежде чем перейти к более сложным сценариям захвата. Код в этой статье подразумевает, что ваше приложение уже содержит экземпляр MediaCapture, инициализированный надлежащим образом.

## Вспомогательный класс свойств кодирования мультимедиа

Если создать простой вспомогательный класс, включающий функции интерфейса [**IMediaEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh701011), будет удобнее выбирать набор свойств кодирования, которые отвечают конкретным критериям. Этот вспомогательный класс особенно полезен для следующего поведения свойств кодирования.

**Предупреждение.**  
Метод [**VideoDeviceController.GetAvailableMediaStreamProperties**](https://msdn.microsoft.com/library/windows/apps/br211994) берет элемент перечисления [**MediaStreamType**](https://msdn.microsoft.com/library/windows/apps/br226640), например **VideoRecord** или **Photo**, и возвращает список объектов [**ImageEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh700993) или [**VideoEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh701217), которые выражают параметры кодирования потока, такие как разрешение снятой фотографии или видео. Результаты вызова **GetAvailableMediaStreamProperties** могут включать **ImageEncodingProperties** или **VideoEncodingProperties**, независимо от того, какое указано значение **MediaStreamType**. По этой причине необходимо всегда проверять тип каждого возвращенного значения и приводить его к соответствующему типу, прежде чем пытаться получить доступ к какому-либо значению свойства.

Вспомогательный класс, определенный ниже, выполняет проверку и приведение типа для параметра [**ImageEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh700993) или [**VideoEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh701217), чтобы коду приложения не нужно было различать два типа. В дополнение к этому, вспомогательный класс представляет свойства для пропорций свойств, частоты кадров (только для свойств кодирования видео) и понятного имени, что упрощает отображение свойств кодирования в пользовательском интерфейсе приложения.

Вы должны включить пространство имен [**Windows.Media.MediaProperties**](https://msdn.microsoft.com/library/windows/apps/hh701296) в исходный файл для вспомогательного класса.

[!code-cs[MediaEncodingPropertiesUsing](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetMediaEncodingPropertiesUsing)]

[!code-cs[StreamPropertiesHelper](./code/BasicMediaCaptureWin10/cs/StreamPropertiesHelper.cs#SnippetStreamPropertiesHelper)]

## Определение независимости потоков предварительного просмотра и захвата

На некоторых устройствах один и тот же контакт оборудования используется как для потока предварительного просмотра, так и для потока захвата. На таких устройствах при задании свойств кодирования для одного потока свойства задаются и для другого потока. На устройствах, на которых для захвата и предварительного просмотра используются разные контакты, свойства можно задать для каждого потока независимо. Используйте следующий код, чтобы определить, независимы ли потоки предварительного просмотра и захвата. Необходимо настроить пользовательский интерфейс, чтобы он включал и отключал параметр потоков независимо на основе результата этой проверки.

[!code-cs[CheckIfStreamsAreIdentical](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetCheckIfStreamsAreIdentical)]

## Получение списка доступных свойств потока

Чтобы получить список доступных свойств потока для устройства захвата, получите [**VideoDeviceController**](https://msdn.microsoft.com/library/windows/apps/br226825) для объекта [MediaCapture](capture-photos-and-video-with-mediacapture.md) своего приложения, а затем вызовите [**GetAvailableMediaStreamProperties**](https://msdn.microsoft.com/library/windows/apps/br211994) и передайте одно из значений [**MediaStreamType**](https://msdn.microsoft.com/library/windows/apps/br226640), **VideoPreview**, **VideoRecord** или **Photo**. В этом примере синтаксис Linq используется для создания списка объектов **StreamPropertiesHelper**, определенных ранее в этой статье, для каждого из значений [**IMediaEncodingProperties**](https://msdn.microsoft.com/library/windows/apps/hh701011), которые возвращаются функцией **GetAvailableMediaStreamProperties**. В этом примере методы расширения Linq сначала используются для расстановки возвращаемых свойств сперва на основе разрешения, а потом уже на основе частоты кадров.

Если у вашего приложения есть конкретные требования к разрешению или частоте кадров, можно выбрать набор свойств кодирования мультимедиа программным путем. Тогда обычное приложение камеры отобразит список доступных свойств в пользовательском интерфейсе и позволит пользователю выбрать нужные параметры. **ComboBoxItem** создается для каждого элемента в списке объектов **StreamPropertiesHelper** в списке. Для содержимого устанавливается понятное имя, возвращенное вспомогательным классом, а для тега устанавливается сам вспомогательный класс, чтобы его можно было использовать позже для получения связанных свойств кодирования. Каждый элемент **ComboBoxItem** затем добавляется в объект **ComboBox**, который передается в метод.

[!code-cs[PopulateStreamPropertiesUI](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetPopulateStreamPropertiesUI)]

## Установка необходимых свойств потока

Чтобы контроллер видеоустройств использовал нужные свойства кодирования, вызовите [**SetMediaStreamPropertiesAsync**](https://msdn.microsoft.com/library/windows/apps/hh700895) и передайте значение **MediaStreamType**, определяющее, нужно ли задавать свойства фотографии, видео или предварительного просмотра. В этом примере задаются запрашиваемые свойства кодирования, когда пользователь выбирает элемент в одном из объектов **ComboBox**, которые заполняются вспомогательным методом **PopulateStreamPropertiesUI**.

[!code-cs[PreviewSettingsChanged](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetPreviewSettingsChanged)]

[!code-cs[PhotoSettingsChanged](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetPhotoSettingsChanged)]

[!code-cs[VideoSettingsChanged](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetVideoSettingsChanged)]

## Сопоставление пропорций потоков предварительного просмотра и захвата

Типичное приложение камеры предоставляет пользовательский интерфейс для выбора разрешения захвата видео или фото, но разрешение предварительного просмотра устанавливает программным способом. Существуют несколько стратегий выбора наилучшего разрешения потока предварительного просмотра для вашего приложения.

-   Выберите наивысшее доступное разрешение предварительного просмотра, предоставив инфраструктуре пользовательского интерфейса выполнять необходимое масштабирование предварительного просмотра.

-   Выберите разрешение предварительного просмотра, наиболее близкое к разрешению захвата, чтобы предварительный просмотр был как можно ближе к итоговому захваченному мультимедиа.

-   Выберите разрешение предварительного просмотра, наиболее близкое к размеру [**CaptureElement**](https://msdn.microsoft.com/library/windows/apps/br209278), чтобы через конвейер потока предварительного просмотра проходило столько пикселов, сколько нужно, но не более того.

**Важно!**  
На некоторых устройствах можно задать разные пропорции для потока предварительного просмотра и потока захвата камеры. Обрезка кадра в результате такого несоответствия может привести к наличию в записи мультимедиа содержимого, которого не было видно в режиме предварительного просмотра, что может вызвать недовольство пользователей. Настоятельно рекомендуется использовать одинаковые пропорции (с небольшим диапазоном допуска) для потоков предварительного просмотра и захвата. Можно иметь совершенно различные разрешения, доступные для захвата и предварительного просмотра, пока их пропорции максимально соответствуют друг другу.


Чтобы обеспечить соответствие потоков фото- и видеозахвата пропорциям потока предварительного просмотра, в этом примере вызывается [**VideoDeviceController.GetMediaStreamProperties**](https://msdn.microsoft.com/library/windows/apps/br211995) и передается значение перечисления **VideoPreview** для запроса текущих свойств потока предварительного просмотра. Затем определяется небольшой диапазон допуска для пропорций, чтобы можно было включать пропорции, которые не совпадают с потоком предварительного просмотра полностью, но которые близки к этому. Далее метод расширения Linq используется для выбора только тех объектов **StreamPropertiesHelper**, пропорции которых входят в указанный диапазон допуска потока предварительного просмотра.

[!code-cs[MatchPreviewAspectRatio](./code/BasicMediaCaptureWin10/cs/MainPage.xaml.cs#SnippetMatchPreviewAspectRatio)]

 

 






<!--HONumber=Mar16_HO1-->


