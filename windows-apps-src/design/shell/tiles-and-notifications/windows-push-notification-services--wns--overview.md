---
author: mijacobs
Description: The Windows Push Notification Services (WNS) enables third-party developers to send toast, tile, badge, and raw updates from their own cloud service. This provides a mechanism to deliver new updates to your users in a power-efficient and dependable way.
title: Обзор служб push-уведомлений Windows (WNS)
ms.assetid: 2125B09F-DB90-4515-9AA6-516C7E9ACCCD
template: detail.hbs
ms.author: mijacobs
ms.date: 05/19/2017
ms.topic: article
keywords: windows 10, uwp
ms.localizationpriority: medium
ms.openlocfilehash: 2b7d9adfd9e058d4364470b07ef3e9129ade88b3
ms.sourcegitcommit: f2c9a050a9137a473f28b613968d5782866142c6
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/10/2018
ms.locfileid: "6282575"
---
# <a name="windows-push-notification-services-wns-overview"></a>Обзор служб push-уведомлений Windows (WNS)
 

Службы push-уведомлений Windows (WNS) позволяют сторонним разработчикам отправлять обновления всплывающих уведомлений, плиток, индикаторов событий и необработанные обновления из своей облачной службы. Это обеспечивает энергоэффективный и надежный механизм передачи пользователям свежих обновлений.

## <a name="how-it-works"></a>Принцип работы


На следующей схеме показан весь поток данных, связанный с отправкой push-уведомлений. Он предусматривает следующие этапы.

1.  Приложение отправляет на канал push-уведомлений запрос универсальной платформе Windows.
2.  Windows отправляет запрос в WNS на создание канала уведомлений. Этот канал возвращается отправившему вызов устройству в виде универсального кода ресурса (URI).
3.  Windows возвращает вашему приложению URI канала уведомлений.
4.  Ваше приложение отправляет URI в вашу облачную службу. Затем URI помещается на хранение в вашу собственную облачную службу, чтобы вы могли осуществлять к нему доступ при отправке уведомлений. URI выступает в роли интерфейса между вашим приложением и вашей службой. Вы несете ответственность за реализацию этого интерфейса в соответствии с веб-стандартами надежности и безопасности.
5.  Когда в вашей облачной службе появляется обновление, которое необходимо отправить, служба уведомляет WNS с помощью URI канала. Это осуществляется с помощью выпуска через SSL запроса HTTP POST, включающего полезные данные уведомления. На этом этапе требуется проверка подлинности.
6.  WNS получает запрос и направляет уведомление на соответствующее устройство.

![Схема потока данных WNS для push-уведомлений](images/wns-diagram-01.png)

## <a name="registering-your-app-and-receiving-the-credentials-for-your-cloud-service"></a>Регистрация вашего приложения и получение учетных данных для вашей облачной службы


Прежде чем вы сможете отправлять уведомления, используя WNS, ваше приложение должно быть зарегистрировано с помощью информационной панели Магазина. Таким образом вы получите для вашего приложения учетные данные, которые ваша облачная служба будет использовать при проверке подлинности с помощью WNS. Эти учетные данные состоят из идентификатора безопасности пакета и секретного ключа. Для регистрации перейдите в [Центр разработки для Windows](http://go.microsoft.com/fwlink/p/?linkid=511146) и выберите элемент **Информационная панель**. После создания приложения вы можете получить учетные данные, следуя инструкциям на странице **Управление приложением — WNS/MPNS**. Если вы хотите использовать решение Live Services, откройте ссылку **сайт Live Services** на этой странице.

Каждое приложение имеет собственный набор учетных данных для своей облачной службы. Эти учетные данные нельзя использовать для отправки уведомлений в любое другое приложение.

Дополнительные сведения о регистрации приложения см. в разделе [Проверка подлинности с помощью службы уведомлений Windows (WNS)](https://msdn.microsoft.com/library/windows/apps/hh465407).

## <a name="requesting-a-notification-channel"></a>Запрос на получение канала уведомлений


Приложение, которое может получать извещающие уведомления, должно после запуска отправить с помощью метода [**CreatePushNotificationChannelForApplicationAsync**](https://docs.microsoft.com/uwp/api/Windows.Networking.PushNotifications.PushNotificationChannelManager#Windows_Networking_PushNotifications_PushNotificationChannelManager_CreatePushNotificationChannelForApplicationAsync_System_String_) запрос на получение канала уведомлений. Дополнительные сведения и пример кода см. в разделе [Запрос, создание и сохранение канала уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465412). Этот API возвращает URI канала, однозначно связанный с вызывающим приложением и его плиткой, через который могут пересылаться типы уведомлений.

После успешного создания URI канала приложение отправляет его в свою облачную службу вместе со всеми метаданными приложения, которые должны быть сопоставлены с этим URI.

### <a name="important-notes"></a>Важные примечания

-   Нельзя гарантировать, что URI канала уведомлений для приложения будет всегда оставаться неизменным. Мы рекомендуем, чтобы приложение запрашивало новый канал при каждом запуске и обновляло свою службу при изменении URI. Разработчик никогда не должен изменять URI канала и должен рассматривать его как строку с неизвестным содержимым. В настоящее время срок действия URI каналов истекает через 30 дней. Если ваше приложение Windows10 будет периодически обновлять свой канал в фоновом режиме можно загрузить [Push-уведомлений и периодических уведомлений пример](http://go.microsoft.com/fwlink/p/?linkid=231476) для Windows8.1 и повторно использовать его исходный код и шаблон, которые в нем показано.
-   Интерфейс между облачной службой и клиентским приложением реализует разработчик. Рекомендуется, чтобы приложение проходило процесс проверки подлинности с помощью собственной службы и передавало данные по безопасному протоколу, например по HTTPS.
-   Необходимо, чтобы облачная служба всегда проверяла, что URI канала использует домен "notify.windows.com". Служба никогда не должна отправлять уведомления каналу, использующему любой другой домен. Если обратный вызов для вашего приложения будет скомпрометирован, злоумышленник может отправить URI канала, чтобы подделать WNS. Если ваша облачная служба не проверяет домен, существует вероятность того, что она может неумышленно разглашать сведения злоумышленнику.
-   Если ваша облачная служба делает попытки доставить уведомление каналу, у которого истек срок действия URI, WNS возвратит [код ответа 410](https://msdn.microsoft.com/library/windows/apps/hh465435.aspx#WNSResponseCodes). В ответ на этот код служба должна прекратить попытки отправлять уведомления этому URI.

## <a name="authenticating-your-cloud-service"></a>Проверка подлинности облачной службы


Чтобы уведомление было отправлено, облачная служба должна пройти проверку подлинности с помощью WNS. Первый шаг процесса состоит в регистрации вашего приложения в информационной панели Microsoft Store. Во время регистрации ваше приложение получает идентификатор безопасности пакета и секретный ключ. Эти сведения используются облачной службой для проверки подлинности с помощью WNS.

Схема проверки подлинности с помощью WNS реализуется с использованием профиля учетных данных клиента из протокола [OAuth 2.0](http://go.microsoft.com/fwlink/p/?linkid=226787). Облачная служба проходит проверку подлинности с помощью WNS, предоставляя свои учетные данные (идентификатор безопасности пакета и секретный ключ). Взамен она получает маркер доступа. Этот маркер доступа позволяет облачной службе отправить уведомление. Маркер необходим для каждого запроса на уведомление, отправляемого в WNS.

На высоком уровне существует следующая информационная цепочка.

1.  Облачная служба отправляет свои учетные данные в WNS по HTTPS согласно протоколу OAuth 2.0. Таким образом служба проходит проверку подлинности с помощью WNS.
2.  Если проверка подлинности пройдена успешно, WNS возвращает маркер доступа. Этот маркер доступа используется во всех последующих запросах на уведомления вплоть до истечения срока его действия.

![Схема WNS для проверки подлинности облачной службы](images/wns-diagram-02.png)

При проверке подлинности с помощью WNS облачная служба отправляет HTTP-запрос по протоколу SSL. Параметры предоставляются в формате "application/x-www-for-urlencoded". Укажите ваш идентификатор безопасности пакета в поле "client\_id" и секретный ключ в поле "client\_secret". Дополнительные сведения о синтаксисе см. в справочнике по [запросу маркера доступа](https://msdn.microsoft.com/library/windows/apps/hh465435.aspx#access_token_request).

**Примечание**это всего лишь пример, не и готовый код, который можно успешно использовать в собственном коде.

 

``` http
 POST /accesstoken.srf HTTP/1.1
 Content-Type: application/x-www-form-urlencoded
 Host: https://login.live.com
 Content-Length: 211
 
 grant_type=client_credentials&client_id=ms-app%3a%2f%2fS-1-15-2-2972962901-2322836549-3722629029-1345238579-3987825745-2155616079-650196962&client_secret=Vex8L9WOFZuj95euaLrvSH7XyoDhLJc7&scope=notify.windows.com
```

WNS проверяет подлинность облачной службы и, в случае успеха, отправляет ответ "200 OK". Маркер доступа возвращается в параметрах, включенных в текст ответа HTTP, с использованием типа содержимого "application/json". После того как ваша служба получит маркер доступа, вы сможете отправлять уведомления.

В следующем примере показан ответ успешной проверки подлинности, содержащий, в том числе, маркер доступа. Дополнительные сведения о синтаксисе см. в разделе [Заголовки запроса и ответа службы push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465435).

``` http
 HTTP/1.1 200 OK   
 Cache-Control: no-store
 Content-Length: 422
 Content-Type: application/json
 
 {
     "access_token":"EgAcAQMAAAAALYAAY/c+Huwi3Fv4Ck10UrKNmtxRO6Njk2MgA=", 
     "token_type":"bearer"
 }
```

### <a name="important-notes"></a>Важные примечания

-   Протокол OAuth 2.0, поддерживаемый в этой процедуре, следует версии проекта V16.
-   В документе RFC о протоколе OAuth под термином "клиент" подразумевается облачная служба.
-   В окончательном проекте протокола OAuth возможны изменения этой процедуры.
-   Маркер доступа можно повторно использовать для нескольких запросов на уведомления. Это позволяет облачной службе только один раз проходить проверку подлинности, чтобы отправлять множество уведомлений. Но, после того как срок действия маркера доступа истекает, облачная служба должна снова пройти проверку подлинности, чтобы получить новый маркер доступа.

## <a name="sending-a-notification"></a>Отправка уведомления


Используя URI канала, облачная служба может отправлять уведомление всякий раз, когда у нее есть обновление для пользователя.

Маркер доступа, описанный выше, может повторно использоваться для нескольких запросов на уведомления; облачной службе не нужно запрашивать новый маркер доступа для каждого уведомления. Если срок действия маркера доступа истек, при запросе уведомления будет возвращена ошибка. Мы рекомендуем не пытаться повторять отправку уведомления более одного раза, если маркер доступа был отклонен. При возникновении такой ошибки вам потребуется запросить новый маркер доступа и повторно отправить уведомление. Точный код ошибки см. в разделе [Коды ответов push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465435).

1.  Облачная служба выполняет запрос HTTP POST к URI канала. Запрос должен быть выполнен по протоколу SSL и содержать необходимые полезные данные уведомления и заголовки. Заголовок авторизации должен содержать маркер доступа для авторизации.

    Пример запроса показан ниже. Дополнительные сведения о синтаксисе см. в разделе [Коды ответов push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465435).

    Подробнее о составлении полезных данных уведомления см. в разделе [Краткое руководство: отправка push-уведомлений](https://msdn.microsoft.com/library/windows/apps/xaml/hh868252). Полезные данные плитки, всплывающего уведомления или push-уведомления индикатора событий поставляются в виде XML-содержимого, созданного в соответствии с определенными для него [схемой адаптивных плиток](adaptive-tiles-schema.md) или [схемой устаревших плиток](https://msdn.microsoft.com/library/windows/apps/br212853). Полезные данные необработанных уведомлений не имеют определенной структуры. Они определяются исключительно приложением.

    ``` http
     POST https://cloud.notify.windows.com/?token=AQE%bU%2fSjZOCvRjjpILow%3d%3d HTTP/1.1
     Content-Type: text/xml
     X-WNS-Type: wns/tile
     Authorization: Bearer EgAcAQMAAAAALYAAY/c+Huwi3Fv4Ck10UrKNmtxRO6Njk2MgA=
     Host: cloud.notify.windows.com
     Content-Length: 24

     <body>
     ....
    ```

2.  WNS отвечает, чтобы показать, что уведомление получено и будет доставлено при следующей возможности. Однако WNS не предоставляет сквозного подтверждения того, что ваше уведомление было получено устройством или приложением.

На этой схеме показан поток данных:

![Схема WNS для отправки уведомления](images/wns-diagram-03.png)

### <a name="important-notes"></a>Важные примечания

-   WNS не гарантирует надежности или задержки уведомления.
-   Уведомления никогда не должны содержать конфиденциальных данных.
-   Чтобы уведомление было отправлено, облачная служба должна сначала пройти проверку подлинности с помощью WNS и получить маркер доступа.
-   Маркер доступа позволяет облачной службе отправлять уведомления только в то приложение, для которого он был создан. Один маркер доступа нельзя использовать для отправки уведомлений нескольким приложениям. Следовательно, если ваша облачная служба поддерживает несколько приложений, она должна предоставлять правильный маркер доступа для приложения при отправке уведомления в каждый URI канала.
-   Если устройство не в сети, по умолчанию WNS хранит до пяти уведомлений плитки (если включена организация очереди; в противном случае — одно уведомление плитки) и одно уведомление на индикаторе событий для каждого URI канала, при этом необработанные уведомления не сохраняются. Такая установленная по умолчанию схема кэширования может быть изменена посредством [заголовка X-WNS-Cache-Policy](https://msdn.microsoft.com/library/windows/apps/hh465435.aspx#pncodes_x_wns_cache). Примечание. Всплывающие уведомления никогда не сохраняются, если устройство не в сети.
-   В сценариях, где содержимое уведомления персонализировано для пользователя, WNS рекомендует облачной службе отправлять эти обновления сразу после их получения. К примерам такого сценария относятся обновления веб-каналов социальных сетей, приглашения к обмену мгновенными сообщениями, уведомления о новых сообщениях или оповещения. Также возможны сценарии, в которых одно и то же общее обновление, например обновление прогноза погоды, котировок акций или новостей, часто доставляется большому подмножеству пользователей. В руководстве по WNS указано, что такие обновления не должны отправляться чаще одного раза каждые 30 минут. Пользователь или WNS может решить, что более частая отправка стандартных обновлений является злоупотреблением.

## <a name="expiration-of-tile-and-badge-notifications"></a>Истечение сроков действий уведомлений на плитках и индикаторах событий


По умолчанию срок действия уведомлений на индикаторах событий и плитках истекает через три дня с момента их загрузки. После истечения срока действия уведомления содержимое удаляется из плитки или очереди и больше не показывается пользователю. Рекомендуется установить срок действия для всех уведомлений на плитках и индикаторах событий (используя время, значимое для вашего приложения), чтобы гарантировать, что содержимое вашей плитки не будет сохраняться дольше, чем нужно. Явное указание срока действия важно для содержимого с определенной продолжительностью существования. Это также гарантирует удаление устаревшего содержимого, если облачная служба перестала отправлять уведомления или если пользователь отключился от сети на продолжительное время.

Ваша служба облачного хранилища может установить срок действия для каждого уведомления путем настройки заголовка X-WNS-TTL HTTP. Здесь указывается время (в секундах), в течение которого отправленное уведомление будет действовать. Подробнее см. [Запросы на обслуживание и заголовки ответа push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465435.aspx#pncodes_x_wns_ttl).

Например, во время торгового дня на бирже срок действия для обновлений курсов акций можно установить равным двойному интервалу отправки (допустим, через час после получения при отправке уведомлений, выполняемом каждые полчаса). Рассмотрим другой пример: для новостного приложения можно определить, что один день является подходящим временем для истечения срока действия обновлений плитки ежедневных новостей.

## <a name="push-notifications-and-battery-saver"></a>Push-уведомления и экономия заряда


Режим экономии заряда позволяет продлить срок службы батареи путем ограничения активности фоновых процессов в устройстве. Windows10 позволяет пользователю установить режим экономии заряда, включение, автоматически падения уровня заряда ниже установленного порогового значения. При включенном режиме экономии заряда функция приема push-уведомлений будет выключена с целью экономии ресурсов батареи. Но есть пара исключений. Следующие Windows10 параметры режима экономии заряда (в приложении « **Параметры** ») позволяют вашему приложению получать Push-уведомления даже в том случае, если режим экономии заряда включен.

-   **Разрешить push-уведомления из любого приложения в режиме экономии заряда**: этот параметр позволяет всем приложениям получать push-уведомления при включенном режиме экономии заряда. Обратите внимание, что этот параметр применим только к Windows10 для настольных компьютеров (Домашняя, Pro, Корпоративная и для образовательных учреждений).
-   **Всегда разрешено**: этот параметр позволяет определенным приложениям работать в фоновом режиме (в том числе принимать push-уведомления) при включенной экономии заряда. Этот список обслуживается вручную пользователем.

Невозможно проверить состояние этих двух параметров, но вы можете проверить состояние функции экономии заряда. В Windows10 используйте свойство [**EnergySaverStatus**](https://docs.microsoft.com/uwp/api/Windows.System.Power.PowerManager.EnergySaverStatus) для проверки состояния функции экономии заряда. Кроме того, ваше приложение может использовать событие [**EnergySaverStatusChanged**](https://docs.microsoft.com/uwp/api/Windows.System.Power.PowerManager.EnergySaverStatusChanged) для получения сведений об изменениях состояния функции экономии заряда.

Если работа приложения сильно зависит от push-уведомлений, мы рекомендуем уведомлять пользователей о том, что они могут не получать уведомления, если включен режим экономия заряда, и упростить им настройку **параметров экономии заряда**. С помощью схемы URI параметров режима экономии заряда в Windows10, `ms-settings:batterysaver-settings`, вы можете предоставить удобную ссылку на приложение "Параметры".

**Совет**  при уведомлении пользователя о параметрах экономии заряда, мы рекомендуем предоставить ему возможность не отображать это сообщение в будущем. Например, флажок `dontAskMeAgainBox` в примере ниже сохраняет выбор пользователя в свойстве [**LocalSettings**](https://docs.microsoft.com/uwp/api/Windows.Storage.ApplicationData.LocalSettings).

 

Вот пример того, как проверить, включен ли режим экономии заряда в Windows10. В этом примере приложение уведомляет пользователя, запускает приложение "Параметры" и открывает в нем раздел **параметров экономии заряда**. `dontAskAgainSetting` позволяет пользователю больше не отображать это сообщение.

```cs
using System;
using Windows.UI.Xaml;
using Windows.UI.Xaml.Controls;
using Windows.UI.Xaml.Navigation;
using Windows.System;
using Windows.System.Power;
...
...
async public void CheckForEnergySaving()
{
   //Get reminder preference from LocalSettings
   bool dontAskAgain;
   var localSettings = Windows.Storage.ApplicationData.Current.LocalSettings;
   object dontAskSetting = localSettings.Values["dontAskAgainSetting"];
   if (dontAskSetting == null)
   {  // Setting does not exist
      dontAskAgain = false;
   }
   else
   {  // Retrieve setting value
      dontAskAgain = Convert.ToBoolean(dontAskSetting);
   }
   
   // Check if battery saver is on and that it's okay to raise dialog
   if ((PowerManager.EnergySaverStatus == EnergySaverStatus.On)
         && (dontAskAgain == false))
   {
      // Check dialog results
      ContentDialogResult dialogResult = await saveEnergyDialog.ShowAsync();
      if (dialogResult == ContentDialogResult.Primary)
      {
         // Launch battery saver settings (settings are available only when a battery is present)
         await Launcher.LaunchUriAsync(new Uri("ms-settings:batterysaver-settings"));
      }

      // Save reminder preference
      if (dontAskAgainBox.IsChecked == true)
      {  // Don't raise dialog again
         localSettings.Values["dontAskAgainSetting"] = "true";
      }
   }
}
```

Этот код XAML для [**ContentDialog**](https://docs.microsoft.com/uwp/api/Windows.UI.Xaml.Controls.ContentDialog), который показан в данном примере.

```xaml
<ContentDialog x:Name="saveEnergyDialog"
               PrimaryButtonText="Open battery saver settings"
               SecondaryButtonText="Ignore"
               Title="Battery saver is on."> 
   <StackPanel>
      <TextBlock TextWrapping="WrapWholeWords">
         <LineBreak/><Run>Battery saver is on and you may 
          not receive push notifications.</Run><LineBreak/>
         <LineBreak/><Run>You can choose to allow this app to work normally
         while in battery saver, including receiving push notifications.</Run>
         <LineBreak/>
      </TextBlock>
      <CheckBox x:Name="dontAskAgainBox" Content="OK, got it."/>
   </StackPanel>
</ContentDialog>
```

## <a name="related-topics"></a>Статьи по теме


* [Отправка локального уведомления на плитке](sending-a-local-tile-notification.md)
* [Краткое руководство: отправка push-уведомлений](https://msdn.microsoft.com/library/windows/apps/xaml/hh868252)
* [Обновление индикатора событий с помощью push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465450)
* [Запрос, создание и сохранение канала уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465412)
* [Перехват уведомлений для выполняемых приложений ](https://msdn.microsoft.com/library/windows/apps/xaml/jj709907.aspx)
* [Проверка подлинности с помощью службы push-уведомлений Windows (WNS)](https://msdn.microsoft.com/library/windows/apps/hh465407)
* [Заголовки запроса и ответа службы push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh465435)
* [Руководство и контрольный список для push-уведомлений](https://msdn.microsoft.com/library/windows/apps/hh761462)
* [Необработанные уведомления](https://msdn.microsoft.com/library/windows/apps/hh761488)
 

 




