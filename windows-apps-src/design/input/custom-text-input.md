---
author: Karl-Bridge-Microsoft
Description: The core text APIs in the Windows.UI.Text.Core namespace enable a Universal Windows Platform (UWP) app to receive text input from any text service supported on Windows devices.
title: Обзор пользовательского ввода текста
ms.assetid: 58F5F7AC-6A4B-45FC-8C2A-942730FD7B74
label: Custom text input
template: detail.hbs
keywords: клавиатура, текст, основной текст, пользовательский текст, инфраструктура текстовых служб, ввод, взаимодействие с пользователем
ms.author: kbridge
ms.date: 02/08/2017
ms.topic: article
ms.localizationpriority: medium
ms.openlocfilehash: 14a2811f59b8de33db51b255aee8892abf553198
ms.sourcegitcommit: 3257416aebb5a7b1515e107866806f8bd57845a8
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/17/2018
ms.locfileid: "7168300"
---
# <a name="custom-text-input"></a>Ввод пользовательского текста



API-интерфейсы основного текста в пространстве имен [**Windows.UI.Text.Core**](https://msdn.microsoft.com/library/windows/apps/dn958238) активируют приложение универсальной платформы Windows (UWP) для получения ввода текста из любой текстовой службы, поддерживаемой устройствами с Windows. API очень похожи на API [инфраструктуры текстовых служб](https://msdn.microsoft.com/library/windows/desktop/ms629032) в этом приложении в том, что приложению не требуются подробные данные текстовых служб. Это позволяет приложению получать текст на любом языке и из любого типа ввода, например клавиатуры, речи или пера.

> **Важные API-интерфейсы**: [**Windows.UI.Text.Core**](https://msdn.microsoft.com/library/windows/apps/dn958238), [**CoreTextEditContext**](https://msdn.microsoft.com/library/windows/apps/dn958158)

## <a name="why-use-core-text-apis"></a>Зачем использовать API основного текста?


Для многих приложений элементов управления XAML или HTML достаточно для текстового ввода и редактирования. Однако, если ваше приложение обрабатывает сложные сценарии текста, например предназначено для обработки текстов, возможно, потребуется гибкость пользовательского элемента управления редактированием текста. Вы можете использовать API клавиатуры [**CoreWindow**](https://msdn.microsoft.com/library/windows/apps/br208225) для создания элемента управления редактированием текста, но они не предоставляют способ получить ввод текста на основе композиции, необходимый для поддержки восточноазиатских языков.

Вместо этого используйте API [**Windows.UI.Text.Core**](https://msdn.microsoft.com/library/windows/apps/dn958238), когда вам нужно создать пользовательский элемент управления редактированием текста. Эти API предназначены для предоставления вам достаточной гибкости в обработке ввода текста на любом языке и обеспечивают удобство работы с текстом соответственно вашему приложению. Ввод текста и элементы управления редактированием, созданные с помощью основных API текста, могут получать ввод текста от всех существующих методов ввода текста на устройствах с Windows: от редакторов метода ввода (IME) на основе [инфраструктуры текстовых служб](https://msdn.microsoft.com/library/windows/desktop/ms629032) и рукописного ввода на компьютерах до клавиатуры WordFlow (которая предоставляет автозамену, прогнозирование и диктовки) на мобильных устройствах.

## <a name="architecture"></a>Архитектура


Ниже приведено простое представление системы ввода текста.

-   "Приложение" — это приложение UWP, в котором размещен пользовательский элемент управления редактированием, созданный с помощью API основного текста.
-   API [**Windows.UI.Text.Core**](https://msdn.microsoft.com/library/windows/apps/dn958238) упрощают связь с текстовыми службами с помощью Windows. Связь между элементом управления редактированием текста и текстовыми службами обрабатывается главным образом объектом [**CoreTextEditContext**](https://msdn.microsoft.com/library/windows/apps/dn958158), который предоставляет методы и события для облегчения связи.

![схема архитектуры основного текста](images/coretext/architecture.png)

## <a name="text-ranges-and-selection"></a>Диапазоны текста и выделение


Элементы управления редактированием предоставляют место для ввода текста, и пользователи могут редактировать текст в любом месте в этом пространстве. Здесь мы описываем систему позиционирования текста, используемую API основного текста, а также диапазоны и выделения, представленные в этой системе.

### <a name="application-caret-position"></a>Положение курсора приложения

Диапазоны текста, используемые с API основного текста, выражаются положениями курсора. "Положение курсора приложения (ACP)" — это число на основе нуля, указывающее количество символов от начала потока текста непосредственно перед курсором, как показано здесь.

![пример схемы потока текста](images/coretext/stream-1.png)
### <a name="text-ranges-and-selection"></a>Диапазоны текста и выделение

Диапазоны и выделения текста представлены структурой [**CoreTextRange**](https://msdn.microsoft.com/library/windows/apps/dn958201), содержащей два поля:

| Поле                  | Тип данных                                                                 | Описание                                                                      |
|------------------------|---------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| **StartCaretPosition** | **Number** \[JavaScript\] | **System.Int32** \[.NET\] | **int32** \[C++\] | Начальное положение диапазона — это ACP непосредственно перед первым символом. |
| **EndCaretPosition**   | **Number** \[JavaScript\] | **System.Int32** \[.NET\] | **int32** \[C++\] | Конечное положение диапазона — это ACP непосредственно после последнего символа.     |

 

Например, в диапазоне текста, показанном ранее, диапазон \[0, 5\] обозначает слово Hello. Значение **StartCaretPosition** должно быть меньше или равно **EndCaretPosition**. Диапазон \[5, 0\] является недопустимым.

### <a name="insertion-point"></a>Точка вставки

Текущее положение курсора, часто называемое точкой вставки, представлено установкой **StartCaretPosition**, равного **EndCaretPosition**.

### <a name="noncontiguous-selection"></a>Несвязанное выделение

Некоторые элементы управления редактированием поддерживают несвязанное выделение. Например, приложения Microsoft Office поддерживают несколько произвольных выделений, и многие редакторы исходного кода поддерживают выделение столбца. Однако API основного текста не поддерживают несвязанное выделение. Элементы управления редактированием должны сообщать только об одном связанном выделении. Чаще всего это активный поддиапазон несвязанных выделений.

Например, рассмотрим этот поток текста.

![пример схемы потока текста](images/coretext/stream-2.png) Есть два выделения: \[0, 1\] and \[6, 11\]. Элемент управления редактированием должен сообщать только об одном из них: \[0, 1\] или \[6, 11\].

## <a name="working-with-text"></a>Работа с текстом


Класс [**CoreTextEditContext**](https://msdn.microsoft.com/library/windows/apps/dn958158) обеспечивает поток текста между Windows и элементами управления редактированием с помощью события [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176), события [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175) и метода [**NotifyTextChanged**](https://msdn.microsoft.com/library/windows/apps/dn958172).

Элемент управления редактированием получает текст с помощью событий [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176), которые создаются, когда пользователи взаимодействуют с методами ввода текста с клавиатуры, речевым вводом или IME.

При изменении текста в вашем элементе управления редактированием, например путем вставки текста в элемент управления, необходимо уведомить Windows, вызвав [**NotifyTextChanged**](https://msdn.microsoft.com/library/windows/apps/dn958172).

Если текстовая служба запрашивает новый текст, вызывается событие [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175). Необходимо предоставить новый текст в обработчике событий **TextRequested**.

### <a name="accepting-text-updates"></a>Принятие обновлений текста

Элемент управления редактированием обычно должен принимать запросы на обновление текста, так как они представляют собой текст, который хочет ввести пользователь. В обработчике событий [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176) эти действия ожидаются от элемента управления редактированием:

1.  Вставьте текст, определенный в [**CoreTextTextUpdatingEventArgs.Text**](https://msdn.microsoft.com/library/windows/apps/dn958236), в положение, указанное в [**CoreTextTextUpdatingEventArgs.Range**](https://msdn.microsoft.com/library/windows/apps/dn958234).
2.  Установите выделение в положении, указанном в [**CoreTextTextUpdatingEventArgs.NewSelection**](https://msdn.microsoft.com/library/windows/apps/dn958233).
3.  Уведомите систему об успешном обновлении, установив для параметра [**CoreTextTextUpdatingEventArgs.Result**](https://msdn.microsoft.com/library/windows/apps/dn958235) значение [**CoreTextTextUpdatingResult.Succeeded**](https://msdn.microsoft.com/library/windows/apps/dn958237).

Например, это состояние элемента управления редактированием до того, как пользователь ввел "d". Точка вставки находится в \[10, 10\].

![пример схемы потока текста](images/coretext/stream-3.png) Когда пользователь вводит "d", вызывается событие [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176) со следующими данными [**CoreTextTextUpdatingEventArgs**](https://msdn.microsoft.com/library/windows/apps/dn958229):

-   [**Range**](https://msdn.microsoft.com/library/windows/apps/dn958234) = \[10, 10\]
-   [**Text**](https://msdn.microsoft.com/library/windows/apps/dn958236) = "d"
-   [**NewSelection**](https://msdn.microsoft.com/library/windows/apps/dn958233) = \[11, 11\]

В вашем элементе управления редактированием примените указанные изменения и установите для параметра [**Result**](https://msdn.microsoft.com/library/windows/apps/dn958235) значение **Succeeded**. Далее описано состояние элемента управления после применения изменений.

![пример схемы потока текста](images/coretext/stream-4.png)
### <a name="rejecting-text-updates"></a>Отклонение обновлений текста

Иногда вы не можете применить обновления текста, так как запрошенный диапазон находится в области элемента управления редактированием, которую не следует изменять. В этом случае вам не нужно применять изменения. Вместо этого уведомите систему о невозможности обновления, установив для параметра [**CoreTextTextUpdatingEventArgs.Result**](https://msdn.microsoft.com/library/windows/apps/dn958235) значение [**CoreTextTextUpdatingResult.Failed**](https://msdn.microsoft.com/library/windows/apps/dn958237).

Например, рассмотрим элемент управления редактированием, который принимает только адрес электронной почты. Пробелы должны быть отклонены, так как адреса электронной почты не могут содержать пробелов. Поэтому, когда вызываются события [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176) для клавиши ПРОБЕЛ, необходимо просто установить для параметра [**Result**](https://msdn.microsoft.com/library/windows/apps/dn958235) значение **Failed** в элементе управления редактированием.

### <a name="notifying-text-changes"></a>Уведомление об изменениях текста

Иногда элемент управления редактированием вносит изменения в текст, например при вставке текста или автоматических исправлениях. В таких случаях вы должны уведомить текстовые службы об этих изменениях, вызвав метод [**NotifyTextChanged**](https://msdn.microsoft.com/library/windows/apps/dn958172).

Например, это состояние элемента управления редактированием до вставки пользователем слова World. Точка вставки находится в \[6, 6\].

![пример схемы потока текста](images/coretext/stream-5.png) Пользователь выполняет действие вставки, и элемент управления редактированием отображает следующий текст:

![пример схемы потока текста](images/coretext/stream-4.png) В этом случае необходимо вызвать [**NotifyTextChanged**](https://msdn.microsoft.com/library/windows/apps/dn958172) с такими аргументами:

-   *modifiedRange* = \[6, 6\]
-   *newLength* = 5
-   *newSelection* = \[11, 11\]

Последует одно или несколько событий [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175), которые вы обрабатываете для обновления текста, находящегося в ведении текстовых служб.

### <a name="overriding-text-updates"></a>Переопределение обновлений текста

В вашем элементе управления редактированием, возможно, вам придется переопределить обновление текста для предоставления функций автозамены.

Например, рассмотрим элемент управления редактированием, который предоставляет функцию исправления, оформляющую сужения. Это состояние элемента управления редактированием до того, как пользователь нажал клавишу ПРОБЕЛ для активации исправления. Точка вставки находится в \[3, 3\].

![пример схемы потока текста](images/coretext/stream-6.png) Пользователь нажимает клавишу ПРОБЕЛ и вызывает соответствующее событие [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176). Элемент управления редактированием принимает обновление текста. Это состояние элемента управления редактированием в течение короткого момента перед завершением исправления. Точка вставки находится в \[4, 4\].

![пример схемы потока текста](images/coretext/stream-7.png) Вне обработчика событий [**TextUpdating**](https://msdn.microsoft.com/library/windows/apps/dn958176) элемент управления редактированием делает следующее исправление. Это состояние элемента управления редактированием после завершения исправления. Точка вставки находится в \[5, 5\].

![пример схемы потока текста](images/coretext/stream-8.png) В этом случае необходимо вызвать [**NotifyTextChanged**](https://msdn.microsoft.com/library/windows/apps/dn958172) с такими аргументами:

-   *modifiedRange* = \[1, 2\]
-   *newLength* = 2
-   *newSelection* = \[5, 5\]

Последует одно или несколько событий [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175), которые вы обрабатываете для обновления текста, находящегося в ведении текстовых служб.

### <a name="providing-requested-text"></a>Предоставление запрашиваемого текста

Важно, чтобы текстовые службы имели правильный текст для предоставления таких функций, как автозамена или прогнозирование, особенно для текста, который уже существовал в элементе управления редактированием, например с загрузки документа, или текста, который вставлен элементом управления редактированием, как описано в предыдущих разделах. Поэтому, когда возникает событие [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175), необходимо предоставить текст, который в настоящее время находится в вашем элементе управления редактированием для определенного диапазона.

Иногда [**Range**](https://msdn.microsoft.com/library/windows/apps/dn958227) в [**CoreTextTextRequest**](https://msdn.microsoft.com/library/windows/apps/dn958221) определяет диапазон, который ваш элемент управления редактированием не может вставить "как есть". Например, **Range** больше, чем размер элемента управления редактированием в момент события [**TextRequested**](https://msdn.microsoft.com/library/windows/apps/dn958175), или конец **Range** выходит за рамки. В таких случаях вы должны вернуть любой разумный диапазон. Обычно это подмножество запрашиваемого диапазона.

## <a name="related-articles"></a>Связанные разделы

**Примеры**
* [Пример пользовательского элемента управления для редактирования](https://go.microsoft.com/fwlink/?linkid=831024) 
 **Примеры из архива**
* [Пример редактирования текста XAML](http://go.microsoft.com/fwlink/p/?LinkID=251417)


