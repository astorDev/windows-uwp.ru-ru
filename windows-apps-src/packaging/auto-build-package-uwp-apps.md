---
author: rmpablos
title: "Настройка автоматических сборок для приложения UWP"
description: "Узнайте, как настроить автоматические сборки для создания неопубликованных пакетов и пакетов для Магазина."
translationtype: Human Translation
ms.sourcegitcommit: 1e30c20b38b9e6b00cd4f56bf9ffb3752ceed6a9
ms.openlocfilehash: 681019d708b859d117992cde6d2ad3d37fa4833a

---
# Настройка автоматических сборок для приложения UWP

Вы можете использовать службы Visual Studio Team Services (VSTS), чтобы создавать автоматические сборки для проектов UWP. В этой статье мы рассмотрим различные способы для этого.  Мы также покажем, как выполнить эти задачи с помощью командной строки, чтобы взаимодействовать с другими системами сборки, например AppVeyor. 

## Выбор нужного типа агента построения

Выберите нужный тип агента построения, который службы VSTS будут использовать в процессе сборки. Размещенный агент сборки развертывается с наиболее распространенными средствами и пакетами SDK, он работает в большинстве сценариев. Подробнее: [Программное обеспечение на размещенном сервере сборки](https://www.visualstudio.com/en-us/docs/build/admin/agents/hosted-pool#software). Тем не менее если вам требуется больше контроля над сборкой, вы можете создать пользовательский агент сборки. Воспользуйтесь следующей таблицей, чтобы принять решение.

|**Сценарий**|**Пользовательский агент**|**Размещенный агент сборки**|
-------------|----------------|----------------------|
|Базовая сборка UWP (включая .NET Native)|:white_check_mark:|:white_check_mark:|
|Создание пакетов для загрузки неопубликованных приложений|:white_check_mark:|:white_check_mark:|
|Создание пакетов для отправки в Магазин|:white_check_mark:|:white_check_mark:|
|Использование пользовательских сертификатов|:white_check_mark:||
|Сборка, предназначенная для пользовательского пакета Windows SDK|:white_check_mark:||
|Выполнение модульных тестов|:white_check_mark:||
|Использование инкрементных сборок|:white_check_mark:||

>Примечание. Если вы создаете решение для пакета SDK юбилейного обновления Windows (сборка 14393), вам необходимо настроить пользовательский агент сборки, поскольку пул размещенных сборок поддерживает только SDK 10240 и 10586. Дополнительные сведения о [выборе версии UWP](https://msdn.microsoft.com/en-us/windows/uwp/updates-and-versions/choose-a-uwp-version)

#### Создание пользовательского агента (необязательно)

Если вы решили создать пользовательский агент, вам понадобятся средства универсальной платформы Windows. Они входят в состав Visual Studio. Вы можете использовать выпуск Visual Studio Community Edition.

Дополнительные сведения см. в разделе [Развертывание агента в Windows.](https://www.visualstudio.com/en-us/docs/build/admin/agents/v2-windows) 

Для выполнения модульных тестов UWP необходимо следующее: • развернуть и запустить приложение; •   запустить агент VSTS в интерактивном режиме; •   настроить агент для автоматического входа после перезагрузки.

Теперь мы поговорим о том, как настроить автоматическую сборку.

## Настройка автоматической сборки
Начнем с определения сборки UWP по умолчанию, которое доступно в VSTS, и затем покажем, как настроить его, чтобы выполнять более сложные задачи сборки.

**Добавление сертификата проекта в репозиторий исходного кода**

VSTS работает с репозиториями на основе TFS и GIT.  
Если вы используете репозиторий Git, добавьте файл сертификата проект в него, чтобы агент сборки мог подписать APPX-пакет. Если этого не сделать, репозиторий Git будет игнорировать файл сертификата. Чтобы добавить файл сертификата в репозиторий, щелкните правой кнопкой мыши файл сертификата в обозревателе решений и в контекстном меню выберите команду "Добавить игнорируемый файл систему управления версиями". 

![как добавить сертификат](images/building-screen1.png)

Мы обсудим [расширенное управление сертификатами](#certificates-best-practices) далее в этом руководстве. 

Чтобы создать первое определение сборки в VSTS, перейдите на вкладку "Сборки" и нажмите кнопку "+".

![создание определения сборки](images/building-screen2.png)

В списке шаблонов определений сборки выберите шаблон *Универсальная платформа Windows*.

![выбор сборки uwp](images/building-screen3.png)

Это определение сборки содержит следующие задачи:

- восстановление NuGet ** \*.sln;
- построение решения ** \*.sln;
- публикация символов;
- публикация артефакта: drop.

#### Настройка задачи построения восстановления NuGet

Эта задача восстанавливает пакеты NuGet, определенные в проекте. Для установки некоторых пакетов требуется специальная версия NuGet.exe. Если вы используете такой пакет обратитесь к этой версии NuGet.exe в вашем репозитория и укажите ссылку на него в дополнительном свойстве *Путь к NuGet.exe*.

![определение сборки по умолчанию](images/building-screen4.png)

#### Настройка задачи построения "Сборка решения"

Эта задача компилирует любое решение в рабочей папки, создает двоичные файлы и выходной APPX-файл. Эта задача использует аргументы MSbuild.  Вам необходимо указать значение этих аргументов. Руководствуйтесь следующей таблицей. 

|**Аргумент MSBuild**|**Значение**|**Описание**|
|--------------------|---------|---------------|
|AppxPackageDir|$(Build.ArtifactStagingDirectory)\AppxPackages|Определяет папку для хранения созданных артефактов.|
|AppxBundlePlatforms|$(Build.BuildPlatform)|Позволяет указать платформы, в которые будет включен пакет.|
|AppxBundle|Always|Создает пакет appxbundle с APPX-файлами для указанной платформы.|
|**UapAppxPackageBuildMode**|StoreUpload|Определяет тип создаваемого APPX-пакета. (По умолчанию не включено)|


Если вы хотите выполнить сборку решения с помощью командной строки или другой системы сборки, запустите msbuild с этими аргументами.

```
/p:AppxPackageDir="$(Build.ArtifactStagingDirectory)\AppxPackages\\"  
/p:UapAppxPackageBuildMode=StoreUpload 
/p:AppxBundlePlatforms="$(Build.BuildPlatform)"
/p:AppxBundle=Always
```

Параметры, определенные с помощью синтаксиса $() — это переменные, заданные в определении сборки, которые меняются в других системах сборки.

![переменные по умолчанию](images/building-screen5.png)

Все стандартные переменные см. в разделе [Использование переменных сборки.](https://www.visualstudio.com/docs/build/define/variables)

#### Настройка задачи построения "Публикация артефакта" 
Эта задача сохраняет созданные артефакты в VSTS. Их можно увидеть на вкладке "Артефакты" на странице результатов сборки. VSTS использует папку `$Build.ArtifactStagingDirectory)\AppxPackages`, которую мы указали ранее.

![артефакты](images/building-screen6.png)

Так как мы присвоили свойству `UapAppxPackageBuildMode` значение `StoreUpload`, папка артефактов содержит пакет, который можно отправить в Магазин (appxupload), а также пакеты для загрузки неопубликованных приложений (appxbundle).


>Примечание. По умолчанию агент VSTS поддерживает последние созданные APPX-пакеты. Если вы хотите сохранить только артефакты текущей сборки, включите очистку каталога двоичных файлов. Для этого добавьте переменную `Build.Clean` и задайте для нее значение `all`. Дополнительные сведения см. в разделе [Указание репозитория.](https://www.visualstudio.com/en-us/docs/build/define/repository#how-can-i-clean-the-repository-in-a-different-way)

#### Типы автоматических сборок
Затем вы используете определение сборки, чтобы создать автоматическую сборку. В следующей таблице описаны все типы автоматических сборок, которые вы можете создать. 

|**Тип сборки**|**Артефакт**|**Рекомендуемая частота**|**Описание**|
|-----------------|------------|-------------------------|---------------|
|Непрерывная интеграция|Журнал сборки, результаты тестов|Каждая фиксация|Этот тип сборки выполняется быстро и несколько раз в день.|
|Сборка непрерывного развертывания для загрузки неопубликованных приложений|Пакеты развертывания|Ежедневно |Этот тип сборки может содержать модульные тесты, но процесс занимает больше времени. Он позволяет проводить ручное тестирование, и его можно интегрировать с другими средствами, такими как HockeyApp.|
|Сборка непрерывного развертывания, которая отправляет пакет в Магазин|Публикация пакетов|По требованию|Этот тип сборки создает пакет, который можно опубликовать в Магазине.|

Рассмотрим способ настройки каждого из них.


## Настройка сборки непрерывной интеграции (CI) 
Этот тип сборки помогает быстро выявить проблемы, связанные с кодом. Обычно они выполняются только для одной платформу и не должны обрабатываться цепочкой инструментов .NET Native. Кроме того, в сборках целостности CI можно проводить модульные тесты, которые создают отчет с результатами тестирования.  

Если вы хотите использовать модульные тесты UWP в рамках сборки CI, необходимо использовать пользовательский агент вместо размещенного агента сборки.

>Примечание. Если в одном пакете решения объединены несколько приложений, может возникнуть ошибка. Сведения об устранении этой ошибки см. в разделе [Устранение ошибок, которые возникают при объединении нескольких приложений в одном решении.](#bundle-errors) 


### Настройка определения сборки CI
Используйте шаблон UWP по умолчанию, чтобы создать определение сборки. Затем настройте триггер для выполнения при каждом возврате.  

![триггер ci](images/building-screen7.png)

Поскольку сборка CI не развертывается для пользователей, рекомендуется применять разные номера версий во избежание путаницы со сборками непрерывного развертывания (CD). Например: `$(BuildDefinitionName)_0.0.$(DayOfYear)$(Rev:.r)`.


#### Настройка пользовательского агента для модульного тестирования

1. Сначала включите режим разработчика на компьютере. См. раздел "Подготовка устройства к разработке". 2. Включите службу для запуска в качестве интерактивного процесса. См. раздел "Развертывание агента в Windows". 3. Разверните сертификат подписи в агенте.

Для этого дважды щелкните CER-файл, выберите локальный компьютер, а затем — хранилище "Доверенные лица".

<span id="uwp-unit-tests" />
### Настройка определения сборки для выполнения модульных тестов UWP
Чтобы выполнить модульный тест, используйте этап тестовой сборки Visual Studio.


![добавление модульных тестов](images/building-screen8.png)

Модульные тесты UWP выполняются в контексте данного APPX-файла, поэтому использовать созданный пакет невозможно. Кроме того, вам необходимо указать путь к APPX-файлу для конкретной платформы. Например:

```
$(Build.ArtifactStagingDirectory)\AppxPackages\MyUWPApp.UnitTest\x86\MyUWPApp.UnitTest_$(AppxVersion)_x86.appx
```

>Примечание. Используйте следующую команду для выполнения модульных тестов локально из командной строки:
`"%ProgramFiles(x86)%\Microsoft Visual Studio 14.0\Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe"`

#### Просмотр результатов тестирования
В VSTS на странице сводки сборки отображаются результаты тестирования каждой сборки, которая выполняет модульные тесты.  Здесь можно открыть страницу результатов тестирования, чтобы просмотреть подробные сведения о результатах. 

![результаты тестирования](images/building-screen9.png)

#### Ускорение сборки CI
Если вы хотите использовать сборку CI только для наблюдения за качеством возвратов, вы можете сократить время сборки.

#### Ускорение сборки CI
1.  Выполняйте сборку только для одной платформы.
2.  Измените переменную BuildPlatform, чтобы использовать только архитектуру x86. ![настройка ci](images/building-screen10.png) 
3.  На этапе сборки добавьте /p:AppxBundle=Never в свойство "Аргументы MSBuild", а затем задать значение свойства "Платформа". ![настройка платформы](images/building-screen11.png)
4.  В проекте модульных тестов отключите .NET Native. 

Для этого откройте файл проекта и в свойствах установите для свойства `UseDotNetNativeToolchain` значение `false`.

>Примечание. Использование цепочки инструментов .NET Native — по-прежнему важная часть рабочего процесса, поэтому вам следует применять ее для проверки готовых сборок. 

<span id="bundle-errors" />
#### Устранение ошибок, которые возникают при объединении нескольких приложений в одном решении 
Если добавить в решение несколько проектов UWP и попробовать создать пакет, может возникнуть следующая ошибка: 

```
MakeAppx(0,0): Error : Error info: error 80080204: The package with file name "AppOne.UnitTests_0.1.2595.0_x86.appx" and package full name "8ef641d1-4557-4e33-957f-6895b122f1e6_0.1.2595.0_x86__scrj5wvaadcy6" is not valid in the bundle because it has a different package family name than other packages in the bundle
```

Эта ошибка возникает, поскольку на уровне решения неясно, какое приложение должно быть в пакете. Чтобы решить эту проблему, откройте каждый файл проекта и добавьте следующие свойства в конец первого элемента `<PropertyGroup>`:

|**Проект**|**Свойства**|
|-------|----------|
|App|`<AppxBundle>Always</AppxBundle>`|
|UnitTests|`<AppxBundle>Never</AppxBundle>`|

Затем удалите аргумент msbuild `AppxBundle` с этапа сборки.

## Настройка сборки непрерывного развертывания для загрузки неопубликованных приложений
После завершении этого типа сборки пользователи смогут скачать APPXBUNDLE-файл из раздела артефактов на странице результатов сборки. Если вы хотите провести бета-тестирование приложения, создав более полный распространяемый пакет, используйте службу HockeyApp. Она предоставляет расширенные возможности для бета-тестирования, анализа пользователей и диагностики сбоев.


### Применение номеров версий к сборкам

Файл манифеста содержит номер версии приложения.  Обновите файл манифеста в репозитории системы управления версиями, чтобы изменить номер версии. Другой способ обновить номер версии приложения — использовать номер сборки, созданный VSTS, а затем изменить манифест приложения непосредственно перед его компиляцией. Только не примените эти изменения в репозитории с исходным кодом.

Вам необходимо определить формат номера сборки в определении сборки, а затем использовать полученный номер версии для обновления AppxManifest и, при необходимости, файла AssemblyInfo.cs перед компиляцией.

Определите формат номера сборки на вкладке *Общие* определения сборки:

![версия сборки](images/building-screen12.png) 

Например, если задать формат номера сборки следующим образом:  
``` 
$(BuildDefinitionName)_1.1.$(DayOfYear)$(Rev:r).0 
```

VSTS создает такой номер версии:
```
CI_MyUWPApp_1.1.2501.0
```

>Примечание. Магазин требует, чтобы последним числом в версии был 0.

Чтобы вы могли извлечь номер версии и применить его в манифесте или файлах `AssemblyInfo`, используйте пользовательский сценарий PowerShell (он доступен [здесь](https://go.microsoft.com/fwlink/?prd=12560&pver=14&plcid=0x409&clcid=0x9&ar=DevCenter&sar=docs)). Сценарий считывает номер версии из переменной среды `BUILD_BUILDNUMBER` и изменяет файлы AssemblyInfo и AppxManifest. Не забудьте добавить этот сценарий в репозиторий исходного кода, а затем настройте задачу построения PowerShell, как показано здесь:


![обновление версии](images/building-screen13.png) 

Переменная `$(AppxVersion)` содержит номер версии. Вы можете использовать этот номер на других этапах сборки. 


#### Необязательно: интеграция с HockeyApp
Сначала установите расширение [HockeyApp](https://marketplace.visualstudio.com/items?itemName=ms.hockeyapp) для Visual Studio. 

>Примечание. Его необходимо установить от лица администратора VSTS. 


![hockey app](images/building-screen14.png) 

Далее настройте подключение HockeyApp с помощью этого руководства: [Использование HockeyApp со службами Visual Studio Team Services (VSTS) или Team Foundation Server (TFS).](https://support.hockeyapp.net/kb/third-party-bug-trackers-services-and-webhooks/how-to-use-hockeyapp-with-visual-studio-team-services-vsts-or-team-foundation-server-tfs) Для настройки учетной записи HockeyApp вы можете воспользоваться учетной записью Майкрософт, учетной записью социальных сетей или электронным адресом. Бесплатный тарифный план предоставляет два приложения и одного владельца без ограничения данных.

Затем вы можете создать приложение HockeyApp вручную или загрузить существующий файл APPX-пакета. Дополнительные сведения см. в разделе [Создание приложения.](https://support.hockeyapp.net/kb/app-management-2/how-to-create-a-new-app)  

Чтобы использовать существующий файл APPX-пакета, добавьте этап сборки и настройте "Путь к двоичному файлу" этого этапа. 

![настройка hockey app](images/building-screen15.png) 

Чтобы задать этот параметр, объедините имя приложения, переменную AppxVersion и поддерживаемые платформы в одной строке, например следующим образом:

``` 
$(Build.ArtifactStagingDirectory)\AppxPackages\MyUWPApp_$(AppxVersion)_Test\MyUWPApp_$(AppxVersion)_x86_x64_ARM.appxbundle
```

>Примечание. Хотя задача HockeyApp позволяет указать путь к файлу символов, рекомендуется включать символы (APPXSYM-файлы) в пакет.

Мы поможем вам установить и запустить неопубликованный пакет [далее](#sideloading-best-practices) в этом руководстве. 

## Настройка сборки непрерывного развертывания, которая отправляет пакет в Магазин 

Чтобы создать пакеты для отправки в Магазин, свяжите ваше приложение с Магазином с помощью мастера связывания с Магазином в Visual Studio.

![связывание с Магазином](images/building-screen16.png) 

>Примечание. Этот мастер создает файл Package.StoreAssociation.xml, содержащий сведения о связывании с Магазином. Если вы храните исходный код в общедоступном репозитории, например в GitHub, этот файл будет содержать все зарезервированные для этой учетной записи имена приложений. Вы можете исключить или удалить этот файл, прежде чем сделать его общедоступным.

Если у вас нет доступа к учетной записи Центра разработки, которая использовалась для публикации приложения, следуйте инструкциям в этом документе: [Создаете приложение для стороннего поставщика? Как создавать пакеты для стороннего магазина приложений.](https://blogs.windows.com/buildingapps/2015/12/15/building-an-app-for-a-3rd-party-how-to-package-their-store-app/#e35YzR5aRG6uaBqK.97) 

Затем вам необходимо убедиться, что в этап сборки включен следующий параметр:

```
/p:UapAppxPackageBuildMode=StoreUpload 
```

Он создает APPXUPLOAD-файл, который можно отправить в Магазин.


#### Настройка автоматической отправки в Магазин

Используйте расширение Visual Studio Team Services для Магазина Windows для интеграции API Магазина и отправьте APPXUPLOAD-пакет в Магазин.

Вам необходимо связать учетную запись Центра разработки с Azure Active Directory (AD), а затем создать приложение в AD для проверки подлинности запросов. Для этого следуйте рекомендациям на странице расширения. 

После настройки расширения можно добавить задачу построения и настроить ее, указав идентификатор приложения и расположение APPXUPLOAD-файла.

![настройка Центра разработки](images/building-screen17.png) 

Значением параметра `Package File` будет:

```
$(Build.ArtifactStagingDirectory)\
AppxPackages\MyUWPApp__$(AppxVersion)_x86_x64_ARM_bundle.appxupload
```

>Примечание. Необходимо вручную активировать эту сборку. Ее можно использовать для обновления существующих приложений, но не для первой отправки в Магазин. Дополнительные сведения см. в разделе [Создание отправок и управление ими с помощью служб Магазина Windows](https://msdn.microsoft.com/windows/uwp/monetize/create-and-manage-submissions-using-windows-store-services).

## Рекомендации

<span id="sideloading-best-practices"/>
### Рекомендации для загрузки неопубликованных приложений

Если вы хотите распространять приложение без публикация в магазине, вы можете отправлять его непосредственно на устройства, если они доверяют сертификату, который использовался для подписи пакета приложения. 

Используйте сценарий PowerShell `Add-AppDevPackage.ps1` для установки приложений. Этот сценарий добавляет сертификат в разделе доверенного корневого центра сертификации локального компьютера и устанавливает или обновляет APPX-файл.

#### Загрузка неопубликованного приложения в юбилейном обновлении Windows 10
В юбилейном обновлении Windows 10 вы можете дважды щелкните APPXBUNDLE-файл и установить приложение, нажав кнопку "Установить" в диалоговом окне. 


![загрузка неопубликованных приложений в rs1](images/building-screen18.png) 

>Примечание. Этот метод не устанавливает сертификат или связанные зависимости.

Если вы хотите распространять APPX-пакеты с веб-сайта, например VSTS или HockeyApp, необходимо добавить этот сайт в список доверенных сайтов в браузере. В противном случае Windows отметит файл как заблокированный. 

<span id="certificates-best-practices"/>
### Рекомендации для подписи сертификатов 
Visual Studio создает сертификат для каждого проекта. Это затрудняет поддержку контролируемого списка действительных сертификатов. Если вы собираетесь создать несколько приложений, можно использовать один сертификат для подписи всех приложений. Каждое устройство, которое доверяет вашему сертификату, сможет загружать неопубликованные приложения без установки другого сертификата. Дополнительные сведения см. в разделе [Создание сертификата подписи пакета приложения.](https://msdn.microsoft.com/en-us/library/windows/desktop/jj835832(v=vs.85).aspx)


#### Создание сертификата подписи
Используйте средство [MakeCert.exe](https://msdn.microsoft.com/en-us/library/windows/desktop/ff548309(%09v=vs.85).aspx) для создания сертификата. В следующем примере сертификат создается с помощью средства MakeCert.exe.

```
MakeCert /n publisherName /r /h 0 /eku "1.3.6.1.5.5.7.3.3,1.3.6.1.4.1.311.10.3.13" /e expirationDate /sv MyKey.pvk MyKey.cer
```

Затем вы можете использовать средство Pvk2Pfx для создания PFX-файла, который содержит закрытый ключ, защищенный паролем.

Предоставьте эти сертификаты каждой роли компьютера:

|**Компьютер**|**Использование**|**Сертификат**|**Хранилище сертификатов**|
|-----------|---------|---------------|---------------------|
|Компьютер разработчика или построения|Подпись сборок|MyCert.PFX|Хранилище текущего пользователя или личное хранилище|
|Компьютер разработчика или построения|Выполнение|MyCert.cer|Локальный компьютер/доверенные лица|
|Пользователь|Выполнение|MyCert.cer|Локальный компьютер/доверенные лица|

>Примечание. Вы также можете использовать корпоративный сертификат, которому пользователи уже доверяют.

#### Подпись приложения UWP
В Visual Studio и MSBuild предлагаются различные параметры для управления сертификатом, который используется для подписи приложения.

Можно добавить в ваше решение сертификат с закрытым ключом (обычно в форме PFX-файла), а затем указать на него ссылку в файле проекта. Вы можете управлять этими настройками на вкладке "Пакет" редактора манифестов.


![создание сертификата](images/building-screen19.png) 

Другой вариант — установить сертификат на компьютере сборки (хранилище текущего пользователя или личное хранилище), а затем использовать параметр "Выбор в хранилище сертификатов". При этом будет указан отпечаток сертификата в файле проекта, чтобы сертификат был установлен на все компьютеры, которые будут использоваться для сборки проекта.

#### Доверие сертификату подписи на целевых устройствах
Целевое устройство должно доверять сертификату, чтобы на нем можно было установить приложение. 

Зарегистрируйте открытый ключ сертификата в расположении "Доверенные лица" или "Корень доверия" в хранилище сертификатов локального компьютера.

Самый простой способ зарегистрировать сертификат — дважды щелкнуть CER-файл и следовать инструкциям мастера, чтобы сохранить сертификата в хранилище локального компьютера и в хранилище "Доверенные лица".

## Статьи по теме
* [Сборка приложения .NET для Windows](https://www.visualstudio.com/en-us/docs/build/get-started/dot-net) 
* [Формирование пакетов приложений UWP](https://msdn.microsoft.com/windows/uwp/packaging/packaging-uwp-apps)
* [Загрузка неопубликованных бизнес-приложений в Windows 10](https://technet.microsoft.com/itpro/windows/deploy/sideload-apps-in-windows-10)
* [Создание сертификата подписи для пакета приложения](https://msdn.microsoft.com/en-us/library/windows/desktop/jj835832(v=vs.85).aspx)



<!--HONumber=Nov16_HO1-->


